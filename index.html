<head><style>body{background:#000000bf!important;color:#f5f5f7!important}</style><script type="module">var t={n:e=>{var a=e&&e.__esModule?()=>e.default:()=>e;return t.d(a,{a}),a},d:(e,a)=>{for(var n in a)t.o(a,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:a[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};class e{dataManager;uiController;bindingMap=new Map;mvuUpdateCallback;prevSnapshot={favor:{},currency:{lira:0,platinum:0}};constructor(t,e){this.dataManager=t,this.uiController=e}initialize(){this.setupDataBindings(),this.setupMVUEventListening(),this.warmupSnapshot(),this.forceSync(),console.log('数据绑定管理器初始化完成')}setupDataBindings(){this.bindData('世界状态',()=>{this.updateWorldStateUI(),this.uiController.updateGameInfo(),'quests'===this.uiController.getCurrentView()&&this.uiController.renderQuestsView()}),this.bindData('玩家状态',()=>{this.updatePlayerStateUI(),'status'===this.uiController.getCurrentView()&&this.uiController.renderStatusView()}),this.bindData('角色',()=>{this.updateCharacterStateUI(),this.uiController.updateCharacterDisplay()}),this.bindData('mapData',()=>{this.uiController.renderMapData()}),this.bindData('inventory',()=>{this.updateInventoryUI()}),this.bindData('hummingbirdData',()=>{this.updateHummingbirdUI()})}bindData(t,e){this.bindingMap.has(t)||this.bindingMap.set(t,[]),this.bindingMap.get(t).push(e)}triggerDataBinding(t){const e=this.bindingMap.get(t);e&&e.forEach(e=>{try{e()}catch(e){console.error(`数据绑定回调执行失败 (${t}):`,e)}})}warmupSnapshot(){try{const t=t=>Array.isArray(t)?t[0]:t,e=this.dataManager.getMvuData('玩家状态');if(e){const a=t(e.货币)||{};this.prevSnapshot.currency.lira=Number(a['里拉(R)']??0),this.prevSnapshot.currency.platinum=Number(a['白金币']??0)}const a=this.dataManager.getMvuData('角色');a&&'object'==typeof a&&Object.keys(a).forEach(e=>{if('$meta'===e)return;const n=a[e],s=t(n?.favorability??n?.['好感度']);this.prevSnapshot.favor[e]=Number(s??0)})}catch(t){console.warn('warmupSnapshot 失败:',t)}}updateWorldStateUI(){const t=this.dataManager.getMvuData('世界状态');if(!t)return;const e=t=>Array.isArray(t)?t[0]:t,a=e(t.当前日期);a&&$('#current-date').text(a);const n=e(t.当前时间段);n&&$('#current-time-period').text(n);const s=e(t.当前地点);s&&$('#current-location').text(s);const i=e(t.报纸);i&&this.updateNewspaperFromWorldState(i)}updatePlayerStateUI(){const t=this.dataManager.getMvuData('玩家状态');if(!t)return;const e=t=>Array.isArray(t)?t[0]:t,a=e(t.姓名);a&&$('#player-name').text(a);const n=e(t.货币);n&&(void 0!==n['里拉(R)']&&($('#player-money').text(`${n['里拉(R)'].toLocaleString()} R`),$('#player-lira').text(`${n['里拉(R)'].toLocaleString()} R`)),void 0!==n['白金币']&&$('#player-platinum').text(`${n['白金币']}`));const s=e(t.物品栏);s&&this.updateInventoryFromPlayerState(s)}updateCharacterStateUI(){this.uiController.updateCharacterDisplay()}updateNewspaperFromWorldState(t){console.log('🔄 [DataBinding] 从世界状态更新报纸内容:',t);const e=t=>Array.isArray(t)?t[0]:t,a=e(t);if(console.log('📰 [DataBinding] 提取后的报纸数据对象:',a),!a||'object'!=typeof a)return void console.warn('⚠️ [DataBinding] 报纸数据对象为空');const n=e(a.报刊名)||'三界日报',s=e(a.头条标题)||'';console.log('📑 [DataBinding] 报刊名:',n),console.log('📰 [DataBinding] 头条标题:',s),$('#newspaper-name').text(n),$('#main-headline').text(s);const i=$('#left-column'),o=$('#right-column');i.empty(),o.empty();const r=a.头条配图;if(console.log('🖼️ [DataBinding] 头条配图:',r),r&&Array.isArray(r)&&r.length>=2){const[t,e]=r;t&&o.append(`\n          <div class="headline-image-section">\n            <div class="news-image-frame">\n              <img src="https://60997b0.webp.li/${t}" alt="头条配图" class="news-image" />\n              <p class="image-caption">${e||''}</p>\n            </div>\n          </div>\n        `)}const c=a.头条内容;console.log('📄 [DataBinding] 头条内容:',c),c&&i.append(`\n        <div class="headline-content">\n          <p class="news-content">${c}</p>\n        </div>\n      `);const l=a.次要新闻;if(console.log('📋 [DataBinding] 次要新闻:',l),l&&Array.isArray(l)&&l.length>=2){const t=l[0],e=l[1];t&&e&&i.append(`\n          <div class="secondary-news">\n            <h3 class="secondary-news-title">${t}</h3>\n            <p class="news-content">${e}</p>\n          </div>\n        `)}const d=a.公告栏;if(console.log('📢 [DataBinding] 公告栏:',d),d&&Array.isArray(d)&&d.length>0){o.append(`\n        <div class="announcements-section">\n          <h3 class="news-title">${d[0]}</h3>\n        </div>\n      `);for(let t=1;t<d.length;t++){const e=d[t];e&&'string'==typeof e&&e.trim()&&o.append(`\n            <p class="news-content announcement-item">${e}</p>\n          `)}}console.log('✅ [DataBinding] 报纸内容从世界状态更新完成')}updateInventoryFromPlayerState(t){const e=$('#inventory-grid');e.empty();const a=Object.keys(t).filter(t=>'$meta'!==t).length;$('#inventory-total').text(`${a}`);const n=Object.entries(t).filter(([t])=>'$meta'!==t);0!==n.length?n.forEach(([t,a])=>{const n=$(`\n        <div class="inventory-item" data-item-id="${t}">\n          <div class="inventory-item-icon"><i class="${a.icon||'fas fa-question'}"></i></div>\n          <div class="inventory-item-info">\n            <div class="inventory-item-name">${a.name||''}</div>\n            <div class="inventory-item-description">${a.description||''}</div>\n          </div>\n          <div class="inventory-item-quantity">x${a.quantity}</div>\n        </div>\n      `);e.append(n)}):e.append('\n        <div class="inventory-empty">\n          <i class="fas fa-box-open"></i>\n          <p>背包空空如也</p>\n        </div>\n      ')}updateInventoryUI(){const t=this.dataManager.getMvuData('玩家状态');t&&t.物品栏&&this.updateInventoryFromPlayerState(t.物品栏)}updateHummingbirdUI(){}forceSync(){this.bindingMap.forEach((t,e)=>{this.triggerDataBinding(e)})}setupMVUEventListening(){try{if('undefined'==typeof window||void 0===window.Mvu)return void console.warn('MVU框架不可用，跳过MVU事件监听设置');this.mvuUpdateCallback=t=>{console.log('🔔 [DataBinding] 收到 MVU VARIABLE_UPDATE_ENDED 事件'),this.handleMVUDataUpdate(t)},eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,this.mvuUpdateCallback),console.log('✅ MVU事件监听设置完成')}catch(t){console.error('❌ 设置MVU事件监听失败:',t)}}handleMVUDataUpdate(t){try{'hummingbird'===this.uiController.getCurrentView()&&this.uiController.checkForNewMessages(),this.bindingMap.forEach((t,e)=>{t.forEach(t=>{try{t()}catch(t){console.error(`执行数据绑定回调失败 (${e}):`,t)}})})}catch(t){console.error('处理MVU数据更新失败:',t)}}diffAndNotify(t){try{const e=t=>Array.isArray(t)?t[0]:t,a=t&&t['玩家状态']||this.dataManager.getMvuData('玩家状态');if(console.log('🔔 [DataBinding] diffAndNotify: 玩家状态 =',!!a),a){const t=e(a.货币)||{},n=Number(t['里拉(R)']??0),s=Number(t['白金币']??0),i=n-(this.prevSnapshot.currency.lira||0),o=s-(this.prevSnapshot.currency.platinum||0);console.log('🔔 [DataBinding] 货币 delta:',i,o),i&&this.uiController.showStatToast({type:'money',label:'里拉',delta:i}),o&&this.uiController.showStatToast({type:'platinum',label:'白金币',delta:o}),this.prevSnapshot.currency.lira=n,this.prevSnapshot.currency.platinum=s}const n=t&&t['角色']||this.dataManager.getMvuData('角色');console.log('🔔 [DataBinding] diffAndNotify: 角色 =',!!n),n&&'object'==typeof n&&Object.keys(n).forEach(t=>{if('$meta'===t)return;const a=n[t],s=e(a?.favorability??a?.['好感度']),i=Number(s??0),o=i-Number(this.prevSnapshot.favor[t]??i);console.log('🔔 [DataBinding] 好感 delta:',t,o),o&&this.uiController.showStatToast({type:'favor',label:`${t} 好感度`,delta:o}),this.prevSnapshot.favor[t]=i})}catch(t){console.warn('diffAndNotify 失败:',t)}}destroy(){if(this.mvuUpdateCallback)try{'undefined'!=typeof window&&void 0!==window.Mvu&&(eventRemoveListener(Mvu.events.VARIABLE_UPDATE_ENDED,this.mvuUpdateCallback),console.log('MVU事件监听已清理')),this.mvuUpdateCallback=void 0}catch(t){console.error('清理MVU事件监听失败:',t)}this.bindingMap.clear(),console.log('数据绑定管理器已销毁')}}class a{static testLLMRPParsing(){console.log('测试LLMRP解析功能...');const{llmrpParser:t}=k();if(t)try{if('undefined'==typeof getCurrentMessageId||'undefined'==typeof getChatMessages)return void console.warn('酒馆助手API不可用，无法获取当前消息');const e=getCurrentMessageId(),a=getChatMessages(e)[0];if(!a||!a.message)return void console.log('当前没有消息内容');a.message.includes('<game_response>')?(console.log('发现LLMRP格式消息，开始解析...'),console.log('消息内容预览:',a.message.substring(0,200)+'...'),t.parseAndExecute(a.message),console.log('✅ LLMRP解析完成')):(console.log('当前消息不包含LLMRP格式内容'),console.log('消息内容预览:',a.message.substring(0,100)+'...'))}catch(t){console.error('❌ 测试LLMRP解析时出错:',t)}else console.error('LLMRP解析器未初始化')}static testDataBinding(){const{gameDataManager:t,dataBindingManager:e}=k();if(!t||!e)return void console.error('数据管理器或数据绑定管理器未初始化');console.log('测试数据绑定...');const a=t.getGameState();a&&(t.updateGameState({...a,timePeriod:'夜晚',currentDate:{month:'火之月',day:20}}),console.log('游戏状态已更新')),t.updateCharacter('克罗',{affection:100}),console.log('角色好感度已更新'),e.forceSync(),console.log('数据绑定测试完成')}static testViewSwitching(){const{uiController:t}=k();if(!t)return void console.error('UI控制器未初始化');console.log('测试界面切换...');const e=['status','hummingbird','inventory','map','memoir','quests','newspaper'];let a=0;const n=()=>{if(a<e.length){const s=e[a];console.log(`切换到${s}界面`),t.switchView(s),a++,setTimeout(n,2e3)}else console.log('回到主界面'),t.switchView('novel'),console.log('界面切换测试完成')};n()}static testMVUStorage(){const{gameDataManager:t}=k();if(!t)return void console.error('数据管理器未初始化');console.log('测试MVU变量存储...');const e={testKey:'testValue',timestamp:(new Date).toISOString(),number:Math.random()};t.saveMvuData('debugTest',e);const a=t.getMvuData('debugTest');console.log('保存的数据:',e),console.log('读取的数据:',a),JSON.stringify(e)===JSON.stringify(a)?console.log('✅ MVU变量存储测试通过'):console.log('❌ MVU变量存储测试失败')}static testImageLoading(){console.log('测试网络图片加载...');['https://60997b0.webp.li/克罗 克罗姆艾娜 クロムエイナ (2).png','https://60997b0.webp.li/爱西丝.png','https://60997b0.webp.li/魔界-地图1.png','https://60997b0.webp.li/人界-地图1.png'].forEach((t,e)=>{const a=new Image;a.onload=()=>{console.log(`✅ 图片${e+1}加载成功: ${t}`)},a.onerror=()=>{console.log(`❌ 图片${e+1}加载失败: ${t}`)},a.src=t})}static performanceTest(){console.log('开始性能测试...');const t=performance.now(),{gameDataManager:e}=k();if(e)for(let t=0;t<100;t++)e.getGameState(),e.getCharacters(),e.getMvuData('世界状态');const a=performance.now()-t;console.log(`性能测试完成，耗时: ${a.toFixed(2)}ms`),a<100?console.log('✅ 性能测试通过'):console.log('⚠️ 性能可能需要优化')}static checkMemoryUsage(){if('memory'in performance){const t=performance.memory;console.log('内存使用情况:'),console.log(`已使用: ${(t.usedJSHeapSize/1024/1024).toFixed(2)} MB`),console.log(`总计: ${(t.totalJSHeapSize/1024/1024).toFixed(2)} MB`),console.log(`限制: ${(t.jsHeapSizeLimit/1024/1024).toFixed(2)} MB`)}else console.log('浏览器不支持内存监控')}static runAllTests(){console.log('🚀 开始运行所有测试...'),this.showStatus(),this.showMVUVariables(),this.checkMemoryUsage(),this.testMVUStorage(),this.testImageLoading(),this.performanceTest(),setTimeout(()=>{this.testDataBinding()},1e3),setTimeout(()=>{this.testLLMRPParsing()},2e3),setTimeout(()=>{this.testViewSwitching()},3e3),setTimeout(()=>{console.log('✅ 所有测试完成'),this.checkMemoryUsage()},2e4)}static showStatus(){const t=k();if(console.log('=== 异世界和平应用状态 ==='),console.log('数据管理器:',t.gameDataManager?'✅ 已初始化':'❌ 未初始化'),console.log('UI控制器:',t.uiController?'✅ 已初始化':'❌ 未初始化'),console.log('事件处理器:',t.eventHandler?'✅ 已初始化':'❌ 未初始化'),console.log('LLMRP解析器:',t.llmrpParser?'✅ 已初始化':'❌ 未初始化'),console.log('渲染管理器:',t.renderManager?'✅ 已初始化':'❌ 未初始化'),console.log('数据绑定管理器:',t.dataBindingManager?'✅ 已初始化':'❌ 未初始化'),t.gameDataManager){const e=t.gameDataManager.getGameState(),a=t.gameDataManager.getCharacters();console.log('游戏状态:',e?'✅ 已加载':'❌ 未加载'),console.log('角色数据:',a?'✅ 已加载':'❌ 未加载')}}static showMVUVariables(){console.log('=== 当前MVU变量状态 ===');try{if('undefined'==typeof window||void 0===window.Mvu)return void console.error('❌ MVU框架不可用');if('undefined'==typeof getCurrentMessageId)return void console.error('❌ getCurrentMessageId函数不可用');console.log('✅ MVU框架可用');const t=getCurrentMessageId();console.log('当前消息ID:',t);const e=Mvu.getMvuData({type:'message',message_id:t});console.log('完整MVU数据:',e),e&&e.stat_data?(console.log('=== stat_data 内容 ==='),console.log('世界状态:',e.stat_data['世界状态']||'无数据'),console.log('玩家状态:',e.stat_data['玩家状态']||'无数据'),console.log('角色:',e.stat_data['角色']||'无数据'),console.log('所有可用的键:',Object.keys(e.stat_data))):console.log('❌ 没有stat_data或MVU数据为空'),console.log('=== MVU变量状态查看完成 ===')}catch(t){console.error('❌ 查看MVU变量时出错:',t)}}static testThemeSwitch(){console.log('测试主题切换...');const t=['light','dark','glass'];let e=0;const a=()=>{if(e<t.length){const n=t[e];console.log(`切换到${n}主题`),$('.theme-btn').removeClass('active'),$(`.theme-btn[data-theme="${n}"]`).addClass('active'),$('body').attr('data-theme',n),e++,setTimeout(a,3e3)}else console.log('主题切换测试完成')};a()}static resetAllData(){const{gameDataManager:t}=k();if(!t)return void console.error('数据管理器未初始化');confirm('确定要重置所有游戏数据吗？此操作不可撤销！')&&(console.log('重置所有数据...'),console.log('数据重置完成'))}}'undefined'!=typeof window&&(window.DebugTools=a,console.log('调试工具已加载，使用 DebugTools.showStatus() 查看状态'));const n=toastr;var s=t.n(n);class i{dataManager;uiController;llmrpParser;constructor(t,e){this.dataManager=t,this.uiController=e}setLLMRPParser(t){this.llmrpParser=t}initialize(){this.setupNavigationEvents(),this.setupDialogueEvents(),this.setupMapEvents(),this.setupSettingsEvents(),this.setupModalEvents(),this.setupMessageListener(),this.initializeBreathingEffect(),console.log('事件处理器初始化完成')}initializeBreathingEffect(){const t=this.getBreathingEffectSetting();this.setBreathingEffect(t),console.log('🫁 初始化呼吸效果: '+(t?'开启':'关闭'))}setupNavigationEvents(){$('.nav-btn').off('click.navigation'),$('.nav-btn').on('click.navigation',t=>{const e=$(t.currentTarget),a=e.data('view');a&&($('.nav-btn').removeClass('active'),e.addClass('active'),this.uiController.switchView(a),this.sendViewChangeMessage(a))})}setupDialogueEvents(){console.log('🔧 设置对话事件...');const t=$('#prev-btn'),e=$('#next-btn');console.log('🔍 按钮检查:',{prevBtn:t.length,nextBtn:e.length}),t.off('click.dialogue').on('click.dialogue',()=>{console.log('🔙 Prev按钮被点击'),this.handleDialogueNavigation('prev')}),e.off('click.dialogue').on('click.dialogue',()=>{console.log('▶️ Next按钮被点击'),this.handleDialogueNavigation('next')}),console.log('✅ 对话事件绑定完成'),$('.dialogue-box').off('click.dialogue').on('click.dialogue',t=>{$(t.target).closest('.dialogue-controls').length>0||this.handleDialogueAdvance()})}setupMapEvents(){$('.sg-btn').off('click.map'),$('.sg-btn').on('click.map',t=>{const e=$(t.currentTarget),a=e.data('map');a&&($('.sg-btn').removeClass('active'),e.addClass('active'),this.switchMap(a))})}setupSettingsEvents(){$('#settings-btn').off('click.settings'),$('.theme-btn').off('click.settings'),$('#breathing-toggle').off('change.settings'),$('#text-animation-type, #text-speed-slider, #font-size-slider').off('change.settings input.settings'),$('#reset-settings-btn').off('click.settings'),$(document).off('click.settings'),$('#settings-btn').on('click.settings',t=>{t.stopPropagation();const e=$('#settings-menu'),a=$('#app-container');e.toggleClass('active'),e.hasClass('active')?(a.addClass('modal-active'),this.initBreathingToggleState(),this.initTextSettingsState(),console.log('🎨 激活背景模糊效果')):(a.removeClass('modal-active'),console.log('🎨 取消背景模糊效果'))}),$('.theme-btn').on('click.settings',t=>{const e=$(t.currentTarget),a=e.data('theme');a&&($('.theme-btn').removeClass('active'),e.addClass('active'),this.applyTheme(a))}),$('#breathing-toggle').on('change.settings',t=>{const e=$(t.currentTarget).is(':checked');this.setBreathingEffect(e),console.log('🫁 呼吸效果已'+(e?'开启':'关闭'))}),$('#text-animation-type').on('change.settings',t=>{const e=$(t.currentTarget).val();console.log(`📝 文字动画类型切换为: ${e}`);const a=this.llmrpParser?.getTextAnimationManager();a&&a.setAnimationType(e)}),$('#text-speed-slider').on('input.settings',t=>{let e=210-parseInt($(t.currentTarget).val(),10);Number.isNaN(e)&&(e=50),e=Math.max(10,Math.min(200,e)),$('#text-speed-value').text(`${e}ms`);const a=this.llmrpParser?.getTextAnimationManager();a&&a.setAnimationSpeed(e)}),$('#font-size-slider').on('input.settings',t=>{const e=parseInt($(t.currentTarget).val(),10);$('#font-size-value').text(`${e}px`);const a=this.llmrpParser?.getTextAnimationManager();a&&a.setFontSize(e)}),$('#reset-settings-btn').on('click.settings',t=>{t.stopPropagation();confirm('确定要恢复所有设置为默认值吗？')&&(this.resetToDefaultSettings(),console.log('🔄 设置已恢复为默认值'))}),$(document).on('click.settings',t=>{if(!$(t.target).closest('#settings-btn, #settings-menu').length){const t=$('#settings-menu'),e=$('#app-container');t.hasClass('active')&&(t.removeClass('active'),e.removeClass('modal-active'),console.log('🎨 关闭设置菜单，取消背景模糊'))}})}setupModalEvents(){$('#modal-close-btn').off('click.modal'),$('#modal-container').off('click.modal'),$('#modal-close-btn').on('click.modal',()=>{this.uiController.switchView('novel'),$('.nav-btn').removeClass('active')}),$('#modal-container').on('click.modal',t=>{t.target===t.currentTarget&&(this.uiController.switchView('novel'),$('.nav-btn').removeClass('active'))})}async handleDialogueNavigation(t){if(console.log(`📖 对话导航: ${t}`),'next'===t){if(this.llmrpParser){if(await this.llmrpParser.navigateNext())return void console.log('📄 显示下一条对话')}console.log('📄 已是最新对话 (不自动发送)')}else{if(this.llmrpParser){if(await this.llmrpParser.navigatePrevious())return void console.log('📄 显示上一条对话')}console.log('📄 已是最早对话 (不自动发送)')}}handleDialogueAdvance(){const t=this.llmrpParser?.getTextAnimationManager();if(t&&t.isPlaying())return t.skipAnimation(),void console.log('📝 点击对话框：跳过文字动画');this.handleDialogueNavigation('next'),console.log('📖 点击对话框：尝试进入下一句对话')}switchMap(t){this.dataManager.setCurrentMapType(t),this.uiController.renderMapData(),console.log(`切换到地图: ${t}`)}applyTheme(t){$('body').attr('data-theme',t);try{localStorage.setItem('iswp_theme',t)}catch{}try{document.cookie=`iswp_theme=${encodeURIComponent(t)}; path=/; max-age=31536000`}catch{}console.log(`应用主题并已保存: ${t}`)}setBreathingEffect(t){try{localStorage.setItem('iswp_breathing',t.toString())}catch(t){console.warn('Could not save breathing setting to localStorage',t)}try{document.cookie=`iswp_breathing=${t}; path=/; max-age=31536000`}catch(t){console.warn('Could not save breathing setting to cookie',t)}t?window.enableBreathing?.():window.disableBreathing?.()}initBreathingToggleState(){const t=this.getBreathingEffectSetting();$('#breathing-toggle').prop('checked',t)}initTextSettingsState(){const t=this.llmrpParser?.getTextAnimationManager();if(!t)return;const e=t.getSettings();$('#text-animation-type').val(e.type);const a=e.speed,n=210-a;$('#text-speed-slider').val(n),$('#text-speed-value').text(`${a}ms`),$('#font-size-slider').val(e.fontSize),$('#font-size-value').text(`${e.fontSize}px`)}getBreathingEffectSetting(){try{const t=localStorage.getItem('iswp_breathing');if(null!==t)return'true'===t;const e=document.cookie.match(/(?:^|; )iswp_breathing=([^;]+)/);if(e)return'true'===e[1]}catch{}return!0}async sendViewChangeMessage(t){console.log(`🎮 界面切换到: ${this.getViewDisplayName(t)} (不发送消息)`)}getViewDisplayName(t){return{status:'状态',hummingbird:'蜂鸟通讯',inventory:'背包',map:'地图',memoir:'回忆录',quests:'任务',newspaper:'报纸'}[t]||t}setupMessageListener(){console.log('消息监听器设置完成（由统一监听器处理）')}resetToDefaultSettings(){try{this.applyTheme('dark'),$('.theme-btn').removeClass('active'),$('.theme-btn[data-theme="dark"]').addClass('active'),$('#breathing-toggle').prop('checked',!0),this.setBreathingEffect(!0);const t=50,e=210-t;$('#text-animation-type').val('typewriter'),$('#text-speed-slider').val(e),$('#text-speed-value').text(`${t}ms`),$('#font-size-slider').val('16'),$('#font-size-value').text('16px');const a=this.llmrpParser?.getTextAnimationManager();a&&(a.setAnimationType('typewriter'),a.setAnimationSpeed(t),a.setFontSize(16)),s().success('设置已恢复为默认值')}catch(t){console.error('恢复默认设置时出错:',t),s().error('恢复默认设置失败')}}destroy(){$('.nav-btn').off('.navigation'),$('#prev-btn, #next-btn').off('.dialogue'),$('.dialogue-box').off('.dialogue'),$('.sg-btn').off('.map'),$('#settings-btn, .theme-btn').off('.settings'),$('#text-animation-type, #text-speed-slider, #font-size-slider').off('.settings'),$(document).off('.settings'),$('#modal-close-btn, #modal-container').off('.modal'),console.log('事件处理器已销毁')}}class o{initialized=!1;mvuUpdateCallback;currentMapType='demonRealm';setCurrentMapType(t){this.currentMapType=t}getCurrentMapType(){return this.currentMapType}async initialize(){try{this.getGameData();await this.initializeDefaultData(),this.initialized=!0,console.log('游戏数据管理器初始化完成')}catch(t){throw console.error('数据管理器初始化失败:',t),t}}async initializeDefaultData(){if(!this.getMvuData('世界状态')){const t={当前日期:'',当前时间段:'',当前地点:'',报纸:{报刊名:'',头条标题:'',头条配图:['',''],头条内容:'',次要新闻:[],公告栏:[]}};this.saveMvuData('世界状态',t)}if(!this.getMvuData('玩家状态')){const t={姓名:'',货币:{'里拉(R)':0,白金币:0},物品栏:{}};this.saveMvuData('玩家状态',t)}if(!this.getMvuData('角色')){const t={};this.saveMvuData('角色',t)}if(!this.getMvuData('gameState')){const t={currentView:'novel',currentDate:{month:'',day:0},timePeriod:'',location:{country:'',city:'',place:''},playerName:'',playerMoney:{r:0,platinumCoins:0}};this.saveGameState(t)}if(!this.getMvuData('characters')){const t={};this.saveCharacters(t)}const t={currentMap:'demonRealm',demonRealm:{image:'https://60997b0.webp.li/魔界-地图1.png',points:[{id:'war_domain',name:'战城',description:'由六王之一的"战王"梅基多统治的区域。城市以一座巨大的角斗场为中心，是崇尚力量的魔族们的聚集地，时刻回响着战斗的轰鸣与胜利的欢呼。',coords:{x:17.17,y:55.76}},{id:'central_great_forest',name:'中央大森林',description:'由六王之一"界王"世界树的化身——莉莉伍德守护着这片领域魔界最广阔、魔力最丰沛的森林地带。森林都市"尤克弗莱西斯"坐落于此，是精灵与妖精们的乐土。',coords:{x:30.5,y:50.33}},{id:'garden_of_flowers',name:'万花之园',description:'"蔷薇姬"罗兹米爱尔的私人庭园。其入口被强大的结界隐藏在中央大森林边缘，而庭园本体则存在于一个独立的异空间中。园内培育着无数珍稀花卉，是仅有受邀者才能进入的幻之景点。',coords:{x:34.42,y:55.19}},{id:'underworld_castle',name:'冥王城',description:'六王之一"冥王"克罗姆艾娜的居城。与其说是城堡，更像是一个接纳了众多强大魔族的温馨家园。世界第一的瑟狄奇魔法具商会总部也坐落于此，彰显着此地的非凡地位。',coords:{x:73.17,y:44.34}},{id:'land_of_death',name:'死之大地',description:'由六王之一"死王"爱西丝统治的极寒之地。常年被永不融化的冰雪覆盖，万物绝迹。尽管如此，这片严酷的大地下确实蕴藏着蓝钻与冰晶等足以动摇世界的稀世珍宝。',coords:{x:43.42,y:29.35}},{id:'dragon_mountains',name:'龙之山脉',description:'由六王之一"龙王"马格纳威尔统治的区域，是无数龙种栖息的圣地。其麾下强大的"四大魔龙"守护着这片广阔的山脉，非请莫入。',coords:{x:71.92,y:60.18}},{id:'forbidden_lands',name:'禁忌之地',description:'位于魔界中心的荒芜之地。因六王们曾在此地修炼，残留的强大魔力使其环境极其危险。传闻中，由史莱姆萝泽管理的"六王迷宫"就坐落于此深处。',coords:{x:52.83,y:50.62}}]},humanRealm:{image:'https://60997b0.webp.li/人界-地图1.png',points:[{id:'symphonia_capital',name:'新法尼亚王国 - 首都',description:'人界三大国之一。气候宜人，饮食文化发达，政治稳定，是一座繁华而和平的城市。也是你最初抵达这个世界的地方。',coords:{x:85.75,y:46.91}},{id:'archlesia_capital',name:'阿路克雷西亚帝国 - 首都',description:'人界三大国之一，以丰富的矿产资源、卓越的锻冶和建筑技术闻名的军事强国。现由锐意改革的女皇克里斯统治。',coords:{x:25.08,y:27.77}},{id:'hydra_capital',name:'海德拉王国 - 首都',description:'人界三大国之一，临海的港口国家。服装文化与商业极为发达，社会风气开放，鼓励革新与挑战。由初代勇者的同伴、人鱼女王拉古娜统治。',coords:{x:45.67,y:84.61}},{id:'friendly_city_hikari',name:'友好都市光',description:'为纪念初代勇者而建，是人、魔、神三界友好条约的签订地。由创造神亲自设立的教主奥莉薇亚守护，是一个独立于三国的和平中立都市。',coords:{x:54.83,y:60.9}},{id:'falen_town',name:'法伦镇',description:'位于新法尼亚王国，是东西交易的据点。由当代的勇者光永正义及其妻子卡特蕾雅公主共同治理，是一片充满活力的新兴贵族领地。',coords:{x:79,y:65.9}},{id:'alices_shop',name:'爱丽丝的杂货铺',description:'坐落在王都偏僻小巷里的一家奇特杂货店。店主是戴着面具、言行古怪的少女爱丽丝。店内似乎出售着一些品质极高的珍品，但生意总是异常冷清。',coords:{x:74.5,y:34.34}},{id:'albert_residence',name:'阿尔伯特公爵府邸',description:'新法尼亚王国的公爵莉莉娅·阿尔伯特的住所，也是你在这个世界最初的家。现在，你自己的宅邸也建在其旁边，两座府邸通过走廊相连，形成了一片广阔的庄园。',coords:{x:69.67,y:35.48}}]}};this.getMvuData('mapData')||this.saveMapData(t)}isMvuAvailable(){return'undefined'!=typeof window&&void 0!==window.Mvu&&'undefined'!=typeof getCurrentMessageId}getGameData(){try{if(!this.isMvuAvailable())return console.warn('MVU框架不可用，使用本地存储'),this.getLocalStorageData();const t=getCurrentMessageId(),e=Mvu.getMvuData({type:'message',message_id:t});return e?.stat_data||{}}catch(t){return console.warn('获取游戏数据失败，可能是首次运行:',t),this.getLocalStorageData()}}saveGameState(t){this.saveMvuData('gameState',t)}getGameState(){try{const t=this.getMvuData('世界状态'),e=this.getMvuData('玩家状态'),a=this.getMvuData('gameState')||{};if(!t&&!e&&!a)return null;const n=Array.isArray(t?.当前日期)?t.当前日期[0]:t?.当前日期,s=Array.isArray(t?.当前时间段)?t.当前时间段[0]:t?.当前时间段,i=Array.isArray(t?.当前地点)?t.当前地点[0]:t?.当前地点,o=Array.isArray(e?.姓名)?e.姓名[0]:e?.姓名,r=Array.isArray(e?.货币)?e.货币[0]:e?.货币;return{currentDate:n?{month:n.split(' ')[0]||'',day:parseInt(n.split(' ')[1]?.replace('日',''))||0}:{month:'',day:0},timePeriod:s||'',location:{country:'',city:'',place:i||''},playerMoney:r?{r:r['里拉(R)']??r['人界货币R']??0,platinumCoins:r['白金币']??r['魔界货币P']??0}:{r:0,platinumCoins:0},currentCharacter:a.currentCharacter||'',currentView:a.currentView||'main',playerName:o||a.playerName||''}}catch(t){return console.error('获取游戏状态失败:',t),null}}saveCharacters(t){console.debug('[NO-OP] 前端禁写MVU：saveCharacters 被忽略')}getCharacters(){return this.getMvuData('角色')}saveMapData(t){console.debug('[NO-OP] 前端禁写MVU：saveMapData 被忽略')}getMapData(){const t=this.getMvuData('mapData');return t||(console.warn('🗺️ Map data not found in MVU, using default static map data.'),{currentMap:'demonRealm',demonRealm:{image:'https://60997b0.webp.li/魔界-地图1.png',points:[{id:'war_domain',name:'战城',description:'由六王之一的"战王"梅基多统治的区域。城市以一座巨大的角斗场为中心，是崇尚力量的魔族们的聚集地，时刻回响着战斗的轰鸣与胜利的欢呼。',coords:{x:17.17,y:55.76}},{id:'central_great_forest',name:'中央大森林',description:'由六王之一"界王"世界树的化身——莉莉伍德守护着这片领域魔界最广阔、魔力最丰沛的森林地带。森林都市"尤克弗莱西斯"坐落于此，是精灵与妖精们的乐土。',coords:{x:30.5,y:50.33}},{id:'garden_of_flowers',name:'万花之园',description:'"蔷薇姬"罗兹米爱尔的私人庭园。其入口被强大的结界隐藏在中央大森林边缘，而庭园本体则存在于一个独立的异空间中。园内培育着无数珍稀花卉，是仅有受邀者才能进入的幻之景点。',coords:{x:34.42,y:55.19}},{id:'underworld_castle',name:'冥王城',description:'六王之一"冥王"克罗姆艾娜的居城。与其说是城堡，更像是一个接纳了众多强大魔族的温馨家园。世界第一的瑟狄奇魔法具商会总部也坐落于此，彰显着此地的非凡地位。',coords:{x:73.17,y:44.34}},{id:'land_of_death',name:'死之大地',description:'由六王之一"死王"爱西丝统治的极寒之地。常年被永不融化的冰雪覆盖，万物绝迹。尽管如此，这片严酷的大地下确实蕴藏着蓝钻与冰晶等足以动摇世界的稀世珍宝。',coords:{x:43.42,y:29.35}},{id:'dragon_mountains',name:'龙之山脉',description:'由六王之一"龙王"马格纳威尔统治的区域，是无数龙种栖息的圣地。其麾下强大的"四大魔龙"守护着这片广阔的山脉，非请莫入。',coords:{x:71.92,y:60.18}},{id:'forbidden_lands',name:'禁忌之地',description:'位于魔界中心的荒芜之地。因六王们曾在此地修炼，残留的强大魔力使其环境极其危险。传闻中，由史莱姆萝泽管理的"六王迷宫"就坐落于此深处。',coords:{x:52.83,y:50.62}}]},humanRealm:{image:'https://60997b0.webp.li/人界-地图1.png',points:[{id:'symphonia_capital',name:'新法尼亚王国 - 首都',description:'人界三大国之一。气候宜人，饮食文化发达，政治稳定，是一座繁华而和平的城市。也是你最初抵达这个世界的地方。',coords:{x:85.75,y:46.91}},{id:'archlesia_capital',name:'阿路克雷西亚帝国 - 首都',description:'人界三大国之一，以丰富的矿产资源、卓越的锻冶和建筑技术闻名的军事强国。现由锐意改革的女皇克里斯统治。',coords:{x:25.08,y:27.77}},{id:'hydra_capital',name:'海德拉王国 - 首都',description:'人界三大国之一，临海的港口国家。服装文化与商业极为发达，社会风气开放，鼓励革新与挑战。由初代勇者的同伴、人鱼女王拉古娜统治。',coords:{x:45.67,y:84.61}},{id:'friendly_city_hikari',name:'友好都市光',description:'为纪念初代勇者而建，是人、魔、神三界友好条约的签订地。由创造神亲自设立的教主奥莉薇亚守护，是一个独立于三国的和平中立都市。',coords:{x:54.83,y:60.9}},{id:'falen_town',name:'法伦镇',description:'位于新法尼亚王国，是东西交易的据点。由当代的勇者光永正义及其妻子卡特蕾雅公主共同治理，是一片充满活力的新兴贵族领地。',coords:{x:79,y:65.9}},{id:'alices_shop',name:'爱丽丝的杂货铺',description:'坐落在王都偏僻小巷里的一家奇特杂货店。店主是戴着面具、言行古怪的少女爱丽丝。店内似乎出售着一些品质极高的珍品，但生意总是异常冷清。',coords:{x:74.5,y:34.34}},{id:'albert_residence',name:'阿尔伯特公爵府邸',description:'新法尼亚王国的公爵莉莉娅·阿尔伯特的住所，也是你在这个世界最初的家。现在，你自己的宅邸也建在其旁边，两座府邸通过走廊相连，形成了一片广阔的庄园。',coords:{x:69.67,y:35.48}}]}})}getLocalStorageData(){try{const t=localStorage.getItem('gameData_异世界和平');return t?JSON.parse(t):null}catch(t){return console.warn('获取本地存储数据失败:',t),null}}saveLocalStorageData(t){try{localStorage.setItem('gameData_异世界和平',JSON.stringify(t))}catch(t){console.error('保存本地存储数据失败:',t)}}saveMvuData(t,e){console.debug('[NO-OP] 前端禁写MVU，忽略保存:',t)}getMvuData(t){try{if(!this.isMvuAvailable()){console.warn('MVU框架不可用，使用本地存储');const e=this.getLocalStorageData();return e?e[t]:null}const e=getCurrentMessageId(),a=Mvu.getMvuData({type:'message',message_id:e});return a?.stat_data?.[t]||null}catch(e){console.warn(`获取${t}数据失败:`,e);const a=this.getLocalStorageData();return a?a[t]:null}}updateGameState(t){console.debug('[NO-OP] 前端禁写MVU：updateGameState 被忽略')}updateCharacter(t,e){console.debug('[NO-OP] 前端禁写MVU：updateCharacter 被忽略')}extractValue(t){return Array.isArray(t)?t[0]:t}findCharacterIdByName(t){if(!t)return null;const e=String(t).trim();if(!e)return null;const a=t=>t.replace(/\s+/g,'').toLowerCase(),n=a(e),s=this.getCharacters();if(!s)return null;for(const t of Object.keys(s)){const e=s[t],i=this.extractValue(e.nickname||''),o=this.extractValue(e.fullName||''),r=a(t),c=a(i||''),l=a(o||'');if(n===r||c&&n===c||l&&n===l)return t;if(l&&(l.includes(n)||n.includes(l))||c&&(c.includes(n)||n.includes(c))||r&&(r.includes(n)||n.includes(r)))return t}return null}getCharacterAvatarUrl(t){if(!t)return null;const e=this.findCharacterIdByName(t);return e?`https://60997b0.webp.li/${encodeURIComponent(e)}-头像.png`:null}getCharacter(t){const e=this.getCharacters();return e&&e[t]||null}saveDialogueHistory(t){console.debug('[NO-OP] 前端禁写MVU：saveDialogueHistory 被忽略')}getDialogueHistory(){return this.getMvuData('dialogueHistory')||[]}saveQuests(t){console.debug('[NO-OP] 前端禁写MVU：saveQuests 被忽略')}getQuests(){return this.getMvuData('quests')||{main:[],side:[]}}getCurrentQuest(){try{const t=this.getMvuData('世界状态');if(!t||!t.当前任务)return null;const e=this.extractValue(t.当前任务);return e?{名称:e.名称||'无标题任务',详情:e.详情||'暂无详情'}:null}catch(t){return console.error('获取当前任务数据失败:',t),null}}saveHummingbirdData(t){console.debug('[NO-OP] 前端禁写MVU：saveHummingbirdData 被忽略')}getHummingbirdData(){return this.getMvuData('hummingbirdData')||{contacts:[],chats:{}}}onDataChange(t){try{if(!this.isMvuAvailable())return void console.warn('MVU框架不可用，无法设置数据变化监听');this.mvuUpdateCallback=e=>{console.log('检测到MVU变量更新'),t(e.stat_data)},eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,this.mvuUpdateCallback),console.log('MVU数据变化监听已设置')}catch(t){console.error('设置MVU数据变化监听失败:',t)}}parseGameCommand(t){const e=t.match(/\[游戏指令:(.+?):(.+?)\]/);return e?{type:e[1],parameter:e[2]}:null}executeGameCommand(t){switch(t.type){case'切换角色':this.switchCharacter(t.parameter);break;case'更新金钱':this.updateMoney(parseInt(t.parameter));break;case'切换位置':this.updateLocation(t.parameter);break;default:console.log('未知游戏指令:',t)}}switchCharacter(t){console.debug('[NO-OP] 前端禁写MVU：switchCharacter 被忽略')}updateMoney(t){console.debug('[NO-OP] 前端禁写MVU：updateMoney 被忽略')}updateLocation(t){console.debug('[NO-OP] 前端禁写MVU：updateLocation 被忽略')}destroy(){if(this.mvuUpdateCallback&&this.isMvuAvailable())try{eventRemoveListener(Mvu.events.VARIABLE_UPDATE_ENDED,this.mvuUpdateCallback),this.mvuUpdateCallback=void 0,console.log('MVU事件监听已清理')}catch(t){console.error('清理MVU事件监听失败:',t)}this.initialized=!1,console.log('游戏数据管理器已销毁')}}class r{currentAnimation=null;isAnimating=!1;currentText='';targetElement=null;animationSpeed=50;animationType='typewriter';constructor(){this.loadSettings()}loadSettings(){const t=localStorage.getItem('textAnimationSpeed'),e=localStorage.getItem('textAnimationType'),a=localStorage.getItem('dialogueFontSize');t&&(this.animationSpeed=parseInt(t,10)),e&&['typewriter','fade','instant'].includes(e)&&(this.animationType=e),a&&this.applyFontSize(parseInt(a,10))}saveSettings(){localStorage.setItem('textAnimationSpeed',this.animationSpeed.toString()),localStorage.setItem('textAnimationType',this.animationType)}setAnimationSpeed(t){this.animationSpeed=Math.max(5,Math.min(500,t)),localStorage.setItem('textAnimationSpeed',this.animationSpeed.toString())}setAnimationType(t){this.animationType=t,localStorage.setItem('textAnimationType',t)}setFontSize(t){localStorage.setItem('dialogueFontSize',t.toString()),this.applyFontSize(t)}applyFontSize(t){const e=Math.max(12,Math.min(32,t));$('#dialogue-content').css('font-size',`${e}px`)}async displayText(t,e,a){this.stopCurrentAnimation(),this.currentText=t,this.targetElement=e,this.isAnimating=!0;try{switch(this.animationType){case'typewriter':await this.typewriterEffect(t,e);break;case'fade':await this.fadeInEffect(t,e);break;default:this.instantDisplay(t,e)}}catch(t){}finally{this.isAnimating=!1,a&&a()}}async typewriterEffect(t,e){return e.empty(),new Promise((a,n)=>{let s=0;const i=Array.from(t);let o=0;Date.now();const r=Math.max(.35,Math.min(2,this.animationSpeed/50)),c=Math.min(1,this.animationSpeed/120),l=()=>{if(!this.isAnimating)return void n(new Error('Animation stopped'));if(s>=i.length)return void a();const t=i[s];e.append(t),s++;let d=this.animationSpeed;Date.now();if('。'===t||'！'===t||'？'===t||'…'===t)d*=(1.8+Math.random()*(.8*c))*r,o=0;else if('，'===t||'、'===t||'；'===t||'：'===t)d*=(1.3+Math.random()*(.6*c))*r,o=0;else if(' '===t)d*=(.8+Math.random()*(.2*c))*Math.max(.5,r);else{const t=Math.random();t<.08&&0===o?(o=2+Math.floor(2*Math.random()),d*=.6):o>0?(d*=.45+.25*Math.random(),o--):d*=t<.2?(1.8+Math.random()*(.8*c))*r:t<.4?.85+.25*Math.random():(.9+Math.random()*(.3*c))*r}this.currentAnimation=window.setTimeout(l,Math.max(d,12))};l()})}async fadeInEffect(t,e){return e.empty(),new Promise((a,n)=>{let s=0;const i=Array.from(t),o=()=>{if(!this.isAnimating)return void n(new Error('Animation stopped'));if(s>=i.length)return void a();const t=i[s];e.append(t),s++;const r=Math.max(1*this.animationSpeed,20);this.currentAnimation=window.setTimeout(o,r)};o()})}instantDisplay(t,e){e.text(t).css('opacity','1')}stopCurrentAnimation(){this.isAnimating=!1,this.currentAnimation&&(clearTimeout(this.currentAnimation),this.currentAnimation=null),this.targetElement&&this.currentText&&this.targetElement.stop(!0,!0).text(this.currentText).css('opacity','1')}skipAnimation(){this.isAnimating&&this.targetElement&&this.currentText&&this.stopCurrentAnimation()}isPlaying(){return this.isAnimating}getSettings(){const t=parseInt(localStorage.getItem('dialogueFontSize')||'16',10);return{speed:this.animationSpeed,type:this.animationType,fontSize:t}}}const c=_;var l=t.n(c);class d{uiController;dataManager;stage=[];MAX_CHARACTERS=3;characterIdCounter=0;imageCache=new Map;MAX_CACHE_SIZE=20;animatingCharacters=new Set;currentSpeaker=null;constructor(t,e){this.uiController=t,this.dataManager=e}async speakCharacter(t,e){if(console.log('🎭 角色说话:',{name:t,spriteUrl:e}),this.animatingCharacters.has(t))return void console.log('⏭️ 角色正在动画中，跳过:',t);await this.preloadImage(e);const a=this.stage.findIndex(e=>e.name===t);if(a>=0){const n=this.stage[a];console.log('🔄 更新现有角色立绘:',t),await this.updateCharacterSprite(n,e),this.highlightSpeakingCharacter(n)}else console.log('👋 新角色入场:',t),await this.addCharacter(t,e);await this.relayoutCharacters(),this.syncCurrentCharacterState(t)}syncCurrentCharacterState(t){try{const e=this.dataManager.findCharacterIdByName(t)??t;this.dataManager.updateGameState({currentCharacter:e}),this.uiController.updateCharacterDisplay(),console.log('🔄 已同步角色状态:',{characterName:t,matchedId:e})}catch(t){console.warn('⚠️ 同步角色状态失败:',t)}}async preloadImage(t){if(this.imageCache.has(t))return console.log('📷 使用缓存图片:',t),this.imageCache.get(t);if(this.imageCache.size>=this.MAX_CACHE_SIZE){const t=this.imageCache.keys().next().value;t&&(this.imageCache.delete(t),console.log('🧹 清理旧图片缓存:',t))}return new Promise(e=>{const a=new Image;a.onload=()=>{console.log('✅ 图片预加载成功:',t),this.imageCache.set(t,a),e(a)},a.onerror=()=>{console.error('❌ 图片加载失败:',t);const a=new Image;a.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9veWksei0pTwvdGV4dD48L3N2Zz4=',this.imageCache.set(t,a),e(a)},a.src=t,setTimeout(()=>{a.complete||a.onerror?.(new Event('timeout'))},5e3)})}async addCharacter(t,e){this.animatingCharacters.add(t);try{if(this.stage.length>=this.MAX_CHARACTERS){const t=this.stage.shift();console.log('🚪 移除最早角色:',t.name),await this.removeCharacterFromDOM(t)}const a={name:t,spriteUrl:e,elementId:'character-stage-'+ ++this.characterIdCounter,entryTime:Date.now()};this.stage.push(a),await this.createCharacterElement(a),await this.playEntryAnimation(a),this.highlightSpeakingCharacter(a),console.log('✅ 角色已入场，当前舞台:',this.stage.map(t=>t.name))}finally{this.animatingCharacters.delete(t)}}async updateCharacterSprite(t,e){if(t.spriteUrl!==e){this.animatingCharacters.add(t.name);try{t.spriteUrl=e;const a=$(`#${t.elementId}`);a.length>0&&(a.addClass('sprite-changing'),await this.sleep(100),a.attr('src',e),await this.sleep(50),a.removeClass('sprite-changing'),console.log('🔄 立绘切换完成:',t.name))}finally{this.animatingCharacters.delete(t.name)}}}async relayoutCharacters(){const t=this.stage.length;console.log('🎯 重新布局角色，数量:',t);const e=[];for(let a=0;a<this.stage.length;a++){const n=this.stage[a],s=$(`#${n.elementId}`);if(0===s.length)continue;let i;i=1===t?'center':2===t?0===a?'left':'right':['three-left','three-center','three-right'][a],e.push(this.moveToPosition(s,i))}await Promise.all(e)}async createCharacterElement(t){const e=$('.character-container');if(0===e.length)return void console.error('❌ character-container 容器不存在！');console.log('🏗️ 创建角色元素:',t.name,'图片:',t.spriteUrl);const a=$(`\n      <img id="${t.elementId}"\n           class="character-sprite dynamic"\n           src="${t.spriteUrl}"\n           alt="${t.name}"\n           style="opacity: 0;" />\n    `);a.addClass('entering'),a.on('load',()=>{console.log('✅ 角色图片加载成功:',t.spriteUrl)}).on('error',()=>{console.error('❌ 角色图片加载失败:',t.spriteUrl)});const n=e.find('.character-status-tooltip');n.length>0?a.insertBefore(n):e.append(a),console.log('📦 角色元素已添加到DOM:',t.elementId);const s=this.dataManager.findCharacterIdByName(t.name)||t.name;a.attr('data-character-id',s),a.on('mouseenter',()=>{this.uiController.renderCharacterStatusTooltipFor(s),this.uiController.positionCharacterTooltipNearElement(a[0]),this.uiController.showCharacterTooltip()}),a.on('mousemove',()=>{this.uiController.positionCharacterTooltipNearElement(a[0])}),a.on('mouseleave',()=>{this.uiController.hideCharacterTooltip()})}async playEntryAnimation(t){const e=$(`#${t.elementId}`);0!==e.length?(console.log('🎬 开始入场动画:',t.name),e.addClass('entering'),await this.sleep(300),e.removeClass('entering'),e.css('opacity','1'),console.log('✨ 入场动画完成:',t.name)):console.error('❌ 角色元素不存在:',t.elementId)}async moveToPosition(t,e){t.removeClass('pos-left pos-center pos-right pos-three-left pos-three-center pos-three-right').addClass(`pos-${e}`),await this.sleep(400)}async removeCharacterFromDOM(t){const e=$(`#${t.elementId}`);e.length>0&&(e.addClass('exiting'),await this.sleep(200),e.remove())}getStageInfo(){return{count:this.stage.length,characters:this.stage.map(t=>t.name)}}highlightSpeakingCharacter(t){this.currentSpeaker!==t.name?(this.currentSpeaker=t.name,$('.character-sprite.dynamic').removeClass('dimmed'),$('.character-sprite.dynamic').each((e,a)=>{const n=$(a);n.attr('id')!==t.elementId&&n.addClass('dimmed')}),console.log('🗣️ 角色开始说话:',t.name)):console.log('🗣️ 角色继续说话:',t.name)}clearSpeakerHighlight(){this.currentSpeaker=null,$('.character-sprite.dynamic').removeClass('dimmed'),console.log('🗨️ 已清除所有角色暗化效果')}async clearStage(){if(0!==this.stage.length){console.log('🧹 清空舞台，当前角色:',this.stage.map(t=>t.name));for(const t of this.stage)await this.removeCharacterFromDOM(t);this.stage=[],this.characterIdCounter=0,this.animatingCharacters.clear(),console.log('✅ 舞台已清空')}else console.log('🧹 舞台已为空，无需清理')}executeCharacterAction(t,e){console.log('🎭 在舞台上查找角色进行动作:',{targetCharacterName:t,actionType:e});const a=this.stage.find(e=>e.name===t);if(!a)return void console.warn('⚠️ 目标角色不在舞台上，无法执行动作:',t);const n=$(`#${a.elementId}`);if(n.length)if(console.log(`🎭 执行${t}的${e}动作`),this.animatingCharacters.has(a.elementId))console.log('⏳ 角色正在执行其他动画，跳过本次动作');else{this.animatingCharacters.add(a.elementId);try{switch(e){case'shake':this.executeShakeAction(n,a.elementId);break;case'jump_up':this.executeJumpUpAction(n,a.elementId);break;case'jump_down':this.executeJumpDownAction(n,a.elementId);break;default:console.warn('⚠️ 未知的动作类型:',e),this.animatingCharacters.delete(a.elementId)}}catch(t){console.error('❌ 执行角色动作时出错:',t),this.animatingCharacters.delete(a.elementId)}}else console.warn('⚠️ 角色元素不存在:',a.elementId)}executeShakeAction(t,e){console.log('🫨 执行摇晃动作'),t.addClass('character-shake'),setTimeout(()=>{t.removeClass('character-shake'),this.animatingCharacters.delete(e),console.log('🫨 摇晃动作完成')},600)}executeJumpUpAction(t,e){console.log('⬆️ 执行向上跳跃动作');const a=this.getAndRemoveBreathingClasses(t);t.addClass('character-jump-up'),setTimeout(()=>{t.removeClass('character-jump-up'),this.restoreBreathingClasses(t,a),this.animatingCharacters.delete(e),console.log('⬆️ 向上跳跃动作完成')},400)}executeJumpDownAction(t,e){console.log('⬇️ 执行向下跳跃动作');const a=this.getAndRemoveBreathingClasses(t);t.addClass('character-jump-down'),setTimeout(()=>{t.removeClass('character-jump-down'),this.restoreBreathingClasses(t,a),this.animatingCharacters.delete(e),console.log('⬇️ 向下跳跃动作完成')},400)}cleanup(){console.log('🧹 清理立绘系统资源'),this.imageCache.clear(),this.animatingCharacters.clear(),$('.character-sprite.dynamic').removeClass('dimmed'),this.currentSpeaker=null,this.stage=[],this.characterIdCounter=0,$('.character-sprite.dynamic').remove(),console.log('✅ 立绘系统资源已清理')}sleep(t){return new Promise(e=>setTimeout(e,t))}getAndRemoveBreathingClasses(t){const e=[];return['breathing-natural','breathing-sway','breathing-pulse','breathing-rhythmic'].forEach(a=>{t.hasClass(a)&&(e.push(a),t.removeClass(a))}),e.length>0&&console.log('🌬️ Pausing breathing animation:',e),e}restoreBreathingClasses(t,e){e.length>0&&(t.addClass(e.join(' ')),console.log('🌬️ Resuming breathing animation:',e))}}class h{dataManager;uiController;textAnimationManager;stageManager;dialogueHistory=[];currentDialogueIndex=-1;MAX_DIALOGUE_HISTORY=100;currentBackground=null;nextBackground=null;currentCG=null;displayedCG=null;lastMemoirIndexRecorded=-1;constructor(t,e){this.dataManager=t,this.uiController=e,this.textAnimationManager=new r,this.stageManager=new d(this.uiController,this.dataManager)}initialize(){console.log('LLMRP解析器初始化完成')}async parseAndExecute(t,e={}){try{const a=t.match(/<game_response>([\s\S]*?)<\/game_response>/);if(!a)return;const n=a[1];window.skipChoiceDelay=e.skipChoiceDelay||!1,console.log('🎬 开始解析新剧情，清空舞台和对话历史'),await this.stageManager.clearStage(),this.dialogueHistory=[],this.currentDialogueIndex=-1,this.nextBackground=null,this.currentCG=null,this.hideCG();const s=n.split('\n').map(t=>t.trim()).filter(t=>t);for(const t of s){const e=this.parseLine(t);e&&await this.executeCommand(e)}try{const t=[];for(const e of s){if(e.startsWith('[')&&e.endsWith(']'))continue;const a=e.split('|');if(a.length<3)continue;const n=(a[0]||'').trim();let s=a.slice(2).join('|').trim();if(s=s.replace(/\s*\[action\|[^|]+\|[^|\]]+\]\s*/g,'').trim(),!s)continue;const i=this.dataManager.getCharacterAvatarUrl(n);t.push({speaker:n,text:s,avatarUrl:i})}this.uiController.setCurrentMemoir(t)}catch(t){console.warn('构建回忆录失败（已忽略）：',t)}this.dialogueHistory.length>0&&(this.currentDialogueIndex=0,await this.displayCurrentDialogue()),delete window.skipChoiceDelay,this.uiController.updateUI()}catch(t){console.error('LLMRP解析失败:',t)}}parseLine(t){const e=t.trim();if(!e)return null;if(e.startsWith('[')&&e.endsWith(']')){const t=e.slice(1,-1),a=t.split('|').map(t=>t.trim());return console.log('🔧 解析方括号指令:',{content:t,parts:a,type:a[0]}),{type:a[0],parameters:a.slice(1)}}const a=e.indexOf('|'),n=e.indexOf('|',a+1);if(-1!==a&&-1!==n){const t=e.substring(0,a).trim(),s=e.substring(a+1,n).trim(),i=e.substring(n+1).trim(),o=[t,s,i];return console.log('🔍 检查对话指令:',{line:e,parts:o}),''===t?(console.warn('⚠️ 跳过空角色名'),null):(console.log('🎭 识别为角色对话:',{角色名:t,立绘:s,对话:i}),{type:'CHARACTER_DIALOGUE',parameters:o})}return null}async executeCommand(t){switch(t.type){case'CHARACTER_DIALOGUE':await this.handleCharacterDialogue(t.parameters);break;case'bg':await this.handleBackgroundCommand(t.parameters[0]);break;case'bgm':this.handleBGM(t.parameters[0]);break;case'choice':this.handleChoice(t.parameters);break;case'cg':this.handleCGCommand(t.parameters[0]);break;case'hide_cg':this.handleHideCG();break;default:console.log('❌ 未知或不支持的指令:',t.type,'| 仅支持 [bg|...]、[bgm|...]、[choice|...]、[cg|...]、[hide_cg] 与对话行 角色|立绘|文本')}}handleBGM(t){console.log('播放BGM:',t)}async handleBackground(t){console.log('🖼️ 切换背景:',t);const e=this.convertToNetworkUrl(t,'background');console.log('🔗 背景URL:',e);const a=$('#content-area'),n=$('#background-overlay');if(!this.currentBackground)return console.log('🎬 设置初始背景'),a.css({'background-image':`url(${e})`,'background-size':'cover','background-position':'center','background-repeat':'no-repeat'}),this.currentBackground=e,void console.log('✅ 初始背景已设置');if(this.currentBackground!==e){console.log('🎭 开始背景淡入淡出切换');try{n.css('opacity','0'),await this.sleep(50),n.css('opacity','1'),await this.sleep(500),a.css({'background-image':`url(${e})`,'background-size':'cover','background-position':'center','background-repeat':'no-repeat'}),await this.sleep(50),n.css('opacity','0'),await this.sleep(500),this.currentBackground=e,console.log('✅ 背景切换完成')}catch(t){console.error('❌ 背景切换失败:',t),a.css({'background-image':`url(${e})`,'background-size':'cover','background-position':'center','background-repeat':'no-repeat'}),n.css('opacity','0'),this.currentBackground=e}}else console.log('🔄 背景相同，跳过切换')}async handleBackgroundCommand(t){console.log('📝 处理背景指令:',t);const e=this.convertToNetworkUrl(t,'background');this.currentBackground?(console.log('🔗 后续背景已记录，等待推进时切换:',e),this.nextBackground=e):(console.log('🎬 第一个背景，立即显示:',e),await this.handleBackground(e))}sleep(t){return new Promise(e=>setTimeout(e,t))}handleCharacterDialogue(t){if(t.length<3)return void console.warn('🚨 CHARACTER_DIALOGUE指令参数不足:',t);const[e,a,n]=t;if(!e||''===e)return void console.warn('⚠️ 跳过空角色对话');let s=n;const i=s.match(/\s*\[action\|([^|]+)\|([^|\]]+)\]\s*/);let o,r=null;if(i){r={targetCharacter:i[1].trim(),actionType:i[2].trim()},s=s.replace(/\s*\[action\|([^|]+)\|([^|\]]+)\]\s*/g,'').trim(),console.log('🎭 检测到角色动作指令:',r)}console.log('🎭 处理角色对话（记录模式）:',{characterName:e,spriteFileName:a,dialogueText:s,actionCommand:r});let c=!1;a&&''!==a.trim()?(o=this.convertToNetworkUrl(a,'character'),c=!0,this.updateCharacterData(e,o),console.log('🎭 有立绘角色:',e)):console.log('🗨️ 无立绘角色:',e),this.addToDialogueHistory({speaker:e,text:s,type:'dialogue',backgroundUrl:this.nextBackground||void 0,characterName:c?e:void 0,spriteUrl:o,cgUrl:this.currentCG,actionCommand:r}),this.nextBackground=null,console.log('📝 角色对话已记录，等推进时显示立绘和执行动作')}syncSpeakerCharacterState(t){try{const e=this.dataManager.findCharacterIdByName(t);e?(this.dataManager.updateGameState({currentCharacter:e}),this.uiController.updateCharacterDisplay(),console.log('🗨️ 已同步无立绘角色状态:',{speakerName:t,matchedId:e})):console.log('🗨️ 跳过同步状态（非角色数据中的说话人）:',t)}catch(t){console.warn('⚠️ 同步说话角色状态失败:',t)}}updateCharacterData(t,e){const a=this.dataManager.findCharacterIdByName(t)||t;this.dataManager.getCharacter(a)&&(this.dataManager.updateCharacter(a,{avatar:e}),this.dataManager.updateGameState({currentCharacter:a}),console.log('📊 角色数据已更新（仅数据，不触发UI）:',a))}async displayCurrentDialogue(){if(this.currentDialogueIndex<0||this.currentDialogueIndex>=this.dialogueHistory.length)return;const t=this.dialogueHistory[this.currentDialogueIndex];console.log('🎬 显示对话:',t),t.backgroundUrl&&t.backgroundUrl!==this.currentBackground&&(console.log('🖼️ 推进到背景切换点，开始切换背景:',t.backgroundUrl),await this.handleBackground(t.backgroundUrl));const e=t.cgUrl??null;e!==this.displayedCG&&(e?this.showCG(e):this.hideCG()),t.characterName&&t.spriteUrl?(console.log('🎭 推进到角色对话，显示立绘:',t.characterName),await this.stageManager.speakCharacter(t.characterName,t.spriteUrl)):t.speaker&&(console.log('🗨️ 无立绘角色说话，清除暗化效果:',t.speaker),this.stageManager.clearSpeakerHighlight(),this.syncSpeakerCharacterState(t.speaker)),$('#speaker-name').text(t.speaker),'choice'===t.type&&t.choices?this.displayChoicesInDialogue(t.choices):(await this.textAnimationManager.displayText(t.text,$('#dialogue-content')),this.hideChoiceInput(),this.currentDialogueIndex>this.lastMemoirIndexRecorded&&(await this.appendDialogueMemo(t.text),this.lastMemoirIndexRecorded=this.currentDialogueIndex)),t.actionCommand&&setTimeout(()=>{this.executeCharacterAction(t.actionCommand.targetCharacter,t.actionCommand.actionType)},500),this.updateNavigationButtons()}displayChoicesInDialogue(t){console.log('🎯 在对话框中显示选择项:',t);let e='<div class="dialogue-choices">';t.forEach((t,a)=>{const n=a+1;e+=`\n        <div class="dialogue-choice-item" data-choice="${n}">\n          <div class="dialogue-choice-btn">\n            <span class="choice-text">${t}</span>\n            <button class="choice-quick-send-btn" data-choice="${n}" title="快速发送此选择">\n              <i class="fas fa-paper-plane"></i>\n            </button>\n          </div>\n        </div>\n      `}),e+='</div>',$('#dialogue-content').html(e),$('.choice-text').off('click').on('click',e=>{e.stopPropagation();const a=$(e.currentTarget).closest('.dialogue-choice-item'),n=parseInt(a.data('choice')),s=t[n-1];console.log('💭 添加选择到行动列表:',{number:n,text:s}),this.addChoiceToCommands(s)}),$('.choice-quick-send-btn').off('click').on('click',e=>{e.stopPropagation();const a=parseInt($(e.currentTarget).data('choice')),n=t[a-1];console.log('🚀 快速发送选择:',{number:a,text:n}),this.handleChoiceSelection(a-1,n)}),this.showChoiceInput()}executeCharacterAction(t,e){console.log('🎭 执行角色动作:',{targetCharacter:t,actionType:e});try{this.stageManager.executeCharacterAction(t,e)}catch(t){console.error('❌ 执行角色动作失败:',t)}}updateNavigationButtons(){const t=$('#prev-btn'),e=$('#next-btn');this.currentDialogueIndex<=0?t.prop('disabled',!0).addClass('disabled'):t.prop('disabled',!1).removeClass('disabled');const a=this.dialogueHistory[this.currentDialogueIndex],n=this.currentDialogueIndex>=this.dialogueHistory.length-1,s=a&&'choice'===a.type;n||s?(e.prop('disabled',!0).addClass('disabled').removeClass('choice-ready'),console.log('🚫 禁用Next按钮:',n?'已是最后对话':'当前是选择界面')):e.prop('disabled',!1).removeClass('disabled').removeClass('choice-ready')}async navigatePrevious(){return this.textAnimationManager.stopCurrentAnimation(),this.currentDialogueIndex>0&&(this.currentDialogueIndex--,await this.displayCurrentDialogue(),!0)}async navigateNext(){if(this.textAnimationManager.isPlaying())return this.textAnimationManager.skipAnimation(),!0;const t=this.dialogueHistory[this.currentDialogueIndex];return t&&'choice'===t.type?(console.log('🚫 当前是选择界面，禁止导航到下一条对话'),!1):this.currentDialogueIndex<this.dialogueHistory.length-1&&(this.currentDialogueIndex++,await this.displayCurrentDialogue(),!0)}getTextAnimationManager(){return this.textAnimationManager}getDialogueInfo(){const t=this.dialogueHistory[this.currentDialogueIndex],e=t&&'choice'===t.type;return{current:this.currentDialogueIndex+1,total:this.dialogueHistory.length,hasNext:!e&&this.currentDialogueIndex<this.dialogueHistory.length-1,hasPrev:this.currentDialogueIndex>0}}handleChoice(t){if(console.log('🎯 选择项:',t),$('.choice-container').remove(),window.skipChoiceDelay)return console.log('🔄 重新渲染模式，将选择项添加到历史但不显示'),void this.addToDialogueHistory({speaker:'选择',text:'请选择你的回应：',type:'choice',choices:t});this.addToDialogueHistory({speaker:'选择',text:'请选择你的回应：',type:'choice',choices:t,cgUrl:this.currentCG}),console.log('📋 选择项已添加到对话历史')}showChoiceInput(){const t=$('#player-choice-input');t.length>0&&(t.fadeIn(300),console.log('📝 显示选择输入框'),this.bindAddChoiceButton())}hideChoiceInput(){const t=$('#player-choice-input');t.length>0&&(t.fadeOut(300),console.log('📝 隐藏选择输入框'))}bindAddChoiceButton(){$('#add-choice-btn').off('click.addChoice').on('click.addChoice',t=>{t.preventDefault(),t.stopPropagation();const e=$('#choice-text-input'),a=e.val();a&&a.trim()?(console.log('💭 添加自定义选择到行动列表:',a.trim()),this.addChoiceToCommands(a.trim()),e.val(''),s().success('选择已添加到行动列表')):s().warning('请输入选择内容')})}addChoiceToCommands(t){try{this.uiController.getCommandManager().addChoiceCommand(t),console.log('💭 选择已添加到行动列表:',t)}catch(t){console.error('添加选择到行动列表失败:',t)}}async handleChoiceSelection(t,e){console.log('选择了:',e),$('.dialogue-choices').remove(),this.hideChoiceInput();try{await createChatMessages([{role:'user',message:e}]),triggerSlash('/trigger')}catch(t){console.error('发送选择失败:',t)}}addToDialogueHistory(t){if(this.dialogueHistory.push(t),this.dialogueHistory.length>this.MAX_DIALOGUE_HISTORY){const t=this.dialogueHistory.length-this.MAX_DIALOGUE_HISTORY;this.dialogueHistory.splice(0,t),this.currentDialogueIndex=Math.max(0,this.currentDialogueIndex-t),console.log(`📝 对话历史已清理，保留最新${this.MAX_DIALOGUE_HISTORY}条记录`)}}convertToNetworkUrl(t,e='other'){if(t.startsWith('http'))return t;let a=t.split('/').pop()||t;return a.includes('.')||(a+='background'===e?'.jpg':'.png'),'https://60997b0.webp.li/'+a}cleanup(){this.stageManager.cleanup(),console.log('LLMRP解析器资源已清理')}async destroy(){this.cleanup(),await this.stageManager.clearStage(),$('.choice-container').remove(),console.log('LLMRP解析器已销毁')}handleCGCommand(t){const e=this.convertToNetworkUrl(t,'cg');this.currentCG=e,console.log('🖼️ 记录CG状态:',e)}handleHideCG(){this.currentCG=null,console.log('🧹 记录隐藏CG')}showCG(t){const e=$('#cg-layer'),a=$('#cg-image');a.attr('src')!==t&&a.attr('src',t),e.addClass('active'),this.displayedCG=t,this.addCGHoverPreview(a,t),console.log('🖼️ 显示CG:',t)}addCGHoverPreview(t,e){t.off('click.cgPreview'),console.log('🔧 为CG图片添加点击预览功能:',e,t.length),t.on('click.cgPreview',t=>{t.preventDefault(),t.stopPropagation(),console.log('🖱️ 点击CG显示预览:',e),this.showCGPreview(e)}),t.on('mouseenter',()=>{console.log('🖱️ 鼠标进入CG区域')})}async showCGPreview(t){console.log('🖼️ 准备显示CG预览弹窗:',t);try{console.log('🚀 调用SillyTavern.callGenericPopup');const e=`<img src="${t}" style="max-width: 100%; height: auto;" alt="CG预览" />`,a=await SillyTavern.callGenericPopup(e,SillyTavern.POPUP_TYPE.DISPLAY,'🖼️ CG预览',{large:!0,wide:!0,okButton:!1,cancelButton:!1});return console.log('✅ CG预览弹窗显示成功:',a),setTimeout(()=>{this.adjustPopupForImage()},100),a}catch(e){return console.error('❌ 显示CG预览失败:',e),s().info(`CG预览：${t}`),null}}adjustPopupForImage(){try{const t=$('.popup');if(t.length>0){console.log('🔧 调整弹窗容器样式'),t.css({'max-width':'95vw','max-height':'95vh',width:'auto',height:'auto','aspect-ratio':'unset'});const e=t.find('.popup-content');e.length>0&&e.css({width:'auto',height:'auto','max-width':'100%','max-height':'100%','aspect-ratio':'unset',display:'flex','align-items':'center','justify-content':'center'});const a=t.find('img');a.length>0&&a.css({'max-width':'100%','max-height':'85vh',width:'auto',height:'auto','object-fit':'contain'})}}catch(t){console.warn('⚠️ 调整弹窗样式失败:',t)}}hideCG(){$('#cg-layer').removeClass('active'),this.displayedCG=null,console.log('🧹 隐藏CG')}async appendDialogueMemo(t){try{if(!t||!t.trim())return;const e=getVariables({type:'chat'}),a='玩家状态.回忆录',n=l().get(e,a),s=Array.isArray(n)?n.slice():[];s.push(t.trim()),l().set(e,a,s),await replaceVariables(e,{type:'chat'})}catch(t){console.warn('⚠️ 记录回忆录失败:',t)}}}class g{pendingCommands=[];commandIdCounter=0;onUIUpdateCallback;constructor(){}setUIUpdateCallback(t){this.onUIUpdateCallback=t}addTravelCommand(t,e){const a={id:'travel_'+this.commandIdCounter++,content:`{{user}}准备前往${e}`,type:'travel',timestamp:Date.now(),metadata:{targetLocation:e}};this.addCommand(a)}addChoiceCommand(t){const e={id:'choice_'+this.commandIdCounter++,content:t.trim(),type:'choice',timestamp:Date.now(),metadata:{originalInput:t}};this.addCommand(e)}addHummingbirdCommand(t,e){const a=`_.assign('角色.${t}.chatHistory[0]', { "sender": "{{user}}", "content": "${e.trim().replace(/"/g,'\\"').replace(/\n/g,'\\n')}" });`,n={id:'message_'+this.commandIdCounter++,content:a,type:'message',timestamp:Date.now(),metadata:{characterId:t,originalInput:e}};this.addCommand(n)}addCustomCommand(t){const e={id:'custom_'+this.commandIdCounter++,content:t.trim(),type:'custom',timestamp:Date.now()};this.addCommand(e)}addCommand(t){this.pendingCommands.push(t),this.updatePendingCommandsUI()}removeCommand(t){const e=this.pendingCommands.findIndex(e=>e.id===t);if(-1!==e){this.pendingCommands.splice(e,1)[0];this.updatePendingCommandsUI()}}clearAllCommands(){this.pendingCommands=[],this.updatePendingCommandsUI()}getPendingCommands(){return[...this.pendingCommands]}getCommandCount(){return this.pendingCommands.length}getFinalContent(){return 0===this.pendingCommands.length?'':this.pendingCommands.map(t=>t.content).join('\n')}sendAllCommands(){if(0===this.pendingCommands.length)return!1;const t=this.getFinalContent();try{const e=$('#send_textarea',window.parent.document);if(e.length>0)return e.val(t),this.showSendFeedback('行动已发送到酒馆',!0),this.clearAllCommands(),!0;{const e=$('#send_textarea');return e.length>0?(e.val(t),this.showSendFeedback('行动已发送',!0),this.clearAllCommands(),!0):navigator.clipboard?(navigator.clipboard.writeText(t).then(()=>{this.showSendFeedback('行动已复制到剪贴板',!0),this.clearAllCommands()}).catch(t=>{this.showSendFeedback('执行失败，请手动复制',!1)}),!0):(this.showSendFeedback('执行失败',!1),!1)}}catch(t){return console.error('执行行动时出错',t),this.showSendFeedback('执行出错',!1),!1}}updatePendingCommandsUI(){this.onUIUpdateCallback&&this.onUIUpdateCallback(this.pendingCommands),this.updateCommandBadge()}updateCommandBadge(){const t=this.pendingCommands.length,e=$('.nav-btn[data-view="commands"]');e.find('.command-badge').remove(),t>0&&e.append(`<div class="command-badge">${t}</div>`)}showSendFeedback(t,e){}}class m{dataManager;currentView='novel';currentSelectedContact=null;chatHistoryCache=new Map;unreadMessages=new Set;commandManager;constructor(t){this.dataManager=t,this.commandManager=new g,this.commandManager.setUIUpdateCallback(t=>{this.renderPendingCommandsUI(t)})}getCurrentView(){return this.currentView}getCommandManager(){return this.commandManager}updateUserInfo(){try{const t=SillyTavern.name1||'用户';$('#player-name').text(t),console.log('✅ 用户信息更新完成:',{userName:t}),console.log('🎭 用户头像将通过 user-avatar CSS 类自动设置')}catch(t){console.error('❌ 更新用户信息失败:',t),$('#player-name').text('用户')}}initialize(){this.renderInitialUI(),this.setupViewSwitching(),this.updateUserInfo(),console.log('UI控制器初始化完成')}renderInitialUI(){this.updateGameInfo(),this.updateCharacterDisplay(),this.updateDialogue(),this.renderMapData(),this.renderNewspaperContent()}updateGameInfo(){const t=this.dataManager.getMvuData('世界状态');if(t){const e=t=>Array.isArray(t)?t[0]:t,a=e(t.当前日期);a&&$('#current-date').text(a);const n=e(t.当前时间段);n&&$('#current-time-period').text(n);const s=e(t.当前地点);s&&$('#current-location').text(s)}const e=this.dataManager.getMvuData('玩家状态');if(e){const t=(t=>Array.isArray(t)?t[0]:t)(e.货币);t&&void 0!==t['里拉(R)']&&$('#player-money').text(`${t['里拉(R)'].toLocaleString()} R`)}}updateCharacterDisplay(){const t=this.dataManager.getCharacters();if(!t)return;const e=this.dataManager.getGameState();let a=e?.currentCharacter||null;if(!a){const t=$('#speaker-name').text();a=this.dataManager.findCharacterIdByName(t)}if(!a||!t[a])return;const n=t[a],s=Array.isArray(n.fullName)?n.fullName[0]:n.fullName,i=Array.isArray(n.affiliation)?n.affiliation[0]:n.affiliation,o=Array.isArray(n.race)?n.race[0]:n.race,r=Array.isArray(n.rank)?n.rank[0]:n.rank,c=Array.isArray(n.relationship_with_user)?n.relationship_with_user[0]:n.relationship_with_user,l=Array.isArray(n.favorability)?n.favorability[0]:n.favorability,d=Array.isArray(n.likes)?n.likes[0]:n.likes,h=Array.isArray(n.dislikes)?n.dislikes[0]:n.dislikes;$('#character-fullname').text(s||''),$('#character-affiliation').text(i||'');const g=$('#status-tooltip-body');g.empty(),o&&g.append(`\n        <div class="status-item">\n          <span class="status-label">种族</span>\n          <span class="status-value">${o}</span>\n        </div>\n      `),r&&g.append(`\n        <div class="status-item">\n          <span class="status-label">位阶</span>\n          <span class="status-value">${r}</span>\n        </div>\n      `),c&&g.append(`\n        <div class="status-item">\n          <span class="status-label">关系</span>\n          <span class="status-value relationship">${c}</span>\n        </div>\n      `),void 0!==l&&g.append(`\n        <div class="status-item">\n          <span class="status-label">好感度</span>\n          <div style="display: flex; align-items: baseline; gap: 8px;">\n            <div class="status-progress-bar">\n              <div class="progress-bar-fill" style="width: ${l}%;"></div>\n            </div>\n            <span class="status-value" style="min-width: 15px; text-align: right;">${l}</span>\n          </div>\n        </div>\n      `);const m=$('#status-tooltip-footer');if(m.empty(),d&&Array.isArray(d)&&d.length>0){const t=d.map(t=>`<span class="status-tag">${t}</span>`).join('');m.append(`\n        <div class="status-tags-container">\n          <span class="status-label">喜欢</span>\n          <div class="status-tags">${t}</div>\n        </div>\n      `)}if(h&&Array.isArray(h)&&h.length>0){const t=h.map(t=>`<span class="status-tag">${t}</span>`).join('');m.append(`\n        <div class="status-tags-container">\n          <span class="status-label">讨厌</span>\n          <div class="status-tags">${t}</div>\n        </div>\n      `)}}renderCharacterStatusTooltipByName(t){const e=this.dataManager.findCharacterIdByName(t)||t;this.renderCharacterStatusTooltipFor(e)}renderCharacterStatusTooltipFor(t){const e=this.dataManager.getCharacters();if(!e||!e[t])return $('#character-fullname').text(''),$('#character-affiliation').text(''),$('#status-tooltip-body').empty(),void $('#status-tooltip-footer').empty();const a=e[t],n=t=>Array.isArray(t)?t[0]:t,s=n(a.fullName)||t,i=n(a.affiliation)||'',o=n(a.race)||'',r=n(a.rank)||'',c=n(a.relationship_with_user)||'',l=n(a.favorability),d=n(a.likes)||[],h=n(a.dislikes)||[];$('#character-fullname').text(s),$('#character-affiliation').text(i);const g=$('#status-tooltip-body');g.empty(),o&&g.append(`\n        <div class="status-item">\n          <span class="status-label">种族</span>\n          <span class="status-value">${o}</span>\n        </div>\n      `),r&&g.append(`\n        <div class="status-item">\n          <span class="status-label">位阶</span>\n          <span class="status-value">${r}</span>\n        </div>\n      `),c&&g.append(`\n        <div class="status-item">\n          <span class="status-label">关系</span>\n          <span class="status-value relationship">${c}</span>\n        </div>\n      `),void 0!==l&&g.append(`\n        <div class="status-item">\n          <span class="status-label">好感度</span>\n          <div style="display: flex; align-items: baseline; gap: 8px;">\n            <div class="status-progress-bar">\n              <div class="progress-bar-fill" style="width: ${Number(l)||0}%;"></div>\n            </div>\n            <span class="status-value" style="min-width: 15px; text-align: right;">${Number(l)||0}</span>\n          </div>\n        </div>\n      `);const m=$('#status-tooltip-footer');if(m.empty(),Array.isArray(d)){const t=d.filter(t=>t&&'$__META_EXTENSIBLE__$'!==t);if(t.length>0){const e=t.map(t=>`<span class="status-tag">${t}</span>`).join('');m.append(`\n          <div class="status-tags-container">\n            <span class="status-label">喜欢</span>\n            <div class="status-tags">${e}</div>\n          </div>\n        `)}}if(Array.isArray(h)){const t=h.filter(t=>t&&'$__META_EXTENSIBLE__$'!==t);if(t.length>0){const e=t.map(t=>`<span class="status-tag">${t}</span>`).join('');m.append(`\n          <div class="status-tags-container">\n            <span class="status-label">讨厌</span>\n            <div class="status-tags">${e}</div>\n          </div>\n        `)}}}ensureCharacterTooltipHost(){let t=$('.character-status-tooltip').not('.hummingbird-tooltip').first();0===t.length&&(t=$('.character-layer .character-status-tooltip').first());const e=$('.ui-layer');return t.length&&e.length&&t.parent()[0]!==e[0]&&t.appendTo(e),t}positionCharacterTooltipNearElement(t){const e=this.ensureCharacterTooltipHost();if(0===e.length)return;e.addClass('active').css({left:0,top:0,transform:'none'});const a=e[0].getBoundingClientRect(),n=$('.ui-layer')[0];if(!n)return;const s=n.getBoundingClientRect(),i=t.getBoundingClientRect(),o=i.left+i.width/2,r=window.innerWidth,c=r/3,l=2*r/3;let d=0;if(1===$('.character-layer [data-character-id]').filter(':visible').length){const t=r-(i.right+.8*i.width),e=i.left-.8*i.width;d=t>100?.8*i.width:e>100?.8*-i.width:t>e?.7*i.width:.7*-i.width}else d=o<c?.7*i.width:o>l?.7*-i.width:.5*-i.width;const h=i.left-s.left+i.width/2+d,g=i.top-s.top+.15*i.height;let m=h-a.width/2,u=g-a.height-12;const p=s.width-a.width-8;m=Math.max(8,Math.min(p,m));const v=$('.top-header-container')[0],f=v?v.getBoundingClientRect().bottom-s.top:0,y=Math.max(8,f+8),b=s.height-a.height-8;u=Math.max(y,Math.min(b,u)),e.css({left:`${m}px`,top:`${u}px`,transform:'none'})}showCharacterTooltip(){this.ensureCharacterTooltipHost().addClass('active')}hideCharacterTooltip(){this.ensureCharacterTooltipHost().removeClass('active')}updateDialogue(){const t=$('#speaker-name').text(),e=$('#dialogue-content').text();t&&''!==t.trim()||$('#speaker-name').text(''),e&&''!==e.trim()||$('#dialogue-content').text('')}renderMapData(){console.log('🗺️ 开始渲染地图数据...');const t=this.dataManager.getMapData();if(console.log('📊 地图数据:',t),!t)return void console.warn('⚠️ 地图数据为空');const e=this.dataManager.getCurrentMapType();$('.sg-btn').removeClass('active'),$(`.sg-btn[data-map="${e}"]`).addClass('active'),console.log('🎯 更新地图按钮状态:',e);const a=t[e];console.log('🖼️ 当前地图数据:',a),console.log('🔗 地图图片URL:',a.image);const n=$('#map-image');console.log('🎯 地图图片元素:',n.length),n.off('load error').on('load',()=>{console.log('✅ 地图图片加载成功:',a.image)}).on('error',t=>{console.error('❌ 地图图片加载失败:',a.image,t)}),n.attr('src',a.image),$('.map-point').remove();const s=$('.map-canvas');console.log('📍 地图画布元素:',s.length),console.log('📍 地图点数量:',a.points.length),a.points.forEach((t,e)=>{console.log(`📍 创建地图点 ${e+1}:`,t);const a=$(`\n        <div class="map-point" data-point-id="${t.id}"\n             style="left: ${t.coords.x}%; top: ${t.coords.y}%;">\n        </div>\n      `);a.on('mouseenter',e=>{this.showMapTooltip(e,t)}),a.on('mouseleave',()=>{this.hideMapTooltip()}),a.on('click',()=>{this.commandManager.addTravelCommand(t.id,t.name),console.log(`🗺️ 点击地图点: ${t.name}`),a.addClass('clicked'),setTimeout(()=>{a.removeClass('clicked')},300)}),s.append(a)}),console.log('✅ 地图渲染完成')}showMapTooltip(t,e){const a=$('#map-tooltip');a.html(`\n      <h3>${e.name}</h3>\n      <p>${e.description}</p>\n    `);const n=t.target.getBoundingClientRect(),s=$('.map-canvas')[0].getBoundingClientRect();let i=n.left-s.left+n.width/2,o=n.top-s.top;a.addClass('active').css({left:0,top:0,transform:'none'});const r=a[0].getBoundingClientRect(),c=r.width,l=r.height;i-=c/2,o=o-l-12;const d=s.width-c-8,h=s.height-l-8;i=Math.max(8,Math.min(d,i)),o=Math.max(8,Math.min(h,o)),a.css({left:`${i}px`,top:`${o}px`,transform:'none'})}hideMapTooltip(){$('#map-tooltip').removeClass('active')}renderNewspaperContent(){console.log('🗞️ 开始渲染报纸内容'),$('#newspaper-shadow-image').attr('src','https://60997b0.webp.li/阴影层-报纸-树叶1.png'),$('#newspaper-bg-image').attr('src','https://60997b0.webp.li/报纸背景MockUp-5.png');const t=this.dataManager.getMvuData('世界状态');console.log('🌍 世界状态原始数据:',t);const e=t=>Array.isArray(t)?t[0]:t,a=t?.报纸;console.log('📰 报纸原始数据:',a);const n=e(a);if(console.log('📰 提取后的报纸数据对象:',n),!n||'object'!=typeof n)return console.warn('⚠️ 未找到报纸数据对象'),$('#main-headline').text('暂无报纸数据'),void $('#headline-subtitle').text('请检查MVU变量配置');console.log('🔍 报纸数据对象的所有键:',Object.keys(n)),console.log('🔍 报纸数据对象内容:',n);const s=e(n.报刊名)||'三界日报',i=e(n.头条标题)||'';console.log('📑 报刊名:',s),console.log('📰 头条标题:',i),console.log('🔍 头条配图原始值:',n.头条配图),console.log('🔍 头条内容原始值:',n.头条内容),console.log('🔍 次要新闻原始值:',n.次要新闻),console.log('🔍 公告栏原始值:',n.公告栏),$('#newspaper-name').text(s),$('#main-headline').text(i),$('#left-column').empty(),$('#right-column').empty();const o=n.头条配图;if(console.log('🖼️ 头条配图:',o),o&&Array.isArray(o)&&o.length>=2){const[t,e]=o;t&&$('#right-column').append(`\n          <div class="headline-image-section">\n            <div class="news-image-frame">\n              <img src="https://60997b0.webp.li/${t}" alt="头条配图" class="news-image" />\n              <p class="image-caption">${e||''}</p>\n            </div>\n          </div>\n        `)}const r=n.头条内容;console.log('📄 头条内容:',r),r&&$('#left-column').append(`\n        <div class="headline-content">\n          <p class="news-content">${r}</p>\n        </div>\n      `);const c=n.次要新闻;if(console.log('📋 次要新闻:',c),c&&Array.isArray(c)&&c.length>=2){const t=c[0],e=c[1];t&&e&&$('#left-column').append(`\n          <div class="secondary-news">\n            <h3 class="secondary-news-title">${t}</h3>\n            <p class="news-content">${e}</p>\n          </div>\n        `)}const l=n.公告栏;if(console.log('📢 公告栏:',l),l&&Array.isArray(l)&&l.length>0){$('#right-column').append(`\n        <div class="announcements-section">\n          <h3 class="news-title">${l[0]}</h3>\n        </div>\n      `);for(let t=1;t<l.length;t++){const e=l[t];e&&'string'==typeof e&&e.trim()&&$('#right-column').append(`\n            <p class="news-content announcement-item">${e}</p>\n          `)}}console.log('✅ 报纸内容渲染完成')}setupViewSwitching(){}switchView(t){console.log('🔄 切换视图到:',t),this.currentView=t;const e=$('#app-container'),a=$('#modal-container'),n=a.find('.view-container'),s=a.hasClass('active');if('novel'===t)return n.removeClass('active'),a.removeClass('active'),e.removeClass('modal-active'),void console.log('📱 显示主界面，取消背景模糊');switch(n.removeClass('active'),$(`#view-${t}`).addClass('active'),s?console.log('🎯 保持模态容器开启，仅切换内部视图'):requestAnimationFrame(()=>{a.addClass('active'),e.addClass('modal-active'),console.log('🎨 显示模态界面，激活背景模糊')}),t){case'status':this.renderStatusView();break;case'hummingbird':this.renderHummingbirdView();break;case'map':this.renderMapData();break;case'quests':this.renderQuestsView();break;case'newspaper':this.renderNewspaperContent();break;case'commands':this.renderPendingCommandsView();break;case'memoir':this.renderMemoirView()}}showStatToast(t){try{let e=$('#'+'stat-toast-container');0===e.length&&(e=$('<div id="stat-toast-container" class="stat-toast-container"></div>'),$('body').append(e));const a=t.delta>0?'+':'',n=t.delta>0?'gain':'loss';let s='fa-star';switch(t.type){case'favor':s='fa-heart';break;case'money':s='fa-coins';break;case'platinum':s='fa-gem';break;case'item':s='fa-box'}const i='item'===t.type?`+${t.delta}`:`${a}${Number(t.delta.toFixed(2))}`,o=$(`\n        <div class="stat-toast ${n}">\n          <i class="fas ${s}"></i>\n          <span class="label">${t.label}</span>\n          <span class="delta">${i}</span>\n        </div>\n      `);e.append(o),setTimeout(()=>o.addClass('show'),50);const r=e.children('.stat-toast');r.length>5&&r.first().remove(),setTimeout(()=>{o.removeClass('show'),setTimeout(()=>o.remove(),400)},2800)}catch(t){console.warn('showStatToast failed:',t)}}_currentMemoir=[];setCurrentMemoir(t){this._currentMemoir=Array.isArray(t)?t:[]}renderMemoirView(){try{const t=$('#view-memoir #event-list'),e=$('#view-memoir #event-details');t.empty(),e.empty();const a=this._currentMemoir||[];if(!a.length)return void t.html('<div class="empty-hint">暂无回忆</div>');const n=[];n.push('<ul class="memoir-list">');for(let t=0;t<a.length;t++){const e=a[t],s=e&&'object'==typeof e&&!Array.isArray(e),i=String(s?e.text??'':e??''),o=$('<div>').text(i).html().replace(/\n/g,'<br/>'),r=String(s?e.speaker??'':'').trim(),c=s?e.avatarUrl??null:null,l=r||'旁白',d=`<div class="memoir-speaker">${$('<div>').text(l).html()}</div>`,h=c?`<img class="memoir-avatar" src="${$('<div>').text(c).html()}" alt="avatar"/>`:'<div class="memoir-avatar default"><i class="fas fa-user-circle"></i></div>';n.push(`<li class="memoir-item">\n             ${h}\n             <div class="memoir-meta">\n               ${d}\n               <div class="memoir-text">${o}</div>\n             </div>\n           </li>`)}n.push('</ul>'),t.html(n.join(''))}catch(t){console.warn('渲染回忆录视图失败:',t),$('#view-memoir #event-list').html('<div class="empty-hint">无法加载回忆录</div>')}}renderStatusView(){this.updateUserInfo(),this.setupStatusTabs();const t=this.dataManager.getMvuData('玩家状态');if(!t)return;const e=t=>Array.isArray(t)?t[0]:t,a=e(t.基本属性),n=a?.rank;$('#status-rank').text(n||'—');const s=e(t.货币);s&&($('#player-lira').text(`${s['里拉(R)']?.toLocaleString()||0}`),$('#player-platinum').text(`${s['白金币']||0}`));const i=$('#status-skills');i.empty();const o=e(t.技能);if(console.log('🔍 技能原始数据:',t.技能),console.log('🔍 技能MVU提取后:',o),o&&Array.isArray(o)){const t=o.filter(t=>t&&'object'==typeof t&&'$__META_EXTENSIBLE__$'!==t&&t.name);console.log('🔍 过滤后的技能数据:',t),t.length>0?t.forEach(t=>{const e=t.name||'',a=t.effect||'';e.trim()&&i.append(`<li><strong>${e}</strong>${a?`<br/><small>${a}</small>`:''}</li>`)}):i.append('<li class="empty-state">暂无技能</li>')}else i.append('<li class="empty-state">暂无技能</li>');const r=$('#status-titles');r.empty();const c=e(t.称号);if(console.log('🔍 称号原始数据:',t.称号),console.log('🔍 称号MVU提取后:',c),c&&Array.isArray(c)){const t=c.filter(t=>t&&'object'==typeof t&&'$__META_EXTENSIBLE__$'!==t&&(t.name||t['名称']));console.log('🔍 过滤后的称号数据:',t),t.length>0?t.forEach(t=>{const e=(t.name??t['名称']??'').toString(),a=(t.description??t['详情']??'').toString();e.trim()&&r.append(`<li><strong>${e}</strong>${a?`<br/><small>${a}</small>`:''}</li>`)}):r.append('<li class="empty-state">暂无称号</li>')}else r.append('<li class="empty-state">暂无称号</li>');const l=$('#status-blessings');l.empty();const d=e(t.祝福);if(console.log('🔍 祝福原始数据:',t.祝福),console.log('🔍 祝福MVU提取后:',d),d&&Array.isArray(d)){const t=d.filter(t=>t&&'object'==typeof t&&'$__META_EXTENSIBLE__$'!==t&&t.name);console.log('🔍 过滤后的祝福数据:',t),t.length>0?t.forEach(t=>{const e=t.name||'',a=t.effect||'';e.trim()&&l.append(`<li><strong>${e}</strong>${a?`<br/><small>${a}</small>`:''}</li>`)}):l.append('<li class="empty-state">暂无祝福</li>')}else l.append('<li class="empty-state">暂无祝福</li>');const h=e(t.物品栏);if(h){const t=Object.keys(h).length;$('#inventory-count').text(`${t}`),this.updateEquipmentPreview(h)}this.renderInventoryTab(h)}setupStatusTabs(){$('.panel-tabs .tab-btn').off('click.status-tabs'),$('.panel-tabs .tab-btn').on('click.status-tabs',t=>{const e=$(t.currentTarget),a=e.data('tab');$('.panel-tabs .tab-btn').removeClass('active'),e.addClass('active'),$('.tab-content').removeClass('active'),$(`#tab-${a}`).addClass('active'),console.log(`切换到标签页: ${a}`)})}updateEquipmentPreview(t){const e=$('#equipment-preview');if(e.empty(),!t)return void e.append('\n        <div class="equipment-empty">\n          <i class="fas fa-shield-alt"></i>\n          <p>暂无装备</p>\n        </div>\n      ');const a=Object.entries(t).filter(([t,e])=>e.isEquipped);0===a.length?e.append('\n        <div class="equipment-empty">\n          <i class="fas fa-shield-alt"></i>\n          <p>暂无装备</p>\n        </div>\n      '):a.forEach(([t,a])=>{const n=this.getItemTypeIcon(a.type),s=$(`\n          <div class="equipment-item-detailed" data-item-id="${t}">\n            <div class="equipment-item-header">\n              <div class="equipment-item-icon">\n                <i class="${n}"></i>\n              </div>\n              <div class="equipment-item-main-info">\n                <div class="equipment-item-name">${t}</div>\n                <div class="equipment-item-type">${a.type}</div>\n              </div>\n              <div class="equipment-item-badge">装备中</div>\n            </div>\n            <div class="equipment-item-description">\n              ${a.description||'暂无描述'}\n            </div>\n          </div>\n        `);s.on('click',()=>{this.showItemDetails(a,t)}),e.append(s)})}renderInventoryTab(t){const e=$('#inventory-grid'),a=$('#inventory-total');if(e.empty(),!t)return a.text('0'),void e.append('\n        <div class="inventory-empty-message">\n          <i class="fas fa-box-open"></i>\n          <p>背包空空如也</p>\n        </div>\n      ');const n=Object.entries(t).filter(([t])=>'$meta'!==t);if(a.text(n.length.toString()),0===n.length)return void e.append('\n        <div class="inventory-empty-message">\n          <i class="fas fa-box-open"></i>\n          <p>背包空空如也</p>\n        </div>\n      ');this.sortInventoryItems(n).forEach(([t,a])=>{const n=this.getItemTypeIcon(a.type),s=$(`\n        <div class="inventory-item-slot" data-item-id="${t}">\n          <div class="item-icon">\n            <i class="${n}"></i>\n          </div>\n          <div class="item-name">${t}</div>\n          <div class="item-quantity">x${a.quantity||1}</div>\n          ${a.isEquipped?'<div class="equipped-badge">装备中</div>':''}\n        </div>\n      `);s.on('click',()=>{e.find('.inventory-item-slot').removeClass('selected'),s.addClass('selected'),this.showItemDetails(a,t)}),e.append(s)}),this.setupInventorySorting(t)}sortInventoryItems(t){const e=$('#inventory-sort-select').val(),a='asc'===($('#inventory-sort-order').attr('data-order')||'asc');return t.sort(([t,n],[s,i])=>{let o,r;switch(e){case'name':o=t.toLowerCase(),r=s.toLowerCase();break;case'type':o=(n.type||'').toLowerCase(),r=(i.type||'').toLowerCase();break;case'quantity':o=n.quantity||0,r=i.quantity||0;break;default:return 0}return o<r?a?-1:1:o>r?a?1:-1:0})}setupInventorySorting(t){$('#inventory-sort-select').off('change.inventory-sort'),$('#inventory-sort-order').off('click.inventory-sort'),$('#inventory-sort-select').on('change.inventory-sort',()=>{this.renderInventoryTab(t)}),$('#inventory-sort-order').on('click.inventory-sort',e=>{const a=$(e.currentTarget),n='asc'===(a.attr('data-order')||'asc')?'desc':'asc';a.attr('data-order',n);const s=a.find('i');'desc'===n?s.removeClass('fa-sort-amount-down').addClass('fa-sort-amount-up'):s.removeClass('fa-sort-amount-up').addClass('fa-sort-amount-down'),this.renderInventoryTab(t)})}showItemDetails(t,e){const a=$('#item-details-panel'),n=this.getItemTypeIcon(t.type),s=e;a.html(`\n      <div class="item-details">\n        <div class="item-details-header">\n          <div class="item-icon-large">\n            <i class="${n}"></i>\n          </div>\n          <div class="item-basic-info">\n            <h3 class="item-name">${s}</h3>\n            <p class="item-type">${t.type}</p>\n          </div>\n        </div>\n        <div class="item-details-body">\n          <div class="item-description">\n            <h4>描述</h4>\n            <p>${t.description||'暂无描述'}</p>\n          </div>\n          <div class="item-properties">\n            <h4>属性</h4>\n            <ul>\n              <li>数量: ${t.quantity||1}</li>\n              <li>状态: ${t.isEquipped?'已装备':'背包中'}</li>\n            </ul>\n          </div>\n\n          \x3c!-- 交互按钮区域 - 样式占位，防止未来UI抖动 --\x3e\n          <div class="item-detail-actions">\n            ${this.generateItemActionButtons(t,e)}\n          </div>\n        </div>\n      </div>\n    `),a.find('.gift-btn').off('click.gift').on('click.gift',()=>{this.showGiftDialog(e,t)});const i=t=>{this.showSendFeedback(t,!0),this.getCommandManager().addCustomCommand(t)};a.find('.equip-btn').off('click.equip').on('click.equip',()=>{i(`{{user}}装备了"${e}"`)}),a.find('.unequip-btn').off('click.unequip').on('click.unequip',()=>{i(`{{user}}卸下了"${e}"`)}),a.find('.use-btn').off('click.use').on('click.use',()=>{i(`{{user}}使用了"${e}"`)}),a.find('.discard-btn').off('click.discard').on('click.discard',()=>{const t=`\n          <div id="discard-dialog" class="modal-overlay">\n            <div class="gift-dialog-content">\n              <div class="gift-dialog-header">\n                <h3>丢弃物品</h3>\n                <button class="gift-dialog-close"><i class="fas fa-times"></i></button>\n              </div>\n              <div class="gift-dialog-body">\n                <p>确认要丢弃 <strong>${e}</strong> 吗？此操作仅作为行动计划，不会直接修改背包数据。</p>\n              </div>\n              <div class="gift-dialog-footer">\n                <button class="discard-confirm-btn primary-btn">确认丢弃</button>\n                <button class="gift-cancel-btn secondary-btn">取消</button>\n              </div>\n            </div>\n          </div>`;$('body').append(t);const a=$('#discard-dialog');a.find('.discard-confirm-btn').on('click',()=>{i(`{{user}}丢弃了"${e}"`),a.remove()}),a.find('.gift-cancel-btn, .gift-dialog-close').on('click',()=>a.remove()),a.on('click',t=>{t.target===a[0]&&a.remove()})})}showGiftDialog(t,e){const a=this.dataManager.getMvuData('角色');if(!a)return void this.showSendFeedback('未找到可赠送的角色',!1);const n=t=>Array.isArray(t)?t[0]:t,s=Object.entries(a).filter(([,t])=>{const e=n(t.nickname);return e&&e.trim()});if(0===s.length)return void this.showSendFeedback('没有可赠送的角色',!1);const i=`\n      <div id="gift-dialog" class="modal-overlay">\n        <div class="gift-dialog-content">\n          <div class="gift-dialog-header">\n            <h3>赠送物品</h3>\n            <button class="gift-dialog-close"><i class="fas fa-times"></i></button>\n          </div>\n          <div class="gift-dialog-body">\n            <div class="gift-item-info">\n              <div class="gift-item-icon">\n                <i class="${this.getItemTypeIcon(e.type)}"></i>\n              </div>\n              <div class="gift-item-details">\n                <h4>${t}</h4>\n                <p>数量: ${e.quantity||1}</p>\n              </div>\n            </div>\n            <div class="gift-recipient-selection">\n              <h4>选择接收者</h4>\n              <div class="gift-character-list">\n                ${s.map(([t,e])=>{const a=n(e.nickname)||t;return`\n                    <div class="gift-character-option" data-character-id="${t}">\n                      <div class="gift-character-avatar">\n                        <img src="${n(e.avatar)||''}" alt="${a}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNGNUY1RjUiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNSIgcj0iNiIgZmlsbD0iIzk5OTk5OSIvPgo8cGF0aCBkPSJNOCAzMmMwLTYuNjI3IDUuMzczLTEyIDEyLTEyczEyIDUuMzczIDEyIDEyIiBmaWxsPSIjOTk5OTk5Ii8+Cjwvc3ZnPgo='" />\n                      </div>\n                      <div class="gift-character-info">\n                        <div class="gift-character-name">${a}</div>\n                        <div class="gift-character-relationship">${n(e.relationship)||'未知'}</div>\n                      </div>\n                    </div>\n                  `}).join('')}\n              </div>\n            </div>\n          </div>\n          <div class="gift-dialog-footer">\n            <button class="gift-confirm-btn primary-btn" disabled>确认赠送</button>\n            <button class="gift-cancel-btn secondary-btn">取消</button>\n          </div>\n        </div>\n      </div>\n    `;$('body').append(i);const o=$('#gift-dialog');let r=null;o.find('.gift-character-option').on('click',function(){o.find('.gift-character-option').removeClass('selected'),$(this).addClass('selected'),r=$(this).data('character-id'),o.find('.gift-confirm-btn').prop('disabled',!1)}),o.find('.gift-confirm-btn').on('click',()=>{r&&(this.confirmGift(t,e,r),o.remove())}),o.find('.gift-cancel-btn, .gift-dialog-close').on('click',()=>{o.remove()}),o.on('click',t=>{t.target===o[0]&&o.remove()})}confirmGift(t,e,a){const n=this.dataManager.getMvuData('角色')[a],s=(i=n?.nickname,(Array.isArray(i)?i[0]:i)||a);var i;const o=`{{user}}将"${t}"赠送给了${s}`;this.commandManager.addCustomCommand(o),this.showSendFeedback(`已计划将"${t}"赠送给${s}`,!0),console.log(`🎁 添加赠送行动: ${t} -> ${s}`)}generateItemActionButtons(t,e){const a=t.type?.toLowerCase()||'',n=t.isEquipped||!1;let s='';!['消耗品','药水','食物'].some(t=>a.includes(t.toLowerCase()))&&(s+=n?`\n          <button class="item-action-btn unequip-btn" data-action="unequip" data-item-id="${e}" title="卸下物品">\n            <i class="fas fa-times-circle"></i>\n            <span>卸下</span>\n          </button>\n        `:`\n          <button class="item-action-btn equip-btn" data-action="equip" data-item-id="${e}" title="装备物品">\n            <i class="fas fa-check-circle"></i>\n            <span>装备</span>\n          </button>\n        `);return['消耗品','药水','食物','卷轴','材料'].some(t=>a.includes(t.toLowerCase()))&&(s+=`\n        <button class="item-action-btn use-btn" data-action="use" data-item-id="${e}" title="使用物品">\n          <i class="fas fa-magic"></i>\n          <span>使用</span>\n        </button>\n      `),s+=`\n      <button class="item-action-btn gift-btn" data-action="gift" data-item-id="${e}" title="赠送物品给其他角色">\n        <i class="fas fa-gift"></i>\n        <span>赠送</span>\n      </button>\n    `,s+=`\n      <button class="item-action-btn discard-btn" data-action="discard" data-item-id="${e}" title="丢弃物品">\n        <i class="fas fa-trash-alt"></i>\n        <span>丢弃</span>\n      </button>\n    `,s}getItemTypeIcon(t){const e={饰品:'fas fa-gem',服装:'fas fa-tshirt',杂物:'fas fa-box',武器:'fas fa-gavel',防具:'fas fa-shield-alt',道具:'fas fa-magic',装备:'fas fa-cog',消耗品:'fas fa-pills',材料:'fas fa-hammer',食物:'fas fa-apple-alt',书籍:'fas fa-book',钥匙:'fas fa-key',货币:'fas fa-coins',宝石:'fas fa-diamond',药水:'fas fa-flask',符文:'fas fa-scroll',工具:'fas fa-wrench',任务物品:'fas fa-star',项链:'fas fa-gem',戒指:'fas fa-ring',袋子:'fas fa-bag-shopping',背包:'fas fa-bag-shopping',卫衣:'fas fa-tshirt',衣服:'fas fa-tshirt',衣物:'fas fa-tshirt'};if(e[t])return e[t];const a=t.toLowerCase();for(const[t,n]of Object.entries(e))if(a.includes(t.toLowerCase())||t.toLowerCase().includes(a))return n;return t.includes('武器')||t.includes('剑')||t.includes('刀')||t.includes('弓')||t.includes('枪')?'fas fa-gavel':t.includes('防具')||t.includes('护甲')||t.includes('盔甲')||t.includes('甲')?'fas fa-shield-alt':t.includes('饰品')||t.includes('戒指')||t.includes('项链')||t.includes('耳环')?'fas fa-gem':t.includes('服装')||t.includes('衣')||t.includes('袍')||t.includes('裙')?'fas fa-tshirt':t.includes('食物')||t.includes('食品')||t.includes('水果')||t.includes('肉')?'fas fa-apple-alt':t.includes('药')||t.includes('药水')||t.includes('药剂')?'fas fa-flask':t.includes('书')||t.includes('卷轴')||t.includes('文献')?'fas fa-book':t.includes('工具')||t.includes('器具')?'fas fa-wrench':t.includes('材料')||t.includes('原料')?'fas fa-hammer':t.includes('宝石')||t.includes('珠宝')?'fas fa-diamond':t.includes('钱')||t.includes('币')||t.includes('货币')?'fas fa-coins':(console.warn(`未找到物品类型 "${t}" 的图标，使用默认图标`),'fas fa-cube')}renderHummingbirdView(){console.log('🐦 开始渲染蜂鸟通讯界面...');const t=this.dataManager.getMvuData('角色');if(!t)return console.warn('⚠️ 角色数据为空'),void this.renderEmptyHummingbirdView();this.initializeChatHistoryCache(t);const e=$('#contact-list');e.empty();const a=t=>Array.isArray(t)?t[0]:t;this.getSortedCharactersByActivity(t,a).forEach(({characterId:t,character:n})=>{const s=a(n.nickname)||t,i=a(n.relationship_with_user)||'朋友',o=this.dataManager.getCharacterAvatarUrl(t)||'',r=this.unreadMessages.has(t),c=$(`\n        <div class="contact-item" data-contact="${t}">\n          <div class="contact-avatar-container">\n            <img src="${o}" alt="${s}" class="contact-avatar" />\n            ${r?'<div class="unread-indicator">+1</div>':''}\n          </div>\n            <div>\n            <div class="contact-name">${s}</div>\n            <div class="contact-status">${i}</div>\n            </div>\n          </div>\n        `);c.find('.contact-avatar').on('error',function(){console.log(`📷 角色 ${s} 的头像加载失败，使用默认头像`),$(this).attr('src','data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNGNUY1RjUiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNSIgcj0iNiIgZmlsbD0iIzk5OTk5OSIvPgo8cGF0aCBkPSJNOCAzMmMwLTYuNjI3IDUuMzczLTEyIDEyLTEyczEyIDUuMzczIDEyIDEyIiBmaWxsPSIjOTk5OTk5Ii8+Cjwvc3ZnPgo='),$(this).css({'background-color':'var(--ui-bg-secondary)',border:'1px solid var(--ui-border-color)'})}),c.on('click',()=>{this.unreadMessages.delete(t),c.find('.unread-indicator').remove(),this.selectContact(t,n)}),c.on('mouseenter',e=>{this.showHummingbirdCharacterTooltip(e,t,n)}),c.on('mouseleave',()=>{this.hideHummingbirdCharacterTooltip()}),e.append(c)}),console.log('✅ 蜂鸟联系人列表渲染完成')}showHummingbirdCharacterTooltip(t,e,a){const n=$('#hummingbird-character-tooltip'),s=t=>Array.isArray(t)?t[0]:t,i=s(a.fullName)||e,o=s(a.affiliation)||'所属不明',r=s(a.race)||'未知',c=s(a.rank)||'未知',l=s(a.relationship_with_user)||'陌生人',d=s(a.favorability)||0,h=s(a.likes)||[],g=s(a.dislikes)||[];$('#hb-character-fullname').text(i),$('#hb-character-affiliation').text(o);const m=$('#hb-status-tooltip-body');if(m.empty(),r&&m.append(`\n        <div class="status-item">\n          <span class="status-label">种族</span>\n          <span class="status-value">${r}</span>\n        </div>\n      `),c&&m.append(`\n        <div class="status-item">\n          <span class="status-label">位阶</span>\n          <span class="status-value">${c}</span>\n        </div>\n      `),l&&m.append(`\n        <div class="status-item">\n          <span class="status-label">关系</span>\n          <span class="status-value relationship">${l}</span>\n        </div>\n      `),void 0!==d){const t=Number(d)||0,e=Math.max(0,Math.min(100,t));m.append(`\n        <div class="status-item">\n          <span class="status-label">好感度</span>\n          <div style="display: flex; align-items: baseline; gap: 8px;">\n            <div class="status-progress-bar">\n              <div class="progress-bar-fill" style="width: ${e}%;"></div>\n            </div>\n            <span class="status-value" style="min-width: 15px; text-align: right;">${t}</span>\n          </div>\n        </div>\n      `)}const u=$('#hb-status-tooltip-footer');if(u.empty(),h&&Array.isArray(h)&&h.length>0){const t=h.filter(t=>t&&'$__META_EXTENSIBLE__$'!==t);if(t.length>0){const e=t.map(t=>`<span class="status-tag">${t}</span>`).join('');u.append(`\n          <div class="status-tags-container">\n            <span class="status-label">喜欢</span>\n            <div class="status-tags">${e}</div>\n          </div>\n        `)}}if(g&&Array.isArray(g)&&g.length>0){const t=g.filter(t=>t&&'$__META_EXTENSIBLE__$'!==t);if(t.length>0){const e=t.map(t=>`<span class="status-tag">${t}</span>`).join('');u.append(`\n          <div class="status-tags-container">\n            <span class="status-label">讨厌</span>\n            <div class="status-tags">${e}</div>\n          </div>\n        `)}}const p=$(t.currentTarget)[0].getBoundingClientRect(),v=$('#view-hummingbird')[0].getBoundingClientRect();n.addClass('active').css({left:0,top:0,transform:'none'});const f=n[0].getBoundingClientRect(),y=f.width,b=f.height;let C=p.right-v.left+10,w=p.top-v.top;const M=C+y+10,I=v.width;M>I&&(C=p.left-v.left-y-10,C<10&&(C=I-y-10));const k=w+b,A=v.height;k>A-20&&(w=Math.max(20,A-b-20)),w<20&&(w=20),n.css({left:`${C}px`,top:`${w}px`,transform:'none'}),console.log(`💬 显示蜂鸟角色状态栏: ${i}`)}hideHummingbirdCharacterTooltip(){$('#hummingbird-character-tooltip').removeClass('active')}selectContact(t,e){$('.contact-item').removeClass('active'),$(`.contact-item[data-contact="${t}"]`).addClass('active'),this.currentSelectedContact={contactId:t,characterData:e},this.clearUnreadMessages(t,e),this.displayChatHistory(t,e),this.setupSendButton()}clearUnreadMessages(t,e){this.unreadMessages.delete(t),$(`.contact-item[data-contact="${t}"] .unread-badge`).remove();const a=(n=e.chatHistory,(Array.isArray(n)?n[0]:n)||[]);var n;this.chatHistoryCache.set(t,a.length),console.log(`🔄 已清零 ${t} 的未读计数，当前消息数：${a.length}`)}displayChatHistory(t,e){console.log(`💬 显示与 ${t} 的聊天记录`);const a=$('#chat-messages');a.empty();const n=t=>Array.isArray(t)?t[0]:t,s=(n(e.chatHistory)||[]).filter(t=>t&&'object'==typeof t&&'$__META_EXTENSIBLE__$'!==t&&t.sender);if(0===s.length)return void a.html(`\n        <div class="no-messages">\n          <div class="no-messages-icon">💌</div>\n          <h4>还没有聊天记录</h4>\n          <p>开始与${n(e.nickname)||t}的对话吧！</p>\n        </div>\n      `);s.forEach(s=>{const i=n(e.nickname)||t,o=n(e.fullName)||'',r=s.sender!==t&&s.sender!==i&&s.sender!==o,c=$(`\n        <div class="message ${r?'sent':'received'}">\n          ${s.content||s.text||''}\n        </div>\n      `);a.append(c)});const i=a[0];i&&(i.scrollTop=i.scrollHeight),console.log(`✅ 聊天记录显示完成，共 ${s.length} 条消息`)}initializeChatHistoryCache(t){Object.keys(t).forEach(e=>{if('$meta'===e||'template'===e)return;const a=t[e];var n;const s=(n=a.chatHistory,(Array.isArray(n)?n[0]:n)||[]).filter(t=>t&&'object'==typeof t&&'$__META_EXTENSIBLE__$'!==t&&t.sender).length;this.chatHistoryCache.set(e,s)})}getSortedCharactersByActivity(t,e){return Object.keys(t).filter(e=>'$meta'!==e&&'template'!==e&&t[e]).map(e=>({characterId:e,character:t[e]})).sort((t,a)=>{const n=e(t.character.chatHistory)||[],s=e(a.character.chatHistory)||[],i=n.filter(t=>t&&'object'==typeof t&&'$__META_EXTENSIBLE__$'!==t&&t.sender).length;return s.filter(t=>t&&'object'==typeof t&&'$__META_EXTENSIBLE__$'!==t&&t.sender).length-i})}checkForNewMessages(){if('hummingbird'!==this.currentView)return;const t=this.dataManager.getMvuData('角色');if(!t)return;const e=t=>Array.isArray(t)?t[0]:t;Object.keys(t).forEach(a=>{if('$meta'===a||'template'===a)return;const n=t[a],s=e(n.chatHistory)||[],i=s.filter(t=>t&&'object'==typeof t&&'$__META_EXTENSIBLE__$'!==t&&t.sender).length;if(i>(this.chatHistoryCache.get(a)||0)){console.log(`🆕 检测到角色 ${a} 有新消息`);const t=s[s.length-1];if(t&&'{{user}}'!==t.sender){const s=e(n.nickname)||a,i=e(n.fullName)||'';t.sender!==a&&t.sender!==s&&t.sender!==i||(this.unreadMessages.add(a),this.updateUnreadIndicator(a))}this.chatHistoryCache.set(a,i)}})}updateUnreadIndicator(t){const e=$(`.contact-item[data-contact="${t}"]`);if(0===e.find('.unread-indicator').length){e.find('.contact-avatar-container').append('<div class="unread-indicator">+1</div>'),setTimeout(()=>{e.find('.unread-indicator').addClass('pulse')},100)}}renderEmptyHummingbirdView(){const t=$('#contact-list'),e=$('#chat-messages');t.html('\n      <div class="no-contacts">\n        <div class="no-contacts-icon">🐦</div>\n        <h4>暂无联系人</h4>\n        <p>还没有角色数据可用</p>\n      </div>\n    '),e.html('\n      <div class="no-messages">\n        <div class="no-messages-icon">💭</div>\n        <h4>选择联系人</h4>\n        <p>选择左侧的联系人开始对话</p>\n      </div>\n    ')}setupSendButton(){$('.send-btn').off('click.hummingbird'),$('#message-input').off('keypress.hummingbird'),$('.send-btn').on('click.hummingbird',()=>{this.sendMessage()}),$('#message-input').on('keypress.hummingbird',t=>{13===t.which&&this.sendMessage()})}sendMessage(){const t=$('#message-input'),e=t.val();if(!e.trim())return void console.warn('消息内容不能为空');if(!this.currentSelectedContact)return void console.warn('请先选择一个联系人');const{contactId:a}=this.currentSelectedContact;this.commandManager.addHummingbirdCommand(a,e),t.val(''),this.showSendFeedback('已添加到行动计划'),console.log(`📱 蜂鸟消息已添加到行动列表: ${a} - ${e.substring(0,20)}...`)}showSendFeedback(t,e=!0){const a=$('.send-btn'),n=a.html();a.html(e?'✓':'✗'),a.css({'background-color':e?'#28a745':'#dc3545',color:'white',transform:'scale(1.1)'}),console.log(`💬 ${t}`),setTimeout(()=>{a.html(n),a.css({'background-color':'',color:'',transform:''})},2e3)}renderQuestsView(){console.log('🎯 开始渲染任务界面...'),this.setupQuestTabs(),this.showMainQuests(),console.log('✅ 任务界面渲染完成')}setupQuestTabs(){$('.quest-tabs .tab-btn').off('click.quest-tabs'),$('.quest-tabs .tab-btn').on('click.quest-tabs',t=>{const e=$(t.currentTarget),a=e.data('tab');switch($('.quest-tabs .tab-btn').removeClass('active'),e.addClass('active'),a){case'main':this.showMainQuests();break;case'side':this.showSideQuests();break;case'achievements':this.showAchievements()}console.log(`切换到标签页: ${a}`)})}showMainQuests(){const t=this.dataManager.getMvuData('世界状态');if(!t)return console.warn('⚠️ 世界状态数据为空'),void this.renderEmptyQuestsView();const e=(a=t.主线任务,Array.isArray(a)?a[0]:a);var a;if(!e||!Array.isArray(e))return console.warn('⚠️ 主线任务数据格式不正确'),void this.renderEmptyQuestsView();const n=e.filter(t=>t&&'object'==typeof t&&'$__META_EXTENSIBLE__$'!==t&&t.名称);if(0===n.length)return console.warn('⚠️ 没有可显示的任务'),void this.renderEmptyQuestsView();const s=[...n].reverse();this.renderQuestsList(s),this.renderActionSuggestions()}showSideQuests(){const t=$('#quest-list'),e=$('#quest-details');t.html('\n      <div class="empty-state">\n        <i class="fas fa-map-signs"></i>\n        <h3>支线任务</h3>\n        <p>暂无支线任务</p>\n      </div>\n    '),e.html('\n      <div class="no-suggestions">\n        <h4>支线探索</h4>\n        <p>支线任务功能开发中...</p>\n      </div>\n    ')}showAchievements(){const t=this.dataManager.getMvuData('世界状态'),e=(a=t?.已解锁成就,Array.isArray(a)?a[0]:a);var a;const n=$('#quest-list'),s=$('#quest-details');if(e&&Array.isArray(e)&&0!==e.length){const t=e.filter(t=>t&&'$__META_EXTENSIBLE__$'!==t).reverse();n.empty(),t.forEach((t,e)=>{const a=$(`\n          <div class="quest-item achievement-item" data-achievement-index="${e}">\n            <div class="quest-header">\n              <div class="quest-title">${t}</div>\n              <div class="quest-status quest-status-completed">\n                已获得\n              </div>\n            </div>\n          </div>\n        `);a.on('click',()=>{this.showAchievementDetails(t,e)}),n.append(a)}),t.length>0&&this.showAchievementDetails(t[0],0)}else n.html('\n        <div class="empty-state">\n          <i class="fas fa-trophy"></i>\n          <h3>暂无成就</h3>\n          <p>还没有解锁任何成就</p>\n        </div>\n      ');s.html('\n      <div class="no-suggestions">\n        <h4>解锁成就</h4>\n        <p>选择左侧成就查看详情</p>\n      </div>\n    ')}showAchievementDetails(t,e){$('.quest-item').removeClass('selected'),$(`.quest-item[data-achievement-index="${e}"]`).addClass('selected');$('#quest-details').html(`\n      <div class="action-suggestions-header">\n        <h3>${t}</h3>\n        <div class="suggestions-subtitle">成就已解锁</div>\n      </div>\n      <div class="action-suggestions-list">\n        <div class="action-suggestion-item">\n          <div class="suggestion-text">\n            恭喜您解锁了这个重要的里程碑！每个成就都代表着您在异世界冒险中的特殊经历。\n          </div>\n        </div>\n      </div>\n    `)}renderQuestsList(t){const e=$('#quest-list');e.empty(),t.forEach((t,a)=>{const n=0===a,s=n?'进行中':'已完成',i=n?'quest-status-current':'quest-status-completed',o=$(`\n        <div class="quest-item ${n?'quest-current':'quest-completed'}" data-quest-index="${a}">\n          <div class="quest-header">\n            <div class="quest-title">${t.名称||'未命名任务'}</div>\n            <div class="quest-status ${i}">\n              ${s}\n            </div>\n          </div>\n          <div class="quest-description">${t.详情||'暂无详情'}</div>\n        </div>\n      `);o.on('click',()=>{$('.quest-item').removeClass('selected'),$(`.quest-item[data-quest-index="${a}"]`).addClass('selected')}),e.append(o)}),t.length>0&&($('.quest-item').removeClass('selected'),$('.quest-item[data-quest-index="0"]').addClass('selected'))}renderActionSuggestions(){const t=this.dataManager.getMvuData('世界状态'),e=$('#quest-details');if(!t)return void e.html('\n        <div class="no-suggestions">\n\n          <h4>暂无行动建议</h4>\n          <p>当前没有可用的行动建议</p>\n        </div>\n      ');const a=t?.行动建议;if(!a)return void e.html('\n        <div class="no-suggestions">\n\n          <h4>暂无行动建议</h4>\n          <p>当前没有可用的行动建议</p>\n        </div>\n      ');const n=(s=a,Array.isArray(s)?s[0]:s);var s;if(!n||!Array.isArray(n)||0===n.length)return void e.html('\n        <div class="no-suggestions">\n\n          <h4>暂无行动建议</h4>\n          <p>当前没有可用的行动建议</p>\n        </div>\n      ');const i=n.map((t,e)=>`\n        <div class="action-suggestion-item" data-suggestion-index="${e}">\n          <div class="suggestion-text">${t}</div>\n        </div>\n      `).join('');e.html(`\n      <div class="action-suggestions-header">\n        <h3>行动建议</h3>\n        <div class="suggestions-subtitle">根据当前情况为您推荐的行动方案</div>\n      </div>\n      <div class="action-suggestions-list">\n        ${i}\n      </div>\n    `),$('.action-suggestion-item').on('click',function(){const t=$(this).find('.suggestion-text').text(),e=$(this).data('suggestion-index');console.log(`点击了行动建议 ${e+1}:`,t),$(this).addClass('clicked'),setTimeout(()=>{$(this).removeClass('clicked')},200)})}renderEmptyQuestsView(){const t=$('#quest-list'),e=$('#quest-details');t.html('\n      <div class="empty-state">\n        <i class="fas fa-tasks"></i>\n        <h3>暂无任务</h3>\n        <p>目前没有可显示的任务记录</p>\n      </div>\n    '),e.html('\n      <div class="no-quest-selected">\n        <i class="fas fa-info-circle"></i>\n        <p>选择左侧任务查看详情</p>\n      </div>\n    ')}updateUI(){switch(this.updateGameInfo(),this.updateCharacterDisplay(),this.updateDialogue(),this.currentView){case'status':this.renderStatusView();break;case'hummingbird':this.renderHummingbirdView();break;case'map':this.renderMapData();break;case'quests':this.renderQuestsView();break;case'newspaper':this.renderNewspaperContent()}}renderPendingCommandsView(){console.log('📋 开始渲染行动计划界面...');const t=this.commandManager.getPendingCommands();this.renderPendingCommandsUI(t)}renderPendingCommandsUI(t){const e=$('#pending-commands-list'),a=$('#commands-count'),n=$('#send-all-commands'),s=$('#clear-all-commands');if(a.text(t.length),e.empty(),0===t.length)return e.html('\n        <div class="no-commands">\n          <div class="no-commands-icon">📝</div>\n          <h4>暂无行动计划</h4>\n          <p>开始制定你的行动吧！</p>\n        </div>\n      '),n.prop('disabled',!0),void s.prop('disabled',!0);t.forEach(t=>{const a=this.getCommandTypeIcon(t.type),n=this.getCommandTypeLabel(t.type),s=new Date(t.timestamp).toLocaleTimeString(),i=$(`\n        <div class="command-item" data-command-id="${t.id}">\n          <div class="command-header">\n            <div class="command-type">\n              <i class="${a}"></i>\n              <span class="type-label">${n}</span>\n            </div>\n            <div class="command-time">${s}</div>\n            <button class="remove-command-btn" data-command-id="${t.id}">\n              <i class="fas fa-times"></i>\n            </button>\n          </div>\n          <div class="command-content">${this.escapeHtml(t.content)}</div>\n          ${t.metadata?.targetLocation?`\n            <div class="command-meta">\n              <i class="fas fa-map-marker-alt"></i>\n              目标地点: ${t.metadata.targetLocation}\n            </div>\n          `:''}\n          ${t.metadata?.characterId?`\n            <div class="command-meta">\n              <i class="fas fa-user"></i>\n              目标角色: ${t.metadata.characterId}\n            </div>\n          `:''}\n        </div>\n      `);e.append(i)}),n.prop('disabled',!1),s.prop('disabled',!1),e.off('click.removeCommand').on('click.removeCommand','.remove-command-btn',t=>{const e=$(t.currentTarget).data('command-id');this.commandManager.removeCommand(e)}),n.off('click.sendCommands').on('click.sendCommands',()=>{this.commandManager.sendAllCommands()}),s.off('click.clearCommands').on('click.clearCommands',()=>{this.commandManager.clearAllCommands()}),console.log(`✅ 行动计划界面渲染完成，共 ${t.length} 个行动`)}getCommandTypeIcon(t){switch(t){case'travel':return'fas fa-map-marker-alt';case'choice':return'fas fa-comment-dots';case'message':return'fas fa-envelope';case'custom':return'fas fa-code';default:return'fas fa-question'}}getCommandTypeLabel(t){switch(t){case'travel':return'前往';case'choice':return'选择';case'message':return'消息';case'custom':return'自定义';default:return'未知'}}escapeHtml(t){const e=document.createElement('div');return e.textContent=t,e.innerHTML}destroy(){$('.map-point').off(),$('.contact-item').off(),console.log('UI控制器已销毁')}}function u(t){return new Promise(e=>setTimeout(e,t))}let p=null,v=null,f=null,y=null,b=null;async function C(){try{console.log('异世界和平界面开始加载...'),function(){try{let t=localStorage.getItem('iswp_theme');if(!t){const e=document.cookie.match(/(?:^|; )iswp_theme=([^;]+)/);t=e?decodeURIComponent(e[1]):''}t||(t='dark'),$('body').attr('data-theme',t),$('.theme-btn').removeClass('active'),$(`.theme-btn[data-theme="${t}"]`).addClass('active')}catch(t){$('body').attr('data-theme','dark'),$('.theme-btn').removeClass('active'),$('.theme-btn[data-theme="dark"]').addClass('active')}}(),p=new o,await p.initialize(),v=new m(p),v.initialize(),window.enableBreathing=M,window.disableBreathing=I,f=new i(p,v),f.initialize(),y=new h(p,v),y.initialize(),f.setLLMRPParser(y),b=new e(p,v),b.initialize(),function(){let t=null,e=null;const a=setInterval(()=>{if(p&&v&&y)try{if('undefined'==typeof getCurrentMessageId||'undefined'==typeof getChatMessages)return;const a=getCurrentMessageId(),n=getChatMessages(a)[0];if(n&&n.message){const s=n.message||'';if(a===t&&s===e)return;v&&s.includes('<UpdateVariable>')&&async function(t,e){try{const a=t.match(/<UpdateVariable>([\s\S]*?)<\/UpdateVariable>/);if(!a)return;const n=a[1];console.log('🔍 Parsing <UpdateVariable> block for notifications...');const s=[],i=/_\.add\s*\(\s*'([^']*)'\s*,\s*([-\d\.]+)\s*\)/g;let o;for(;null!==(o=i.exec(n));){const t=o[1],e=parseFloat(o[2]);if(!isNaN(e)&&0!==e)if(t.includes('玩家状态.货币.里拉(R)'))s.push({type:'money',label:'里拉',delta:e});else if(t.includes('玩家状态.货币.白金币'))s.push({type:'platinum',label:'白金币',delta:e});else if(t.includes('.favorability[0]')){const a=t.match(/角色\.([^.]*)\.favorability/);if(a&&a[1]){const t=a[1];s.push({type:'favor',label:`${t} 好感度`,delta:e})}}}const r=/_\.assign\s*\(\s*'玩家状态\.物品栏'\s*,\s*'([^']*)'[^)]*\)/g;for(;null!==(o=r.exec(n));){const t=o[1];s.push({type:'item',label:t,delta:1})}for(const t of s)e.showStatToast(t),console.log(`✨ Notify: ${t.label} ${t.delta}`),await u(400)}catch(t){console.error('❌ Error parsing <UpdateVariable> for notifications:',t)}}(s,v),s.includes('<game_response>')&&(console.log('🎮 检测到新的LLMRP消息，开始解析...'),console.log('📝 消息ID:',a,'上次ID:',t),console.log('📝 消息内容:',s),t=a,e=s,(async()=>{try{await y.parseAndExecute(s),console.log('✅ LLMRP消息解析完成:',a)}catch(a){console.error('❌ LLMRP解析出错:',a),t=null,e=null}})());const i=p.parseGameCommand(n.message);i&&(p.executeGameCommand(i),v.updateUI())}}catch(t){}else clearInterval(a)},1e3);window.gameMessageInterval=a}(),console.log('异世界和平界面加载完成'),a.showStatus(),'undefined'!=typeof toastr&&toastr.success('异世界和平界面已加载','系统提示',{timeOut:3e3,positionClass:'toast-top-right'})}catch(e){console.error('异世界和平界面加载失败:',e),t='界面加载失败，请刷新页面重试','undefined'!=typeof toastr?toastr.error(t,'错误',{timeOut:5e3,positionClass:'toast-top-right'}):console.error(t)}var t}function w(){try{console.log('异世界和平界面开始卸载...'),b&&(b.destroy(),b=null),y&&(y.cleanup(),y.destroy().catch(console.error),y=null),f&&(f.destroy(),f=null),v&&(v.destroy(),v=null),p&&(p.destroy(),p=null),function(){window.gameMessageInterval&&(clearInterval(window.gameMessageInterval),delete window.gameMessageInterval);x(),$(window).off('pagehide.gameApp'),$(document).off('click.gameApp')}(),console.log('异世界和平界面卸载完成')}catch(t){console.error('异世界和平界面卸载时出错:',t)}}function M(){!function(){try{console.log('🫁 开始启用角色立绘呼吸效果...'),A(),function(){if('undefined'==typeof MutationObserver)return void console.warn('⚠️ 浏览器不支持MutationObserver，无法自动为新增角色添加呼吸效果');const t=new MutationObserver(t=>{let e=!1;t.forEach(t=>{t.addedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){const a=t;a.classList&&a.classList.contains('character-sprite')&&a.classList.contains('dynamic')&&(e=!0);$(a).find('.character-sprite.dynamic').length>0&&(e=!0)}})}),e&&setTimeout(()=>{(function(){try{const t=localStorage.getItem('iswp_breathing');if(null!==t)return'true'===t;const e=document.cookie.match(/(?:^|; )iswp_breathing=([^;]+)/);if(e)return'true'===e[1]}catch(t){console.warn('无法读取呼吸效果设置，使用默认值',t)}return!0})()&&A()},100)});t.observe(document.body,{childList:!0,subtree:!0}),window.characterBreathingObserver=t,console.log('👀 已设置角色立绘观察器，将自动为新增角色添加呼吸效果')}(),console.log('✅ 角色立绘呼吸效果已启用')}catch(t){console.error('❌ 启用角色立绘呼吸效果失败:',t)}}(),console.log('✅ 已启用角色立绘呼吸效果')}function I(){$('.character-sprite.dynamic').removeClass('breathing-natural breathing-sway breathing-pulse breathing-rhythmic'),x(),console.log('🚫 已禁用所有角色立绘呼吸效果')}function k(){return{gameDataManager:p,uiController:v,eventHandler:f,llmrpParser:y,dataBindingManager:b}}function A(){const t=$('.character-sprite.dynamic');console.log(`🎭 找到 ${t.length} 个角色立绘`),t.each(function(){const t=$(this);t.hasClass('breathing-natural')||(t.addClass('breathing-natural'),console.log('🫁 已为角色立绘添加自然真实呼吸效果:',t.attr('class')))})}function x(){window.characterBreathingObserver&&(window.characterBreathingObserver.disconnect(),delete window.characterBreathingObserver,console.log('🧹 已清理角色立绘呼吸效果观察器'))}$(()=>{C()}),$(window).on('pagehide',()=>{w()});</script><style>:root{--bg-gradient:#6262629e;--text-color:#f5f5f7;--primary-color:#0a84ff;--primary-color-light:rgba(10,132,255,0.2);--primary-color-lighter:rgba(10,132,255,0.3);--ui-bg:rgba(29,29,31,0.7);--ui-bg-heavy:rgba(29,29,31,0.85);--ui-border-color:rgba(255,255,255,0.1);--shadow-color-light:rgba(0,0,0,0.2);--shadow-color-medium:rgba(0,0,0,0.3);--blur-intensity:20px;--gold-color:#ffd700}[data-theme=light]{--bg-gradient:#6262629e;--text-color:#1d1d1f;--primary-color:#007aff;--primary-color-light:rgba(0,122,255,0.1);--primary-color-lighter:rgba(0,122,255,0.2);--ui-bg:rgba(255,255,255,0.8);--ui-bg-heavy:rgba(255,255,255,0.95);--ui-border-color:rgba(0,0,0,0.1);--shadow-color-light:rgba(0,0,0,0.1);--shadow-color-medium:rgba(0,0,0,0.15);--blur-intensity:20px;--gold-color:#d4af37}[data-theme=light] *{color:var(--text-color) !important}[data-theme=dark]{--bg-gradient:#6262629e;--text-color:#f5f5f7;--primary-color:#0a84ff;--primary-color-light:rgba(10,132,255,0.2);--primary-color-lighter:rgba(10,132,255,0.3);--ui-bg:rgba(29,29,31,0.7);--ui-bg-heavy:rgba(29,29,31,0.85);--ui-border-color:rgba(255,255,255,0.1);--shadow-color-light:rgba(0,0,0,0.2);--shadow-color-medium:rgba(0,0,0,0.3);--blur-intensity:20px;--gold-color:#ffd700}[data-theme=glass]{--bg-gradient:#6262629e;--text-color:#1d1d1f;--primary-color:#007aff;--primary-color-light:rgba(0,122,255,0.1);--primary-color-lighter:rgba(0,122,255,0.2);--ui-bg:rgba(255,255,255,0.3);--ui-bg-heavy:rgba(255,255,255,0.4);--ui-border-color:rgba(0,0,0,0.1);--shadow-color-light:rgba(0,0,0,0.1);--shadow-color-medium:rgba(0,0,0,0.15);--blur-intensity:30px;--gold-color:#d4af37}[data-theme=glass] *{color:var(--text-color) !important}*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg-gradient);color:var(--text-color);overflow:hidden;width:100%;aspect-ratio:16/9;transition:background .5s ease,color .5s ease}body[data-theme=dark]{--bg-gradient:#6262629e;--text-color:#f5f5f7;--primary-color:#0a84ff;--primary-color-light:rgba(10,132,255,0.2);--primary-color-lighter:rgba(10,132,255,0.3);--ui-bg:rgba(29,29,31,0.7);--ui-bg-heavy:rgba(29,29,31,0.85);--ui-border-color:rgba(255,255,255,0.1);--shadow-color-light:rgba(0,0,0,0.2);--shadow-color-medium:rgba(0,0,0,0.3);--gold-color:#ffd700}body[data-theme=glass]{--ui-bg:rgba(255,255,255,0.3);--ui-bg-heavy:rgba(255,255,255,0.4);--blur-intensity:30px}#app-container{display:flex;flex-direction:column;width:100%;height:100%;position:relative}#app-container.modal-active>#content-area{filter:blur(4px);transform:scale(0.98);transition:all .4s cubic-bezier(0.25,0.46,0.45,0.94)}.top-header-container{display:flex;justify-content:space-between;align-items:center;padding:20px;width:100%;gap:20px;pointer-events:auto}#main-nav{display:flex;align-items:center;gap:8px}.nav-btn{display:flex;align-items:center;padding:4px;margin:0;background:var(--ui-bg);border:1px solid rgba(0,0,0,0);border-radius:20px;cursor:pointer;transition:all .4s cubic-bezier(0.25,0.46,0.45,0.94);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);box-shadow:0 2px 8px var(--shadow-color-light)}.nav-btn:hover{background:var(--primary-color-light);border-color:var(--primary-color-lighter)}.nav-btn.active{background:var(--primary-color)}.nav-icon{width:32px;height:32px;background:rgba(0,0,0,0);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:none;transition:all .4s ease}.nav-icon i{font-size:16px;color:var(--text-color);transition:color .5s ease}.nav-btn.active .nav-icon i{color:#fff}.nav-text{font-size:14px;font-weight:500;color:var(--text-color);white-space:nowrap;max-width:0;opacity:0;overflow:hidden;transition:all .4s cubic-bezier(0.25,0.46,0.45,0.94);margin-left:0}.nav-btn:hover .nav-text,.nav-btn.active .nav-text{max-width:60px;opacity:1;margin-left:8px;margin-right:8px}.nav-btn.active .nav-text{color:#fff}.nav-btn.disabled,.nav-btn:disabled{opacity:.5;cursor:not-allowed;pointer-events:none}.nav-btn.disabled:hover,.nav-btn:disabled:hover{background:var(--ui-bg);border-color:var(--ui-border-color)}.nav-btn.disabled .nav-text,.nav-btn:disabled .nav-text{max-width:0;opacity:0;margin-left:0;margin-right:0}.nav-btn.active{background:var(--primary-color)}.nav-btn.active .nav-icon i{color:#fff}.nav-btn.active .nav-text{color:#fff}.nav-btn:hover .nav-text,.nav-btn.active .nav-text{max-width:60px;opacity:1;margin-left:8px;margin-right:8px}@media (max-width:768px){.nav-text{display:none}.nav-icon{margin-right:0}.nav-btn{min-width:36px;height:36px;padding:2px}}#content-area{flex:1;position:relative;overflow:hidden;transition:all .4s cubic-bezier(0.25,0.46,0.45,0.94)}.modal-view-container{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;z-index:100;opacity:0;visibility:hidden;transition:opacity .4s,visibility .4s;background-color:rgba(0,0,0,.3)}.modal-view-container.active{opacity:1;visibility:visible}.modal-content{width:90%;max-width:1200px;height:85%;max-height:800px;background:var(--ui-bg-heavy);backdrop-filter:blur(var(--blur-intensity));-webkit-backdrop-filter:blur(var(--blur-intensity));border-radius:24px;box-shadow:0 16px 64px var(--shadow-color-medium);border:1px solid var(--ui-border-color);transform:scale(0.95);transition:transform .4s cubic-bezier(0.25,0.46,0.45,0.94),background-color .5s ease,border-color .5s ease;position:relative;display:flex;flex-direction:column;min-height:0;overflow:hidden}.modal-view-container.active .modal-content{transform:scale(1)}.modal-close-btn{position:absolute;top:15px;right:15px;width:30px;height:30px;background:rgba(0,0,0,.1);border:none;border-radius:50%;color:var(--text-color);cursor:pointer;font-size:16px;z-index:110;display:flex;justify-content:center;align-items:center;transition:all .3s ease}.modal-close-btn:hover{background:rgba(0,0,0,.2);transform:rotate(90deg)}.view-container{width:100%;height:100%;opacity:0;visibility:hidden;transition:opacity .4s,visibility .4s;position:absolute;top:0;left:0}.view-container.active{opacity:1;visibility:visible}#view-novel.view-container{padding:0;position:static;display:flex;flex-direction:column}.modal-content .view-container{padding:20px;display:flex;flex-direction:column}.modal-header{padding:16px 24px;border-bottom:1px solid var(--ui-border-color);flex-shrink:0}.modal-header h2{font-size:18px;font-weight:600;text-align:center;margin-bottom:0}#view-quests .modal-header{display:flex;flex-direction:column;align-items:center;padding-bottom:8px}.modal-body{flex:1 1 auto;min-height:0;overflow:auto;padding:24px;display:flex;flex-direction:column;gap:16px}#view-newspaper .modal-body{overflow:hidden}.character-layer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;display:flex;justify-content:center;align-items:flex-end;padding-bottom:50px}.cg-layer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:4;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility .3s ease;pointer-events:none}.cg-layer .cg-image{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(0.85);max-width:min(92%,1200px);max-height:82%;width:auto;height:auto;object-fit:contain;border-radius:20px;background:var(--ui-bg-heavy);border:1px solid var(--ui-border-color);box-shadow:0 2px 8px var(--shadow-color-light);filter:blur(8px);transition:transform 600ms cubic-bezier(0.25,0.46,0.45,0.94),filter 400ms ease-out,box-shadow 200ms ease;pointer-events:auto;cursor:pointer;will-change:transform,filter}.cg-layer .cg-image:hover{box-shadow:0 4px 16px var(--shadow-color-light);filter:brightness(105%);transform:translate(-50%,-50%) scale(0.87)}.cg-layer .cg-image:active{transform:translate(-50%,-50%) scale(0.83)}.cg-layer.active{opacity:1;visibility:visible}.cg-layer.active .cg-image{transform:translate(-50%,-50%) scale(1);filter:blur(0)}.character-container{position:relative;display:flex;justify-content:center;align-items:flex-end;width:100%;height:120%;min-height:400px;margin-top:0%}#character-sprite.character-sprite,.character-sprite.old-sprite,#character-left,#character-right{display:none !important;visibility:hidden !important;opacity:0 !important;pointer-events:none !important}.character-sprite{position:absolute;bottom:-50%;height:100%;width:auto;filter:drop-shadow(0 10px 20px rgba(0,0,0,0.3));pointer-events:auto}.character-sprite.dynamic{transition:all .4s cubic-bezier(0.4,0,0.2,1);transform-origin:bottom center}.character-sprite.dynamic.pos-left{left:25%;z-index:3;transform:translateX(-50%) translateY(-30%)}.character-sprite.dynamic.pos-center{left:50%;z-index:4;transform:translateX(-50%) translateY(-30%)}.character-sprite.dynamic.pos-right{left:75%;z-index:3;transform:translateX(-50%) translateY(-30%)}.character-sprite.dynamic.pos-three-left{left:15%;z-index:3;transform:translateX(-50%) translateY(-30%)}.character-sprite.dynamic.pos-three-center{left:50%;z-index:4;transform:translateX(-50%) translateY(-30%)}.character-sprite.dynamic.pos-three-right{left:85%;z-index:3;transform:translateX(-50%) translateY(-30%)}.character-sprite.dynamic.entering{opacity:0}.character-sprite.dynamic.entering.pos-left{transform:translateX(-50%) translateY(50px);animation:enterFromBottomCenter .6s ease-out forwards}.character-sprite.dynamic.entering.pos-center{transform:translateX(-50%) translateY(50px);animation:enterFromBottomCenter .6s ease-out forwards}.character-sprite.dynamic.entering.pos-right{transform:translateX(-50%) translateY(50px);animation:enterFromBottomCenter .6s ease-out forwards}.character-sprite.dynamic.entering.pos-three-left{transform:translateX(-50%) translateY(50px);animation:enterFromBottomCenter .6s ease-out forwards}.character-sprite.dynamic.entering.pos-three-center{transform:translateX(-50%) translateY(50px);animation:enterFromBottomCenter .6s ease-out forwards}.character-sprite.dynamic.entering.pos-three-right{transform:translateX(-50%) translateY(50px);animation:enterFromBottomCenter .6s ease-out forwards}.character-sprite.dynamic.exiting{animation:fadeOut .4s ease-in forwards}.character-sprite.dynamic.sprite-changing{opacity:.3;transform:scale(0.98);transition:all .2s ease-out}.character-sprite.dynamic.dimmed{filter:brightness(0.5) grayscale(0.3);transition:filter .3s ease}.character-sprite:not(.dynamic){display:none !important;visibility:hidden !important;opacity:0 !important}.character-sprite:not(.dynamic):not([src=""]):not([src="#"]){display:none !important}@keyframes enterFromBottomCenter{from{opacity:0;transform:translateX(-50%) translateY(50px)}to{opacity:1;transform:translateX(-50%) translateY(-30%)}}@keyframes fadeOut{from{opacity:1}to{opacity:0}}.background-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;opacity:0;z-index:2;pointer-events:none;transition:opacity .5s ease}.ui-layer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;pointer-events:none}.top-bar{display:flex;justify-content:space-between;align-items:center;background:var(--ui-bg);backdrop-filter:blur(var(--blur-intensity));-webkit-backdrop-filter:blur(var(--blur-intensity));padding:12px 20px;border-radius:16px;box-shadow:0 4px 16px var(--shadow-color-light);transition:background-color .5s ease;flex-grow:1}.game-info{display:flex;align-items:center;gap:20px}.money-display{display:flex;align-items:center;gap:20px;font-weight:500;color:var(--text-color)}.money-item{display:flex;align-items:center;gap:8px}.game-date,.player-status,.game-location,.game-time-period{display:flex;align-items:center;gap:8px;font-weight:500;color:var(--text-color)}.money-display{display:flex;align-items:center;gap:20px;font-weight:500;color:var(--text-color)}.money-item{display:flex;align-items:center;gap:8px}.dialogue-box{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:calc(100% - 40px);max-width:1000px;z-index:5;background:var(--ui-bg-heavy);backdrop-filter:blur(var(--blur-intensity));-webkit-backdrop-filter:blur(var(--blur-intensity));border-radius:20px;padding:24px;transition:background-color .5s ease,border-color .5s ease;box-shadow:0 8px 32px var(--shadow-color-medium);border:1px solid var(--ui-border-color);pointer-events:auto}.character-name{font-size:16px;font-weight:600;color:var(--primary-color);margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--primary-color-light)}.dialogue-text{font-size:16px;line-height:1.6;color:var(--text-color);margin-bottom:16px}.dialogue-controls{display:flex;gap:12px;flex-shrink:0;margin-left:auto}.control-btn{width:36px;height:36px;border:none;background:rgba(0,0,0,0);color:var(--text-color);cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center}.control-btn:hover{color:var(--primary-color);transform:scale(1.2)}.control-btn:active{transform:scale(1)}.control-btn.disabled,.control-btn:disabled{color:var(--text-color-secondary);cursor:not-allowed;opacity:.5}.control-btn.disabled:hover,.control-btn:disabled:hover{color:var(--text-color-secondary);transform:none}.control-btn i{font-size:18px}.character-hover-trigger{display:none}.character-status-tooltip{position:absolute;left:25%;top:45%;transform:translate(-50%,-50%);width:-moz-fit-content;width:fit-content;min-width:200px;max-width:min(320px,100vw - 40px);padding:18px;background:var(--ui-bg);backdrop-filter:blur(var(--blur-intensity));-webkit-backdrop-filter:blur(var(--blur-intensity));border-radius:20px;box-shadow:0 8px 32px var(--shadow-color-medium);border:1px solid var(--ui-border-color);opacity:0;visibility:hidden;z-index:15;pointer-events:none;transition:all .4s cubic-bezier(0.25,0.46,0.45,0.94);text-align:left}@media (max-width:768px){.character-status-tooltip{left:50%;min-width:180px;max-width:calc(100vw - 40px);padding:14px;font-size:14px}}.character-hover-trigger:hover~.character-status-tooltip,.character-sprite:hover~.character-status-tooltip{opacity:1;visibility:visible;transform:translate(-50%,-50%)}.character-status-tooltip.active{opacity:1;visibility:visible}.hummingbird-tooltip{position:absolute;z-index:200;pointer-events:none;opacity:0;visibility:hidden;transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94)}.hummingbird-tooltip.active{opacity:1;visibility:visible}.status-tooltip-header{text-align:left;padding-bottom:12px}.character-fullname{font-size:20px;font-weight:700;color:var(--text-color);margin:0}@media (max-width:768px){.character-fullname{font-size:18px}}.character-affiliation{font-size:14px;color:var(--text-color);opacity:.8;font-weight:500;margin:4px 0 0 0}@media (max-width:768px){.character-affiliation{font-size:12px}}.status-tooltip-divider{height:1px;background:var(--ui-border-color);margin:0}.status-tooltip-body{padding:12px 0;display:flex;flex-direction:column;gap:8px}.status-item{display:flex;justify-content:space-between;font-size:14px;align-items:center;min-width:0;gap:8px}.status-label{color:var(--text-color);opacity:.8;font-weight:500;min-width:50px;flex-shrink:0}.status-value{color:var(--text-color);font-weight:600;text-align:right;min-width:0}.status-value.relationship{color:var(--text-color);font-weight:600}.status-progress-bar{width:80px;height:8px;background-color:rgba(120,120,128,.2);border-radius:4px;overflow:hidden;align-self:baseline;flex-shrink:0}.progress-bar-fill{height:100%;background-color:var(--primary-color);border-radius:4px;transition:width .5s ease-in-out}.status-tooltip-footer{padding-top:12px;display:flex;flex-direction:column;gap:10px}.status-tooltip-footer .status-value{font-variant-emoji:text}.status-tooltip-footer .status-value[data-emoji=true]{position:relative}.status-tooltip-footer .status-value[data-emoji=true]::before{content:"•";color:var(--text-color);opacity:.6;margin-right:6px;font-weight:400}.status-tags-container{display:flex;align-items:flex-start;gap:8px}.status-tags{display:flex;flex-wrap:wrap;gap:4px;justify-content:flex-start}.status-tag{background:var(--primary-color);color:#fff;font-size:12px;padding:4px 8px;border-radius:8px;font-weight:500;text-align:center;white-space:nowrap;display:inline-block;width:auto}@media (max-width:768px){.status-tag{font-size:11px;padding:3px 6px}}.map-controls{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:10}.segmented-control{display:flex;background:var(--ui-bg);border-radius:20px;padding:4px;box-shadow:0 4px 16px var(--shadow-color-light);backdrop-filter:blur(var(--blur-intensity));-webkit-backdrop-filter:blur(var(--blur-intensity))}.sg-btn{padding:8px 16px;border:1px solid var(--ui-border-color);background:var(--ui-bg);color:var(--text-color);border-radius:16px;cursor:pointer;transition:all .3s ease;font-weight:500;font-size:14px}.sg-btn.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}.sg-btn:hover:not(.active){background:var(--ui-bg-heavy);border-color:var(--primary-color-light)}.map-canvas{position:relative;width:100%;height:100%;display:flex;justify-content:center;align-items:center}.map-image{max-width:100%;max-height:100%;object-fit:contain;border-radius:16px}.map-point{position:absolute;width:20px;height:20px;border-radius:50%;cursor:pointer;background:linear-gradient(135deg,var(--primary-color),var(--primary-color-light));transform:translate(-50%,-50%);transition:all .4s cubic-bezier(0.25,0.46,0.45,0.94);box-shadow:0 4px 12px rgba(var(--primary-color-rgb),0.3);border:2px solid hsla(0,0%,100%,.9)}.map-point::before{content:"";width:8px;height:8px;background:hsla(0,0%,100%,.95);border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);box-shadow:0 0 8px hsla(0,0%,100%,.6);transition:all .3s ease}.map-point::after{content:"";position:absolute;width:160%;height:160%;border-radius:50%;background:radial-gradient(circle,var(--primary-color) 0%,transparent 70%);animation:mapPointPulse 2s infinite cubic-bezier(0.25,0.46,0.45,0.94);opacity:.6;left:50%;top:50%;transform:translate(-50%,-50%) scale(0.3);z-index:-1}.map-point:hover{transform:translate(-50%,-50%) scale(1.3);box-shadow:0 6px 20px rgba(var(--primary-color-rgb),0.5)}.map-point:hover::before{background:var(--primary-color);box-shadow:0 0 12px hsla(0,0%,100%,.8);transform:translate(-50%,-50%) scale(1.2)}.map-point:hover::after{animation-duration:1s;opacity:.8}.map-point:active{transform:translate(-50%,-50%) scale(1.1)}@keyframes mapPointPulse{0%{transform:translate(-50%,-50%) scale(0.3);opacity:0}50%{transform:translate(-50%,-50%) scale(1);opacity:.6}100%{transform:translate(-50%,-50%) scale(1.6);opacity:0}}#map-tooltip{position:absolute;background:var(--ui-bg);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px var(--shadow-color-medium);border:1px solid var(--ui-border-color);opacity:0;visibility:hidden;transform:translate(-50%,-120%);transition:all .3s ease;z-index:20;max-width:250px}#map-tooltip.active{opacity:1;visibility:visible;transform:translate(-50%,-140%)}#map-tooltip h3{margin:0 0 8px 0;font-size:16px;color:var(--primary-color);font-weight:600;border-bottom:1px solid var(--primary-color-light);padding-bottom:4px}#map-tooltip p{margin:0;font-size:14px;line-height:1.5}.newspaper-container{width:100%;height:100%;display:flex;justify-content:center;align-items:center;padding:20px;perspective:1000px}.newspaper-background{position:relative;width:90%;max-width:800px;height:auto;transform-style:preserve-3d;filter:sepia(15%) contrast(1.05) brightness(0.98) saturate(0.85);transition:filter .3s ease}.newspaper-background:hover{filter:sepia(8%) contrast(1.02) brightness(1) saturate(0.9)}.newspaper-background::before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;z-index:3;pointer-events:none;opacity:.15;background-image:radial-gradient(circle at 20% 50%,transparent 20%,rgba(120,119,109,0.3) 21%,rgba(120,119,109,0.3) 34%,transparent 35%),linear-gradient(0deg,rgba(0,0,0,0.1) 50%,transparent 50%);background-size:3px 3px,2px 2px;mix-blend-mode:multiply}.newspaper-bg-image{width:100%;height:auto;display:block;border-radius:6px;box-shadow:0 12px 24px rgba(0,0,0,.2)}.newspaper-shadow-image{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;border-radius:6px}.newspaper-content{position:absolute;top:0;left:0;width:100%;height:100%;padding:8% 10% 12% 8%;transform:translateX(-2px) translateY(-13px) rotateX(-52deg) rotateY(2deg) rotateZ(-15deg) scale(0.85);z-index:1;color:#2a2a2a;font-family:"Times New Roman",serif;text-shadow:.3px .3px .5px rgba(0,0,0,.08)}.newspaper-headline{margin-bottom:5%;text-align:center}.main-headline{font-size:2em;font-weight:bold;margin:0 0 1% 0;color:#1a1a1a;text-shadow:none;line-height:1.1}.headline-subtitle{font-size:1em;margin:0;color:#555;font-style:italic}.newspaper-main-news{display:flex;gap:4%;margin-bottom:6%}.news-column{flex:1}.news-column.left-column{flex:1.2}.news-column.right-column{flex:.8}.news-title{font-size:1em;font-weight:bold;margin:0 0 2% 0;color:#1a1a1a;border-bottom:1px solid #555;padding-bottom:1%}.news-content{font-size:.85em;line-height:1.35;margin-bottom:3%;text-align:justify;color:#2a2a2a}.news-image-frame{margin-bottom:3%;text-align:center;position:relative}.news-image-frame::before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;opacity:.08;background-image:radial-gradient(circle at 30% 60%,transparent 70%,rgba(120,119,109,0.35) 71%,transparent 72%),linear-gradient(90deg,rgba(0,0,0,0.08) 50%,transparent 50%);background-size:2px 2px,3px 3px;mix-blend-mode:multiply}.news-image{width:100%;max-width:200px;height:auto;max-height:180px;border:1px solid #666;border-radius:3px;object-fit:contain;object-position:center;filter:saturate(0.55) sepia(0.12) contrast(1.08) brightness(0.98)}.news-image::after{content:attr(data-caption);position:absolute;bottom:5px;left:50%;transform:translateX(-50%);background:hsla(0,0%,100%,.9);color:#444;font-size:.7em;font-style:italic;padding:2px 6px;border-radius:2px;max-width:calc(100% - 12px);text-align:center;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.headline-content{margin-bottom:3%;padding:1.5%;border-top:1px solid #555}.headline-content .news-content{font-size:1.2em;line-height:1.4;margin:0;color:#000;text-align:justify}.secondary-news{margin-bottom:3%;padding:1.5%;border-left:2px solid #666}.secondary-news .secondary-news-title{font-size:1.2em;font-weight:bold;color:#1a1a1a;margin:0px 0 1% 0;line-height:2.2}.secondary-news .news-content{font-size:1.2em;line-height:1.35;margin:0;color:#2a2a2a;text-align:justify}.secondary-news:last-child{margin-bottom:0}.headline-image-section{margin-bottom:3%;text-align:center;position:relative}.headline-image-section .news-image{max-width:100%;max-height:220px;object-fit:contain;object-position:center;border:1px solid #666;border-radius:3px;filter:saturate(0.55) sepia(0.12) contrast(1.08) brightness(0.98)}.headline-image-section .news-image::after{content:attr(data-caption);position:absolute;bottom:8px;left:50%;transform:translateX(-50%);background:hsla(0,0%,100%,.95);color:#444;font-size:.65em;font-style:italic;padding:3px 8px;border-radius:2px;max-width:calc(100% - 20px);text-align:center;line-height:1.2}.announcements-section{margin-top:2%}.announcements-section .news-title{font-size:1em;font-weight:bold;color:#1a1a1a;margin:0;padding:0;border:none;display:inline}.announcement-item{display:inline;margin:0 0 0 8px;font-size:.85em;line-height:1.35;color:#2a2a2a;text-align:justify}.newspaper-header{text-align:center;margin-bottom:3%;padding-bottom:1.5%;border-bottom:2px solid #555}.newspaper-header .newspaper-name{font-size:1.6em;font-weight:bold;color:#1a1a1a;margin:0 0 1% 0;font-family:serif}.newspaper-header .newspaper-date{font-size:.75em;color:#555;font-style:italic}.weather-section{font-size:.8em;line-height:1.3;padding:1.5%;border:1px solid #666;border-radius:3px;margin-bottom:2%}.weather-section p{margin:.5% 0;color:#2a2a2a}.newspaper-ads{display:flex;gap:2%;border-top:1px solid #555;padding-top:2%}.newspaper-ads .ad-item{flex:1;text-align:center;padding:1%;border:1px solid #666;border-radius:2px}.newspaper-ads .ad-item h4{font-size:.8em;margin:0 0 1% 0;font-weight:bold;color:#1a1a1a}.newspaper-ads .ad-item p{font-size:.7em;margin:0;color:#2a2a2a}@media (max-width:768px){.newspaper-background{transform:none}.newspaper-main-news{flex-direction:column;gap:4%}.newspaper-ads{flex-direction:column;gap:3%}.newspaper-content{padding:6% 8% 10% 6%}}.modal-view-container.newspaper-mode .newspaper-container{transform:scale(1.15)}.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;color:var(--text-color);opacity:.6;text-align:center}.empty-state i{font-size:48px;margin-bottom:16px;color:var(--primary-color)}.empty-state p{font-size:16px;margin:0}.settings-popover{position:absolute;top:60px;right:20px;background:var(--ui-bg-heavy);backdrop-filter:blur(var(--blur-intensity));-webkit-backdrop-filter:blur(var(--blur-intensity));border-radius:16px;padding:20px;box-shadow:0 8px 32px var(--shadow-color-medium);border:1px solid var(--ui-border-color);opacity:0;visibility:hidden;transform:translateY(-10px) scale(0.95);transition:all .3s cubic-bezier(0.25,0.46,0.45,0.94);z-index:1000;min-width:200px;max-width:calc(100vw - 40px);max-height:calc(100vh - 100px);overflow-y:auto}.settings-popover::-webkit-scrollbar{display:none}.settings-popover{scrollbar-width:none;-ms-overflow-style:none}.settings-popover.active{opacity:1;visibility:visible;transform:translateY(0) scale(1)}@media (max-width:768px){.settings-popover{position:fixed;top:50%;left:50%;right:auto;transform:translate(-50%,-50%) scale(0.95);width:calc(100vw - 40px);max-width:400px;max-height:calc(100vh - 80px)}.settings-popover.active{transform:translate(-50%,-50%) scale(1)}}@media (max-width:480px){.settings-popover{width:calc(100vw - 20px);padding:16px;border-radius:12px;max-height:calc(100vh - 60px)}}.settings-section{margin-bottom:16px}.settings-section:last-child{margin-bottom:0}.settings-section label{display:block;font-size:14px;font-weight:600;color:var(--text-color);margin-bottom:8px}.theme-buttons-container{display:flex;gap:8px}.theme-btn{width:40px;height:40px;border:2px solid var(--ui-border-color);border-radius:50%;background:var(--ui-bg);color:var(--text-color);cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;font-size:16px}.theme-btn:hover{border-color:var(--primary-color);transform:scale(1.1)}.theme-btn.active{border-color:var(--primary-color);background:var(--primary-color);color:#fff}.visual-effects-section .section-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}.visual-effects-section .section-header i{color:var(--primary-color);font-size:14px}.visual-effects-section .section-header .section-title{font-size:14px;font-weight:600;color:var(--text-color);margin:0}.visual-effects-section .settings-options{display:flex;flex-direction:column;gap:12px}.visual-effects-section .setting-item{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--ui-bg);border:1px solid var(--ui-border-color);border-radius:8px;transition:all .3s ease}.visual-effects-section .setting-item:hover:not(.disabled){background:var(--ui-bg-light);border-color:var(--primary-color-light)}.visual-effects-section .setting-item.disabled{opacity:.5;cursor:not-allowed}@media (max-width:480px){.visual-effects-section .setting-item{flex-direction:column;align-items:flex-start;gap:8px;padding:10px}.visual-effects-section .setting-item .setting-control{width:100%;display:flex;justify-content:flex-end}}.visual-effects-section .setting-item .setting-info{flex:1}.visual-effects-section .setting-item .setting-info .setting-name{font-size:13px;font-weight:500;color:var(--text-color);margin-bottom:2px}.visual-effects-section .setting-item .setting-info .setting-description{font-size:11px;color:var(--text-color);opacity:.7;line-height:1.3}.visual-effects-section .setting-item .setting-control .toggle-switch{position:relative;width:44px;height:24px;background:var(--ui-bg-heavy);border:1px solid var(--ui-border-color);border-radius:12px;cursor:pointer;transition:all .3s ease}.visual-effects-section .setting-item .setting-control .toggle-switch::before{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;background:var(--text-color);border-radius:50%;transition:all .3s ease;opacity:.6}.visual-effects-section .setting-item .setting-control .toggle-switch.active{background:var(--primary-color);border-color:var(--primary-color)}.visual-effects-section .setting-item .setting-control .toggle-switch.active::before{left:22px;background:#fff;opacity:1}.visual-effects-section .setting-item .setting-control .modern-toggle{position:relative;display:flex;align-items:center;cursor:pointer;-webkit-user-select:none;user-select:none}.visual-effects-section .setting-item .setting-control .modern-toggle input[type=checkbox]{display:none}.visual-effects-section .setting-item .setting-control .modern-toggle .toggle-track{position:relative;width:52px;height:28px;background:var(--ui-bg-heavy);border:2px solid var(--ui-border-color);border-radius:14px;transition:all .3s cubic-bezier(0.4,0,0.2,1);cursor:pointer}.visual-effects-section .setting-item .setting-control .modern-toggle .toggle-track .toggle-thumb{position:absolute;top:2px;left:2px;width:20px;height:20px;background:var(--text-color);border-radius:50%;transition:all .3s cubic-bezier(0.4,0,0.2,1);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,.1)}.visual-effects-section .setting-item .setting-control .modern-toggle .toggle-track .toggle-thumb .toggle-icon{font-size:10px;color:var(--ui-bg-heavy);opacity:0;transition:opacity .2s ease}.visual-effects-section .setting-item .setting-control .modern-toggle input[type=checkbox]:checked+.toggle-track{background:var(--primary-color);border-color:var(--primary-color)}.visual-effects-section .setting-item .setting-control .modern-toggle input[type=checkbox]:checked+.toggle-track .toggle-thumb{left:26px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.2)}.visual-effects-section .setting-item .setting-control .modern-toggle input[type=checkbox]:checked+.toggle-track .toggle-thumb .toggle-icon{opacity:1;color:var(--primary-color)}.visual-effects-section .setting-item .setting-control .modern-toggle.disabled{opacity:.5;cursor:not-allowed}.visual-effects-section .setting-item .setting-control .modern-toggle.disabled .toggle-track{cursor:not-allowed}.visual-effects-section .setting-item .setting-control .modern-toggle:not(.disabled):hover .toggle-track{box-shadow:0 0 0 4px rgba(var(--primary-color-rgb),0.1)}.visual-effects-section .setting-item .setting-control input[type=checkbox]{display:none}.panel-tabs{display:flex;gap:8px;margin-left:auto}.tab-btn{padding:8px 16px;border:none;background:rgba(0,0,0,0);color:var(--text-color);border-radius:12px;cursor:pointer;transition:all .3s ease;font-weight:500;font-size:14px}.tab-btn.active{background:var(--primary-color);color:#fff}.tab-btn:hover:not(.active){background:var(--ui-bg-heavy)}.tab-content{display:none}.tab-content.active{display:block}.character-overview-new{display:flex;flex-direction:column;gap:16px}.top-info-row{display:flex;gap:16px;align-items:flex-start}.character-card-compact{display:flex;gap:12px;padding:16px;background:var(--ui-bg);border-radius:12px;border:1px solid var(--ui-border-color);box-shadow:0 2px 8px var(--shadow-color-light);flex:0 0 auto;min-width:200px}.character-info-compact{flex:1;display:flex;flex-direction:column;gap:8px}.character-stats-compact{display:flex;flex-direction:column;gap:4px}.stat-compact{display:flex;justify-content:space-between;align-items:center}.stat-label-compact{font-size:12px;color:var(--text-color);opacity:.7;font-weight:500}.stat-value-compact{font-size:14px;color:var(--text-color);font-weight:600}.wealth-section-compact{flex:1;padding:16px;background:var(--ui-bg);border-radius:12px;border:1px solid var(--ui-border-color);box-shadow:0 2px 8px var(--shadow-color-light)}.wealth-section-compact h4{margin:0 0 12px 0;font-size:14px;font-weight:600;color:var(--text-color)}.wealth-items-compact{display:flex;flex-direction:column;gap:8px}.wealth-item-compact{display:flex;align-items:center;gap:8px;padding:8px;background:var(--ui-bg-heavy);border-radius:8px}.wealth-item-compact i{font-size:16px;color:var(--primary-color);width:20px;text-align:center}.wealth-item-compact div{display:flex;justify-content:space-between;align-items:center;flex:1}.wealth-label-compact{font-size:12px;color:var(--text-color);opacity:.7}.wealth-value-compact{font-size:14px;font-weight:600;color:var(--text-color)}.main-content-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}.abilities-section-compact{display:flex;flex-direction:column;gap:12px}.ability-group-compact{padding:12px;background:var(--ui-bg);border-radius:10px;border:1px solid var(--ui-border-color)}.ability-group-compact h4{margin:0 0 8px 0;font-size:14px;font-weight:600;color:var(--text-color)}.ability-list-compact{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}.ability-list-compact li{padding:6px 8px;background:var(--ui-bg-heavy);border-radius:6px;font-size:12px;line-height:1.3;color:var(--text-color)}.ability-list-compact li strong{display:block;margin-bottom:2px;font-size:13px}.ability-list-compact li small{font-size:1em;opacity:.8;line-height:1.2}.equipment-section-compact{padding:12px;background:var(--ui-bg);border-radius:10px;border:1px solid var(--ui-border-color)}.equipment-section-compact h4{margin:0 0 8px 0;font-size:14px;font-weight:600;color:var(--text-color)}.equipment-items-compact{display:flex;flex-direction:column;gap:6px}.inventory-section-compact{padding:12px;background:var(--ui-bg);border-radius:10px;border:1px solid var(--ui-border-color)}.inventory-section-compact h4{margin:0 0 8px 0;font-size:14px;font-weight:600;color:var(--text-color)}.inventory-items-compact{display:flex;flex-direction:column;gap:4px;max-height:150px;overflow-y:auto}.inventory-items-compact::-webkit-scrollbar{display:none}.inventory-items-compact{scrollbar-width:none;-ms-overflow-style:none}.inventory-items-compact .inventory-item{padding:8px;font-size:12px}.inventory-items-compact .inventory-item .inventory-item-icon{width:24px;height:24px;margin-right:8px}.inventory-items-compact .inventory-item .inventory-item-name{font-size:12px;margin-bottom:1px}.inventory-items-compact .inventory-item .inventory-item-description{font-size:11px}.inventory-items-compact .inventory-item .inventory-item-quantity{font-size:11px}@media (max-width:1000px){.main-content-grid{grid-template-columns:1fr;gap:12px}.top-info-row{flex-direction:column}.character-card-compact{min-width:auto}}@media (max-width:768px){.main-content-grid{grid-template-columns:1fr}}.character-card{display:flex;gap:20px;padding:24px;background:var(--ui-bg);border-radius:20px;border:1px solid var(--ui-border-color);box-shadow:0 4px 16px var(--shadow-color-light)}.character-avatar{width:80px;height:80px;border-radius:50%;background-color:var(--ui-bg-heavy);display:flex;align-items:center;justify-content:center;border:2px solid var(--ui-border-color);background-size:cover;background-position:center;background-repeat:no-repeat;overflow:hidden}.character-avatar .avatar-placeholder{font-size:32px;color:var(--text-color);opacity:.6}.character-avatar.user-avatar .avatar-placeholder{display:none}.character-info{flex:1;display:flex;flex-direction:column;justify-content:center}.character-name{font-size:24px;font-weight:700;color:var(--text-color);margin:0 0 12px 0}.character-stats{display:flex;gap:24px}.stat-item{display:flex;flex-direction:column;gap:4px}.stat-label{font-size:12px;color:var(--text-color);opacity:.7;font-weight:500}.stat-value{font-size:16px;color:var(--text-color);font-weight:600}.wealth-section{padding:20px;background:var(--ui-bg);border-radius:16px;border:1px solid var(--ui-border-color)}.wealth-section h4{margin:0 0 16px 0;font-size:16px;font-weight:600;color:var(--text-color)}.equipment-section{padding:20px;background:var(--ui-bg);border-radius:16px;border:1px solid var(--ui-border-color)}.equipment-section h4{margin:0 0 16px 0;font-size:16px;font-weight:600;color:var(--text-color)}.equipment-items{display:flex;flex-direction:column;gap:8px}.equipment-item{display:flex;align-items:center;padding:12px;background:var(--ui-bg-heavy);border-radius:8px;border:1px solid var(--ui-border-color);transition:all .2s ease}.equipment-item:hover{background:var(--ui-bg-light);border-color:var(--primary-color-light)}.equipment-item.equipped{border-color:var(--primary-color);background:var(--primary-color-light)}.equipment-item-icon{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--primary-color);border-radius:8px;color:#fff;margin-right:12px;flex-shrink:0}.equipment-item-icon i{font-size:16px}.equipment-item-info{flex:1;min-width:0}.equipment-item-name{font-size:14px;font-weight:600;color:var(--text-color);margin-bottom:2px}.equipment-item-type{font-size:12px;color:var(--text-color);opacity:.7;line-height:1.3}.equipment-item-badge{font-size:10px;color:var(--primary-color);font-weight:600;background:var(--primary-color-light);padding:2px 6px;border-radius:4px;margin-left:8px;flex-shrink:0}.equipment-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;color:var(--text-color);opacity:.6}.equipment-empty i{font-size:32px;margin-bottom:12px}.equipment-empty p{margin:0;font-size:14px}.basic-stats-section{padding:12px 0}.ability-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}.ability-list-compact{gap:8px}.ability-list-compact .empty-state{color:hsla(0,0%,100%,.5);font-style:italic;text-align:center;padding:16px 12px;background:var(--ui-bg-light);border-radius:8px;font-size:14px}[data-theme=light] .ability-list-compact .empty-state{color:rgba(0,0,0,.5)}.user_avatar,.user-avatar{width:80px;height:80px;border-radius:50%;background-size:cover;background-position:center;background-repeat:no-repeat;background-color:var(--ui-bg-heavy);border:2px solid var(--ui-border);flex-shrink:0;display:block}[data-theme=dark] .user_avatar,[data-theme=dark] .user-avatar{border-color:hsla(0,0%,100%,.1)}.top-info-row{display:flex;gap:20px;margin-bottom:20px}.character-card-expanded{flex:2;display:flex;align-items:center;gap:16px;padding:20px;background:var(--ui-bg-light);border:2px solid var(--ui-border);border-radius:12px;transition:all .3s ease}.character-card-expanded:hover{border-color:var(--accent-color);transform:translateY(-2px);box-shadow:0 8px 24px var(--shadow-color-light)}.character-card-expanded .character-info-expanded{flex:1}.character-card-expanded .character-info-expanded .character-name{margin:0 0 12px 0;font-size:20px;font-weight:600;color:var(--text-color)}.character-card-expanded .character-info-expanded .character-stats-expanded{display:flex;gap:20px}.character-card-expanded .character-info-expanded .character-stats-expanded .stat-compact{display:flex;flex-direction:column;align-items:flex-start}.character-card-expanded .character-info-expanded .character-stats-expanded .stat-compact .stat-label-compact{font-size:12px;color:var(--text-muted);margin-bottom:2px}.character-card-expanded .character-info-expanded .character-stats-expanded .stat-compact .stat-value-compact{font-size:16px;font-weight:600;color:var(--accent-color)}.wealth-section-narrow{flex:1;padding:16px;background:var(--ui-bg-light);border:2px solid var(--ui-border);border-radius:12px;transition:all .3s ease}.wealth-section-narrow:hover{border-color:var(--accent-color);transform:translateY(-2px);box-shadow:0 8px 24px var(--shadow-color-light)}.wealth-section-narrow h4{margin:0 0 12px 0;font-size:14px;font-weight:600;color:var(--text-color);text-align:center}.wealth-section-narrow .wealth-items-narrow{display:flex;flex-direction:column;gap:8px}.wealth-section-narrow .wealth-item-narrow{display:flex;align-items:center;gap:8px;padding:8px;background:var(--ui-bg);border-radius:6px;border-left:3px solid var(--accent-color)}.wealth-section-narrow .wealth-item-narrow i{font-size:16px;color:var(--accent-color);min-width:20px;text-align:center}.wealth-section-narrow .wealth-item-narrow div{flex:1;display:flex;justify-content:space-between;align-items:center}.wealth-section-narrow .wealth-item-narrow div .wealth-label-narrow{font-size:11px;color:var(--text-muted);font-weight:500}.wealth-section-narrow .wealth-item-narrow div .wealth-value-narrow{font-size:13px;font-weight:600;color:var(--text-color)}.equipment-preview-detailed{display:flex;flex-direction:column;gap:12px;padding:16px}.equipment-preview-detailed .equipment-empty{display:flex;flex-direction:column;align-items:center;padding:24px 30px;color:var(--text-muted)}.equipment-preview-detailed .equipment-empty i{font-size:32px;margin-bottom:8px;opacity:.5}.equipment-preview-detailed .equipment-empty p{margin:0;font-size:14px}.equipment-preview-detailed .equipment-item-detailed{background:var(--ui-bg);border:2px solid var(--ui-border);border-radius:6px;padding:14px;margin:0;transition:all .3s ease;cursor:pointer}.equipment-preview-detailed .equipment-item-detailed:hover{border-color:var(--accent-color);background:var(--ui-bg-hover);transform:translateY(-1px);box-shadow:0 4px 12px var(--shadow-color-light)}.equipment-preview-detailed .equipment-item-detailed .equipment-item-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}.equipment-preview-detailed .equipment-item-detailed .equipment-item-header .equipment-item-icon{font-size:20px;color:var(--accent-color);min-width:24px;text-align:center}.equipment-preview-detailed .equipment-item-detailed .equipment-item-header .equipment-item-main-info{flex:1}.equipment-preview-detailed .equipment-item-detailed .equipment-item-header .equipment-item-main-info .equipment-item-name{font-size:14px;font-weight:600;color:var(--text-color);margin-bottom:2px}.equipment-preview-detailed .equipment-item-detailed .equipment-item-header .equipment-item-main-info .equipment-item-type{font-size:11px;color:var(--text-muted)}.equipment-preview-detailed .equipment-item-detailed .equipment-item-header .equipment-item-badge{background:var(--ui-bg-heavy);color:var(--text-color);font-size:10px;font-weight:500;padding:4px 8px;border:1px solid var(--ui-border-color);border-radius:10px;white-space:nowrap}.equipment-preview-detailed .equipment-item-detailed .equipment-item-description{font-size:12px;line-height:1.4;color:var(--text-color);background:var(--ui-bg-light);padding:8px;border-radius:6px;border-left:3px solid var(--accent-color);opacity:.9}.rpg-tabs{display:flex;gap:4px;background:var(--ui-bg-heavy);padding:8px;border-radius:12px;border:1px solid var(--ui-border)}.rpg-tabs .tab-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 8px;background:rgba(0,0,0,0);border:none;border-radius:8px;color:var(--text-muted);cursor:pointer;transition:all .3s ease;position:relative;overflow:hidden}.rpg-tabs .tab-btn i{font-size:20px;transition:transform .3s ease}.rpg-tabs .tab-btn span{font-size:12px;font-weight:500;transition:color .3s ease}.rpg-tabs .tab-btn:hover{background:var(--ui-bg-light);color:var(--text-color);transform:translateY(-2px)}.rpg-tabs .tab-btn:hover i{transform:scale(1.1)}.rpg-tabs .tab-btn.active{background:var(--accent-color);color:#fff;box-shadow:0 4px 12px var(--accent-shadow)}.rpg-tabs .tab-btn.active::before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,0.1) 50%,transparent 70%);animation:shimmer 2s infinite}@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}.rpg-content-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;padding:20px 0}.rpg-section{display:flex;flex-direction:column;gap:16px}.rpg-card{background:var(--ui-bg-light);border:2px solid var(--ui-border);border-radius:12px;overflow:hidden;position:relative;transition:all .3s ease}.rpg-card:hover{border-color:var(--accent-color);box-shadow:0 8px 24px var(--shadow-color-light);transform:translateY(-2px)}.rpg-card .card-header{background:var(--ui-bg-heavy);padding:12px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--ui-border);position:relative}.rpg-card .card-header::before{content:"";position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent-color)}.rpg-card .card-header i{font-size:16px;color:var(--accent-color)}.rpg-card .card-header h4{margin:0;font-size:14px;font-weight:600;color:var(--text-color)}.rpg-card .ability-list-compact{padding:16px;margin:0}.rpg-card .ability-list-compact li{background:var(--ui-bg);margin-bottom:8px;padding:12px;border-radius:8px;border-left:3px solid var(--accent-color);transition:all .2s ease}.rpg-card .ability-list-compact li:hover{background:var(--ui-bg-hover);transform:translateX(4px)}.rpg-card .ability-list-compact li:last-child{margin-bottom:0}.rpg-card .ability-list-compact .empty-state{background:var(--ui-bg);border-left:3px solid var(--text-muted);opacity:.7}.equipment-preview{padding:16px}.equipment-preview .equipment-item{display:flex;align-items:center;gap:12px;padding:8px 12px;background:var(--ui-bg);border-radius:6px;margin-bottom:8px;border-left:3px solid var(--accent-color)}.equipment-preview .equipment-item .equipment-item-icon{width:24px;height:24px;display:flex;align-items:center;justify-content:center;color:var(--accent-color)}.equipment-preview .equipment-item .equipment-item-icon i{font-size:16px}.equipment-preview .equipment-item .equipment-item-info{flex:1}.equipment-preview .equipment-item .equipment-item-info .equipment-item-name{font-weight:500;color:var(--text-color);font-size:13px;margin-bottom:2px}.equipment-preview .equipment-item .equipment-item-info .equipment-item-type{font-size:11px;color:var(--text-muted)}.equipment-preview .equipment-item .equipment-item-badge{background:var(--ui-bg-heavy);color:var(--text-color);padding:2px 6px;border-radius:10px;font-size:10px;border:1px solid var(--ui-border-color);font-weight:500}.modal-body::-webkit-scrollbar,.rpg-inventory-container::-webkit-scrollbar,.rpg-equipment-container::-webkit-scrollbar{display:none}.modal-body,.rpg-inventory-container,.rpg-equipment-container{scrollbar-width:none;-ms-overflow-style:none}.rpg-inventory-container{padding:20px;height:100%;display:flex;flex-direction:column}.rpg-inventory-container .inventory-header{margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;gap:20px}.rpg-inventory-container .inventory-header .inventory-stats{display:flex;gap:20px;padding:12px 16px;background:var(--ui-bg-light);border-radius:8px;border:1px solid var(--ui-border)}.rpg-inventory-container .inventory-header .inventory-stats span{font-size:14px;color:var(--text-color);font-weight:500}.rpg-inventory-container .inventory-header .inventory-stats span span{color:var(--accent-color)}.rpg-inventory-container .inventory-header .inventory-sorting{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:8px;transition:all .3s ease}.rpg-inventory-container .inventory-header .inventory-sorting:hover{background:var(--ui-bg-light)}.rpg-inventory-container .inventory-header .inventory-sorting label{font-size:12px;font-weight:600;color:var(--text-color);margin:0;opacity:.8}.rpg-inventory-container .inventory-header .inventory-sorting .sort-select{padding:6px 10px;border:1px solid var(--ui-border-color);border-radius:6px;background:var(--ui-bg-heavy);color:var(--text-color);font-size:12px;cursor:pointer;transition:all .3s ease}.rpg-inventory-container .inventory-header .inventory-sorting .sort-select:hover{border-color:var(--primary-color-light)}.rpg-inventory-container .inventory-header .inventory-sorting .sort-select:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 2px var(--primary-color-light)}.rpg-inventory-container .inventory-header .inventory-sorting .sort-order-btn{width:32px;height:32px;border:1px solid var(--ui-border-color);border-radius:6px;background:var(--ui-bg-heavy);color:var(--text-color);cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center}.rpg-inventory-container .inventory-header .inventory-sorting .sort-order-btn:hover{background:var(--primary-color-light);border-color:var(--primary-color);color:var(--primary-color);transform:scale(1.05)}.rpg-inventory-container .inventory-header .inventory-sorting .sort-order-btn:active{transform:scale(0.95)}.rpg-inventory-container .inventory-header .inventory-sorting .sort-order-btn i{font-size:12px;transition:transform .3s ease}.rpg-inventory-container .inventory-header .inventory-sorting .sort-order-btn[data-order=desc] i{transform:rotate(180deg)}.rpg-inventory-container .inventory-content{display:grid;grid-template-columns:1fr 300px;gap:20px;flex:1;overflow:hidden}.rpg-inventory-container .inventory-grid-container{overflow-y:auto;border:2px solid var(--ui-border);border-radius:12px;background:var(--ui-bg-light);padding:16px}.rpg-inventory-container .inventory-grid-container::-webkit-scrollbar{display:none}.rpg-inventory-container .inventory-grid-container{scrollbar-width:none;-ms-overflow-style:none}.rpg-inventory-container .inventory-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:16px}.rpg-inventory-container .inventory-grid .inventory-item-slot{width:100%;height:110px;background:var(--ui-bg);border:none;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;cursor:pointer;transition:all .3s ease;padding:12px 8px;backdrop-filter:blur(var(--blur-intensity));-webkit-backdrop-filter:blur(var(--blur-intensity))}.rpg-inventory-container .inventory-grid .inventory-item-slot:hover{background:var(--ui-bg-light);transform:translateY(-3px);box-shadow:0 6px 20px var(--shadow-color-medium)}.rpg-inventory-container .inventory-grid .inventory-item-slot.selected{background:var(--primary-color-light);box-shadow:0 4px 16px var(--shadow-color-light)}.rpg-inventory-container .inventory-grid .inventory-item-slot .item-icon{font-size:24px;color:var(--accent-color);margin-bottom:6px}.rpg-inventory-container .inventory-grid .inventory-item-slot .item-name{font-size:11px;font-weight:500;color:var(--text-color);text-align:center;line-height:1.2;margin-bottom:4px;max-width:100%;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;line-clamp:2;-webkit-box-orient:vertical}.rpg-inventory-container .inventory-grid .inventory-item-slot .item-quantity{position:absolute;bottom:2px;right:4px;background:var(--accent-color);color:#fff;font-size:10px;font-weight:500;padding:1px 4px;border-radius:8px;min-width:16px;text-align:center}.rpg-inventory-container .inventory-grid .inventory-item-slot .equipped-badge{position:absolute;top:2px;left:2px;background:var(--ui-bg-heavy);color:var(--text-color);font-size:8px;font-weight:500;padding:1px 4px;border-radius:6px}.rpg-inventory-container .inventory-grid .inventory-empty-message{grid-column:1/-1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;color:var(--text-muted)}.rpg-inventory-container .inventory-grid .inventory-empty-message i{font-size:48px;margin-bottom:12px;opacity:.5}.rpg-inventory-container .inventory-grid .inventory-empty-message p{margin:0;font-size:14px;text-align:center}.rpg-inventory-container .item-details-panel{border:2px solid var(--ui-border);border-radius:12px;background:var(--ui-bg-light);padding:16px;overflow-y:auto}.rpg-inventory-container .item-details-panel::-webkit-scrollbar{display:none}.rpg-inventory-container .item-details-panel{scrollbar-width:none;-ms-overflow-style:none}.rpg-inventory-container .item-details-panel .no-item-selected{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-muted)}.rpg-inventory-container .item-details-panel .no-item-selected i{font-size:32px;margin-bottom:8px;opacity:.5}.rpg-inventory-container .item-details-panel .no-item-selected p{margin:0;font-size:14px}.rpg-inventory-container .item-details-panel .item-details .item-details-header{display:flex;gap:12px;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--ui-border)}.rpg-inventory-container .item-details-panel .item-details .item-details-header .item-icon-large{width:48px;height:48px;background:var(--ui-bg-heavy);border-radius:8px;display:flex;align-items:center;justify-content:center;border:2px solid var(--ui-border)}.rpg-inventory-container .item-details-panel .item-details .item-details-header .item-icon-large i{font-size:24px;color:var(--accent-color)}.rpg-inventory-container .item-details-panel .item-details .item-details-header .item-basic-info{flex:1}.rpg-inventory-container .item-details-panel .item-details .item-details-header .item-basic-info .item-name{margin:0 0 4px 0;font-size:16px;font-weight:600;color:var(--text-color)}.rpg-inventory-container .item-details-panel .item-details .item-details-header .item-basic-info .item-type{margin:0;font-size:12px;color:var(--text-muted);text-transform:uppercase}.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description,.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties{margin-bottom:16px}.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description h4,.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties h4{margin:0 0 8px 0;font-size:14px;font-weight:600;color:var(--text-color);display:flex;align-items:center;gap:4px}.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description h4::before,.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties h4::before{content:"";width:2px;height:12px;background:var(--accent-color);border-radius:1px}.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description p,.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties p{margin:0;font-size:13px;color:var(--text-color);line-height:1.4;background:var(--ui-bg);padding:8px 12px;border-radius:6px;border-left:3px solid var(--accent-color)}.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description ul,.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties ul{list-style:none;margin:0;padding:0}.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description ul li,.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties ul li{padding:6px 12px;background:var(--ui-bg);margin-bottom:4px;border-radius:4px;font-size:13px;color:var(--text-color);display:flex;justify-content:space-between}.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description ul li:last-child,.rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties ul li:last-child{margin-bottom:0}.rpg-equipment-container{padding:20px;display:grid;grid-template-columns:1fr 1fr;gap:24px}.rpg-equipment-container .equipment-slots-section h4,.rpg-equipment-container .all-equipment-section h4{margin:0 0 16px 0;color:var(--text-color);font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px}.rpg-equipment-container .equipment-slots-section h4::before,.rpg-equipment-container .all-equipment-section h4::before{content:"";width:3px;height:16px;background:var(--accent-color);border-radius:2px}.rpg-equipment-container .equipment-slots-grid{display:grid;gap:16px}.rpg-equipment-container .equipment-slot{display:flex;align-items:center;gap:16px;padding:16px;background:var(--ui-bg-light);border:2px solid var(--ui-border);border-radius:12px;transition:all .3s ease}.rpg-equipment-container .equipment-slot:hover{border-color:var(--accent-color);transform:translateX(4px)}.rpg-equipment-container .equipment-slot .slot-icon{width:48px;height:48px;background:var(--ui-bg-heavy);border-radius:8px;display:flex;align-items:center;justify-content:center;border:2px solid var(--ui-border)}.rpg-equipment-container .equipment-slot .slot-icon i{font-size:20px;color:var(--accent-color)}.rpg-equipment-container .equipment-slot .slot-label{font-weight:500;color:var(--text-color);min-width:60px}.rpg-equipment-container .equipment-slot .equipped-item{flex:1;min-height:20px}.rpg-equipment-container .equipment-list-container{border:2px solid var(--ui-border);border-radius:12px;background:var(--ui-bg-light);padding:16px;max-height:400px;overflow-y:auto}.rpg-equipment-container .equipment-list-container::-webkit-scrollbar{display:none}.rpg-equipment-container .equipment-list-container{scrollbar-width:none;-ms-overflow-style:none}.rpg-equipment-container .equipment-list-container .no-equipment{text-align:center;color:var(--text-muted);padding:40px 20px;font-size:14px}.rpg-equipment-container .equipment-list-container .equipment-list-item{display:flex;align-items:center;gap:12px;padding:12px;margin-bottom:8px;background:var(--ui-bg);border:2px solid var(--ui-border);border-radius:8px;transition:all .3s ease}.rpg-equipment-container .equipment-list-container .equipment-list-item:hover{border-color:var(--accent-color);background:var(--ui-bg-hover);transform:translateX(4px)}.rpg-equipment-container .equipment-list-container .equipment-list-item.equipped{border-color:var(--primary-color);background:var(--primary-color-light)}.rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-icon{width:40px;height:40px;background:var(--ui-bg-heavy);border-radius:6px;display:flex;align-items:center;justify-content:center;border:1px solid var(--ui-border)}.rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-icon i{font-size:18px;color:var(--accent-color)}.rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-info{flex:1}.rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-info .equipment-item-name{font-weight:500;color:var(--text-color);font-size:14px;margin-bottom:2px}.rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-info .equipment-item-type{font-size:12px;color:var(--text-muted);margin-bottom:2px}.rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-info .equipment-item-description{font-size:11px;color:var(--text-muted);line-height:1.3}.rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-status .equipped-badge{background:var(--ui-bg-heavy);color:var(--text-color);padding:4px 8px;border-radius:12px;font-size:11px;font-weight:500}.rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-status .equip-btn{background:var(--accent-color);color:#fff;border:none;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:500;cursor:pointer;transition:all .2s ease}.rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-status .equip-btn:hover{background:var(--accent-color-light);transform:translateY(-1px)}.rpg-equipment-container .equipped-item-display{display:flex;align-items:center;gap:8px}.rpg-equipment-container .equipped-item-display .equipped-item-icon{width:24px;height:24px;display:flex;align-items:center;justify-content:center;color:var(--accent-color)}.rpg-equipment-container .equipped-item-display .equipped-item-icon i{font-size:14px}.rpg-equipment-container .equipped-item-display .equipped-item-name{font-size:13px;font-weight:500;color:var(--text-color)}.rpg-equipment-container .empty-slot{font-size:12px;color:var(--text-muted);font-style:italic}.ability-list li,.ability-list .ability-item{padding:10px 12px;background:var(--ui-bg-heavy);border-radius:8px;font-size:14px;color:var(--text-color)}.wealth-grid{display:flex;gap:16px}.wealth-item{display:flex;align-items:center;gap:12px;padding:16px;background:var(--ui-bg-heavy);border-radius:12px;flex:1}.wealth-item i{font-size:20px;color:var(--primary-color)}.wealth-info{display:flex;flex-direction:column;gap:4px}.wealth-label{font-size:12px;color:var(--text-color);opacity:.7}.wealth-value{font-size:16px;font-weight:600;color:var(--text-color)}.inventory-section{padding:20px;background:var(--ui-bg);border-radius:16px;border:1px solid var(--ui-border-color)}.inventory-section h4{margin:0 0 16px 0;font-size:16px;font-weight:600;color:var(--text-color)}.inventory-items{display:flex;flex-direction:column;gap:8px}.inventory-item{display:flex;align-items:center;padding:12px;background:var(--ui-bg-heavy);border-radius:8px;border:1px solid var(--ui-border-color);transition:all .2s ease}.inventory-item:hover{background:var(--ui-bg-light);border-color:var(--primary-color-light)}.inventory-item-icon{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--primary-color);border-radius:8px;color:#fff;margin-right:12px;flex-shrink:0}.inventory-item-icon i{font-size:16px}.inventory-item-info{flex:1;min-width:0}.inventory-item-name{font-size:14px;font-weight:600;color:var(--text-color);margin-bottom:2px}.inventory-item-description{font-size:12px;color:var(--text-color);opacity:.7;line-height:1.3}.inventory-item-quantity{font-size:12px;color:var(--primary-color);font-weight:600;margin-left:8px;flex-shrink:0}.inventory-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;color:var(--text-color);opacity:.6}.inventory-empty i{font-size:32px;margin-bottom:12px}.inventory-empty p{margin:0;font-size:14px}.inventory-container{display:flex;gap:20px;height:400px}.inventory-grid{flex:2;display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:8px;padding:20px;background:var(--ui-bg);border-radius:16px;border:1px solid var(--ui-border-color);overflow-y:auto}.inventory-grid::-webkit-scrollbar{display:none}.inventory-grid{scrollbar-width:none;-ms-overflow-style:none}.item-slot{width:60px;height:60px;background:var(--ui-bg-heavy);border:2px solid var(--ui-border-color);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s ease}.item-slot:hover{border-color:var(--primary-color);transform:translateY(-2px)}.item-slot.has-item{background:var(--primary-color-light)}.item-details-panel{flex:1;padding:20px;background:var(--ui-bg);border-radius:16px;border:1px solid var(--ui-border-color)}.no-item-selected{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-color);opacity:.6}.no-item-selected i{font-size:48px;margin-bottom:16px}.no-item-selected p{font-size:14px;margin:0}.item-details{display:flex;flex-direction:column;height:100%}.item-details-header{display:flex;align-items:center;gap:16px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--ui-border-color)}.item-details-header .item-icon-large{width:48px;height:48px;background:var(--primary-color);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px;flex-shrink:0}.item-details-header .item-basic-info{flex:1;min-width:0}.item-details-header .item-basic-info h3{margin:0 0 4px 0;font-size:18px;font-weight:600;color:var(--text-color)}.item-details-header .item-basic-info .item-type{margin:0;font-size:14px;color:var(--primary-color);font-weight:500}.item-details-body{flex:1;display:flex;flex-direction:column;gap:20px}.item-details-body .item-description h4,.item-details-body .item-properties h4{margin:0 0 8px 0;font-size:14px;font-weight:600;color:var(--text-color)}.item-details-body .item-description p,.item-details-body .item-properties p{margin:0;font-size:14px;color:var(--text-color);opacity:.8;line-height:1.5}.item-details-body .item-description ul,.item-details-body .item-properties ul{margin:0;padding:0;list-style:none}.item-details-body .item-description ul li,.item-details-body .item-properties ul li{font-size:14px;color:var(--text-color);opacity:.8;padding:4px 0}.item-detail-actions{margin-top:20px;padding-top:16px;border-top:1px solid var(--ui-border-color);display:flex;flex-direction:column;gap:8px}.item-action-btn{width:100%;padding:12px 16px;border:1px solid var(--ui-border-color);border-radius:8px;background:var(--ui-bg);color:var(--text-color);font-size:14px;font-weight:500;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:8px;outline:none}.item-action-btn:hover:not(:disabled){border-color:var(--ui-border-color);background:var(--ui-bg-light);color:var(--text-color)}.item-action-btn:disabled{opacity:.5;cursor:not-allowed;background:var(--ui-bg-light)}.item-action-btn.gift-btn{border-color:var(--success-color);color:var(--success-color);background:rgba(var(--success-color-rgb),0.1)}.item-action-btn.gift-btn:hover{background:var(--success-color);color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(var(--success-color-rgb),0.3)}.item-action-btn.equip-btn{border-color:var(--ui-border-color);color:var(--text-color)}.item-action-btn.equip-btn i{color:var(--text-color)}.item-action-btn.equip-btn:hover:not(:disabled){border-color:var(--ui-border-color);background:var(--ui-bg-light);color:var(--text-color)}.item-action-btn.discard-btn{border-color:var(--danger-color-light);color:var(--danger-color)}.item-action-btn.discard-btn:hover:not(:disabled){border-color:var(--danger-color);background:var(--danger-color-light)}.item-action-btn i{font-size:16px;flex-shrink:0}.item-action-btn span{flex:1;text-align:left}#gift-dialog,.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;animation:fadeIn .3s ease-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.gift-dialog-content{background:var(--ui-bg-heavy);border-radius:16px;border:1px solid var(--ui-border-color);box-shadow:0 8px 32px var(--shadow-color-medium);max-width:500px;width:90%;max-height:80vh;overflow:hidden;animation:slideIn .3s ease-out}.gift-dialog-content::-webkit-scrollbar{display:none}.gift-dialog-content{scrollbar-width:none;-ms-overflow-style:none}@keyframes slideIn{from{opacity:0;transform:translateY(-20px) scale(0.95)}to{opacity:1;transform:translateY(0) scale(1)}}.gift-dialog-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--ui-border-color)}.gift-dialog-header h3{margin:0;font-size:18px;font-weight:600;color:var(--text-color)}.gift-dialog-header .gift-dialog-close{width:32px;height:32px;border:none;background:var(--ui-bg);border-radius:8px;color:var(--text-color);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s ease}.gift-dialog-header .gift-dialog-close:hover{background:var(--danger-color-light);color:var(--danger-color)}.gift-dialog-header .gift-dialog-close i{font-size:14px}.gift-dialog-body{padding:24px;max-height:60vh;overflow-y:auto}.gift-dialog-body::-webkit-scrollbar{display:none}.gift-dialog-body{scrollbar-width:none;-ms-overflow-style:none}.gift-item-info{display:flex;align-items:center;gap:16px;padding:16px;background:var(--ui-bg);border-radius:12px;border:1px solid var(--ui-border-color);margin-bottom:24px}.gift-item-info .gift-item-icon{width:48px;height:48px;background:var(--primary-color);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px;flex-shrink:0}.gift-item-info .gift-item-details{flex:1}.gift-item-info .gift-item-details h4{margin:0 0 4px 0;font-size:16px;font-weight:600;color:var(--text-color)}.gift-item-info .gift-item-details p{margin:0;font-size:14px;color:var(--text-color);opacity:.7}.gift-recipient-selection h4{margin:0 0 16px 0;font-size:16px;font-weight:600;color:var(--text-color)}.gift-character-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto}.gift-character-list::-webkit-scrollbar{display:none}.gift-character-list{scrollbar-width:none;-ms-overflow-style:none}.gift-character-option{display:flex;align-items:center;gap:12px;padding:12px;background:var(--ui-bg);border:2px solid var(--ui-border-color);border-radius:12px;cursor:pointer;transition:all .3s ease}.gift-character-option:hover{background:var(--ui-bg-light);border-color:var(--primary-color-light)}.gift-character-option.selected{background:var(--primary-color-light);border-color:var(--primary-color)}.gift-character-option.selected .gift-character-name{color:var(--primary-color);font-weight:600}.gift-character-option .gift-character-avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;flex-shrink:0;background:var(--ui-bg-light)}.gift-character-option .gift-character-avatar img{width:100%;height:100%;object-fit:cover}.gift-character-option .gift-character-info{flex:1;min-width:0}.gift-character-option .gift-character-info .gift-character-name{font-size:14px;font-weight:500;color:var(--text-color);margin-bottom:2px}.gift-character-option .gift-character-info .gift-character-relationship{font-size:12px;color:var(--text-color);opacity:.6}.gift-dialog-footer{display:flex;gap:12px;padding:20px 24px;border-top:1px solid var(--ui-border-color);background:var(--ui-bg)}.gift-dialog-footer .secondary-btn,.gift-dialog-footer .primary-btn{flex:1;padding:12px 24px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .3s ease;outline:none}.gift-dialog-footer .secondary-btn{border:1px solid var(--ui-border-color);background:var(--ui-bg);color:var(--text-color)}.gift-dialog-footer .secondary-btn:hover{background:var(--ui-bg-light);border-color:var(--text-color)}.gift-dialog-footer .primary-btn{border:1px solid var(--primary-color);background:var(--primary-color);color:#fff}.gift-dialog-footer .primary-btn:hover:not(:disabled){background:var(--primary-color-dark);transform:translateY(-1px)}.gift-dialog-footer .primary-btn:disabled{opacity:.5;cursor:not-allowed;background:var(--ui-bg-light);border-color:var(--ui-border-color);color:var(--text-color);transform:none}.equipment-container{display:flex;gap:20px}.equipment-slots{display:flex;flex-direction:column;gap:16px;padding:20px;background:var(--ui-bg);border-radius:16px;border:1px solid var(--ui-border-color)}.equipment-slot{display:flex;align-items:center;gap:12px;padding:16px;background:var(--ui-bg-heavy);border-radius:12px;border:2px dashed var(--ui-border-color);cursor:pointer;transition:all .3s ease}.equipment-slot:hover{border-color:var(--primary-color);background:var(--primary-color-light)}.equipment-slot i{font-size:20px;color:var(--text-color);opacity:.6}.equipment-slot span{font-size:14px;color:var(--text-color);font-weight:500}.equipment-list{flex:1;padding:20px;background:var(--ui-bg);border-radius:16px;border:1px solid var(--ui-border-color)}.status-content{display:flex;gap:24px;height:100%}.status-left-panel,.status-right-panel{flex:1}.status-section{margin-bottom:24px}.status-section h3{font-size:16px;font-weight:600;color:var(--primary-color);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--ui-border-color)}.status-section p{margin-bottom:8px;font-size:14px;line-height:1.5}.status-section ul{list-style:none;padding:0;margin:0}.status-section ul li{padding:8px 0;border-bottom:1px solid var(--ui-border-color);font-size:14px}.status-section ul li:last-child{border-bottom:none}#view-hummingbird .modal-body{padding:0;flex-direction:row}#contact-list{width:35%;border-right:1px solid var(--ui-border-color);overflow-y:auto;padding:24px}#contact-list::-webkit-scrollbar{display:none}#contact-list{scrollbar-width:none;-ms-overflow-style:none}#chat-window{width:65%;display:flex;flex-direction:column}.contact-item{display:flex;align-items:center;padding:10px;border-radius:10px;cursor:pointer;transition:background .3s}.contact-item:hover,.contact-item.active{background:var(--primary-color-light)}.contact-avatar{width:40px;height:40px;border-radius:50%;margin-right:10px;object-fit:cover;object-position:top;transition:all .3s ease}.contact-avatar[src*="data:image/svg+xml"]{background-color:var(--ui-bg-secondary);border:1px solid var(--ui-border-color);opacity:.8}.contact-name{font-weight:600}.contact-status{font-size:12px;opacity:.7}#chat-messages{flex-grow:1;padding:24px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}#chat-messages::-webkit-scrollbar{display:none}#chat-messages{scrollbar-width:none;-ms-overflow-style:none}#chat-input{display:flex;padding:24px;border-top:1px solid var(--ui-border-color)}#message-input{flex-grow:1;border:none;background:rgba(0,0,0,.05);color:var(--text-color);padding:10px;border-radius:15px}#message-input:focus{outline:none}.send-btn{background:rgba(0,0,0,0);color:var(--primary-color);border:none;border-radius:50%;width:40px;height:40px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:all .3s ease}.send-btn:hover{background:var(--primary-color-light);transform:scale(1.05)}.send-btn:disabled{opacity:.5;cursor:not-allowed}.message{padding:10px 15px;border-radius:18px;max-width:80%}.message.sent{background:var(--primary-color);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}.message.received{background:var(--ui-bg);align-self:flex-start;border-bottom-left-radius:4px}.no-messages,.no-contacts{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;color:var(--text-color);opacity:.6;padding:40px 20px}.no-messages .no-messages-icon,.no-messages .no-contacts-icon,.no-contacts .no-messages-icon,.no-contacts .no-contacts-icon{font-size:48px;margin-bottom:16px;opacity:.5}.no-messages h4,.no-contacts h4{font-size:16px;font-weight:600;margin-bottom:8px;color:var(--text-color)}.no-messages p,.no-contacts p{font-size:14px;line-height:1.4;opacity:.7;margin:0}#item-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:16px;padding:16px;overflow-y:auto;flex:1}#item-grid::-webkit-scrollbar{display:none}#item-grid{scrollbar-width:none;-ms-overflow-style:none}.inventory-item{background:var(--ui-bg);border:1px solid var(--ui-border-color);border-radius:12px;padding:12px;cursor:pointer;transition:all .3s ease;text-align:center}.inventory-item:hover{background:var(--primary-color-light);border-color:var(--primary-color);transform:translateY(-2px)}.item-icon{font-size:24px;color:var(--primary-color);margin-bottom:8px}.item-name{font-size:14px;font-weight:600;margin-bottom:4px}.item-quantity{font-size:12px;opacity:.7}#item-details{width:300px;padding:24px;border-left:1px solid var(--ui-border-color);background:var(--ui-bg)}#event-list{flex:1;overflow-y:auto;padding:16px}#event-list::-webkit-scrollbar{display:none}#event-list{scrollbar-width:none;-ms-overflow-style:none}.memoir-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px}.memoir-item{display:grid;grid-template-columns:44px 1fr;align-items:start;gap:12px;background:var(--ui-bg);border:1px solid var(--ui-border-color);border-radius:14px;padding:12px 14px;transition:transform .15s ease,box-shadow .15s ease}.memoir-item:hover{transform:translateY(-1px);box-shadow:0 4px 12px var(--shadow-color-light)}.memoir-avatar{width:44px;height:44px;border-radius:12px;background:var(--ui-bg-light);display:flex;align-items:center;justify-content:center;color:var(--text-muted-color);overflow:hidden}.memoir-avatar img{width:100%;height:100%;object-fit:cover;display:block}.memoir-avatar.default i{font-size:22px;opacity:.9}.memoir-meta{display:flex;flex-direction:column;gap:4px}.memoir-speaker{font-weight:600;color:var(--text-color)}.memoir-text{color:var(--text-color);line-height:1.6;white-space:normal}.quest-tabs{display:flex;gap:8px;margin-top:16px}.tab-btn{padding:8px 16px;border:1px solid var(--ui-border-color);background:var(--ui-bg);color:var(--text-color);border-radius:20px;cursor:pointer;transition:all .3s ease;font-weight:500}.tab-btn.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}.tab-btn:hover:not(.active){background:var(--primary-color-light)}.quest-content{flex:1;overflow:hidden;display:flex;gap:24px}#quest-list{flex:1;overflow-y:auto;padding:0 24px;scrollbar-width:none;-ms-overflow-style:none}#quest-list::-webkit-scrollbar{width:0;height:0}.quest-item{padding:15px;border-radius:10px;margin-bottom:10px;cursor:pointer;transition:background .3s}.quest-item:hover{background:var(--primary-color-light)}.quest-item.selected{background:var(--primary-color-light)}.quest-item .quest-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}.quest-item.quest-current .quest-title{font-size:22px;font-weight:700;color:#ff9500}.quest-title{font-size:16px;font-weight:600;flex:1;margin-right:12px}.quest-status{font-size:12px;padding:3px 8px;border-radius:10px;display:inline-block;white-space:nowrap}.quest-status.quest-status-current{background:#ff9500;color:#fff}.quest-status.quest-status-completed{background:#34c759;color:#fff}.quest-description{font-size:14px;line-height:1.5;opacity:.8}#quest-details{width:320px;padding:24px;border-left:1px solid var(--ui-border-color);overflow-y:auto;scrollbar-width:none;-ms-overflow-style:none}#quest-details::-webkit-scrollbar{width:0;height:0}#quest-details .action-suggestions-header{text-align:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--ui-border-color)}#quest-details .action-suggestions-header h3{font-size:18px;font-weight:600;color:var(--primary-color);margin-bottom:8px}#quest-details .action-suggestions-header .suggestions-subtitle{font-size:14px;color:var(--text-color-secondary);opacity:.8}#quest-details .action-suggestions-list{display:flex;flex-direction:column}#quest-details .action-suggestion-item{padding:12px 0;cursor:pointer;transition:all .2s ease;border-bottom:1px solid var(--ui-border-color)}#quest-details .action-suggestion-item:last-child{border-bottom:none}#quest-details .action-suggestion-item:hover{background:var(--primary-color-light);padding-left:8px;padding-right:8px;border-radius:4px}#quest-details .action-suggestion-item.clicked{transform:scale(0.99);transition:transform .1s ease}#quest-details .action-suggestion-item .suggestion-text{font-size:14px;line-height:1.5;color:var(--text-color);font-weight:500}#quest-details .no-suggestions{text-align:center;padding:48px 16px;color:var(--text-color-secondary)}#quest-details .no-suggestions h4{font-size:16px;margin-bottom:8px;color:var(--text-color)}#quest-details .no-suggestions p{font-size:14px;opacity:.7;line-height:1.4}@keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}.choice-container{position:absolute;bottom:120px;left:20px;right:20px;z-index:10;display:flex;flex-direction:column;gap:12px;max-width:600px;margin:0 auto;padding:16px;min-height:auto;overflow:visible;animation:choiceSlideIn .3s ease-out}@keyframes choiceSlideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.choice-btn{padding:12px 20px;border:1px solid var(--ui-border-color);background:var(--ui-bg-heavy);color:var(--text-color);border-radius:12px;cursor:pointer;transition:all .3s ease;text-align:left;font-size:14px;backdrop-filter:blur(var(--blur-intensity));-webkit-backdrop-filter:blur(var(--blur-intensity));box-shadow:0 4px 16px var(--shadow-color-light)}.choice-btn:hover:not(.disabled){background:var(--primary-color-light);border-color:var(--primary-color);transform:translateY(-2px);box-shadow:0 6px 20px var(--shadow-color-medium)}.choice-btn.disabled{opacity:.5;cursor:not-allowed;background:var(--ui-bg-light);border-color:var(--ui-border-color)}.choice-prompt{color:var(--primary-color);font-style:italic;opacity:.8;animation:choicePromptPulse 2s ease-in-out infinite}@keyframes choicePromptPulse{0%,100%{opacity:.8}50%{opacity:1}}.control-btn.choice-ready{background:var(--primary-color) !important;color:#fff !important;animation:choiceButtonPulse 1.5s ease-in-out infinite;box-shadow:0 0 15px var(--shadow-color-light)}@keyframes choiceButtonPulse{0%,100%{transform:scale(1);box-shadow:0 0 15px var(--shadow-color-light)}50%{transform:scale(1.05);box-shadow:0 0 20px var(--shadow-color-medium)}}.dialogue-choices{margin-top:15px}.dialogue-choices .choice-prompt{color:var(--primary-color);font-weight:500;margin-bottom:12px;font-size:14px}.dialogue-choice-item{margin-bottom:8px}.dialogue-choice-btn{width:100%;padding:12px 40px 12px 16px;border:1px solid var(--ui-border-color);background:var(--ui-bg-light);color:var(--text-color);border-radius:8px;cursor:pointer;transition:all .3s ease;text-align:left;font-size:14px;backdrop-filter:blur(var(--blur-intensity));-webkit-backdrop-filter:blur(var(--blur-intensity));position:relative;display:flex;align-items:center;justify-content:space-between}.dialogue-choice-btn:hover{background:var(--primary-color-light);border-color:var(--primary-color);transform:translateY(-1px);box-shadow:0 4px 12px var(--shadow-color-light)}.dialogue-choice-btn:active{transform:translateY(0);box-shadow:0 2px 8px var(--shadow-color-light)}.dialogue-choice-btn .choice-text{flex:1;cursor:pointer}.choice-quick-send-btn{width:28px;height:28px;border:1px solid var(--ui-border-color);background:#fff;color:#333;border-radius:50%;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,.1);margin-left:8px}.choice-quick-send-btn:hover{background:#f8f9fa;color:var(--primary-color);border-color:var(--primary-color);transform:scale(1.1);box-shadow:0 4px 8px rgba(0,0,0,.15)}.choice-quick-send-btn:active{transform:scale(0.95);box-shadow:0 1px 2px rgba(0,0,0,.1)}.choice-quick-send-btn i{font-size:11px}.contact-avatar-container{position:relative;display:inline-block}.contact-avatar{width:40px;height:40px;border-radius:50%;margin-right:10px;object-fit:cover;object-position:top;transition:all .3s ease}.contact-avatar[src*="data:image/svg+xml"]{background-color:var(--ui-bg-secondary);border:1px solid var(--ui-border-color);opacity:.8}.unread-indicator{position:absolute;top:-5px;right:5px;background:#ff3b30;color:#fff;font-size:10px;font-weight:600;padding:2px 6px;border-radius:10px;min-width:16px;text-align:center;box-shadow:0 2px 4px rgba(255,59,48,.3);z-index:10}.unread-indicator.pulse{animation:pulse-notification .6s ease-out}@keyframes pulse-notification{0%{transform:scale(0.8);opacity:0}50%{transform:scale(1.2);opacity:1}100%{transform:scale(1);opacity:1}}.contact-item{display:flex;align-items:center;padding:10px;border-radius:10px;cursor:pointer;transition:background .3s}.contact-item:hover,.contact-item.active{background:var(--primary-color-light)}.contact-item .contact-avatar-container{margin-right:0}#view-commands .modal-header h2{display:flex;align-items:center;gap:8px}#view-commands .modal-header h2 #commands-count{color:var(--primary-color);font-weight:700}#view-commands .commands-content{display:flex;flex-direction:column;height:100%;gap:20px}#view-commands .commands-controls{display:flex;gap:12px;padding:16px;border-bottom:1px solid var(--ui-border-color);background:var(--ui-bg-secondary);border-radius:8px}#view-commands .commands-controls .primary-btn,#view-commands .commands-controls .secondary-btn{padding:10px 20px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:8px}#view-commands .commands-controls .primary-btn i,#view-commands .commands-controls .secondary-btn i{font-size:14px}#view-commands .commands-controls .primary-btn:disabled,#view-commands .commands-controls .secondary-btn:disabled{opacity:.5;cursor:not-allowed;transform:none !important}#view-commands .commands-controls .primary-btn{background:var(--primary-color);color:#fff}#view-commands .commands-controls .primary-btn:hover:not(:disabled){background:var(--primary-color-light);transform:translateY(-1px)}#view-commands .commands-controls .secondary-btn{background:var(--ui-bg);color:var(--text-color);border:1px solid var(--ui-border-color)}#view-commands .commands-controls .secondary-btn:hover:not(:disabled){background:var(--ui-bg-secondary);transform:translateY(-1px)}#view-commands .commands-list-container{flex-grow:1;overflow-y:auto;padding:0 4px;scrollbar-width:none;-ms-overflow-style:none}#view-commands .commands-list-container::-webkit-scrollbar{width:0;height:0}#view-commands .commands-help-icon{text-align:center;padding:8px}#view-commands .commands-help-icon i{font-size:20px;color:var(--text-color-secondary);cursor:help;transition:color .3s ease}#view-commands .commands-help-icon i:hover{color:var(--primary-color)}.command-item{padding:16px;margin-bottom:12px;background:var(--ui-bg);border:1px solid var(--ui-border-color);border-radius:8px;transition:all .3s ease}.command-item:hover{border-color:var(--primary-color-light);box-shadow:0 2px 8px rgba(var(--primary-color-rgb),0.1)}.command-item .command-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.command-item .command-header .command-type{display:flex;align-items:center;gap:8px}.command-item .command-header .command-type i{color:var(--primary-color);font-size:14px}.command-item .command-header .command-type .type-label{font-weight:600;color:var(--primary-color);font-size:12px;text-transform:uppercase;letter-spacing:.5px}.command-item .command-header .command-time{font-size:12px;color:var(--text-color-secondary);opacity:.7}.command-item .command-header .remove-command-btn{padding:4px 8px;background:rgba(0,0,0,0);border:none;color:var(--text-color-secondary);cursor:pointer;border-radius:4px;transition:all .2s ease}.command-item .command-header .remove-command-btn:hover{background:rgba(239,68,68,.1);color:#ef4444}.command-item .command-header .remove-command-btn i{font-size:12px}.command-item .command-content{background:var(--ui-bg-secondary);padding:12px;border-radius:6px;font-family:"Consolas","Monaco",monospace;font-size:13px;line-height:1.5;color:var(--text-color);border-left:3px solid var(--primary-color-light);word-break:break-all}.command-item .command-meta{margin-top:8px;display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-color-secondary);padding:6px 8px;background:var(--ui-bg-secondary);border-radius:4px}.command-item .command-meta i{color:var(--primary-color);font-size:11px}.no-commands{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center;color:var(--text-color-secondary)}.no-commands .no-commands-icon{font-size:48px;margin-bottom:16px;opacity:.6}.no-commands h4{font-size:16px;margin-bottom:8px;color:var(--text-color)}.no-commands p{font-size:14px;line-height:1.5;opacity:.8}.command-badge{position:absolute;top:-6px;right:-6px;background:#ef4444;color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;min-width:16px;text-align:center;box-shadow:0 2px 4px rgba(239,68,68,.3);z-index:10;animation:badge-appear .3s ease-out}@keyframes badge-appear{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2);opacity:1}100%{transform:scale(1);opacity:1}}.dialogue-bottom-controls{display:flex;align-items:center;margin-top:16px;gap:16px}.player-choice-input{flex:1}.player-choice-input .choice-input-controls{display:flex;gap:8px;align-items:center;background:var(--ui-bg);border:1px solid var(--ui-border-color);border-radius:6px;padding:8px 12px}.player-choice-input .choice-input-controls .choice-input-icon{color:#fff;font-size:14px;flex-shrink:0}.player-choice-input .choice-input-controls #choice-text-input{flex-grow:1;padding:6px 8px;border:none;background:rgba(0,0,0,0);color:var(--text-color);font-size:14px;outline:none}.player-choice-input .choice-input-controls #choice-text-input::placeholder{color:var(--text-color-secondary);opacity:.7}.player-choice-input .choice-input-controls .choice-add-btn{width:32px;height:32px;background:rgba(0,0,0,0);color:var(--text-color);border:none;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;flex-shrink:0}.player-choice-input .choice-input-controls .choice-add-btn:hover{color:var(--primary-color);transform:scale(1.2)}.player-choice-input .choice-input-controls .choice-add-btn:active{transform:scale(1)}.player-choice-input .choice-input-controls .choice-add-btn.clicked{color:#34d399;transform:scale(1.1)}.player-choice-input .choice-input-controls .choice-add-btn i{font-size:16px}.map-point.clicked{background:linear-gradient(135deg,#34d399,#10b981) !important;transform:translate(-50%,-50%) scale(1.2) !important;box-shadow:0 6px 20px rgba(52,211,153,.4) !important;animation:point-clicked .3s ease-out}@keyframes point-clicked{0%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.3)}100%{transform:translate(-50%,-50%) scale(1.2)}}.character-sprite.dynamic.character-shake.pos-left{animation:characterShakeLeft .6s ease-in-out !important}.character-sprite.dynamic.character-shake.pos-center{animation:characterShakeCenter .6s ease-in-out !important}.character-sprite.dynamic.character-shake.pos-right{animation:characterShakeRight .6s ease-in-out}.character-sprite.dynamic.character-shake.pos-three-left{animation:characterShakeThreeLeft .6s ease-in-out}.character-sprite.dynamic.character-shake.pos-three-center{animation:characterShakeThreeCenter .6s ease-in-out}.character-sprite.dynamic.character-shake.pos-three-right{animation:characterShakeThreeRight .6s ease-in-out}@keyframes characterShakeLeft{0%,100%{transform:translateX(-50%) translateY(-30%)}10%,30%,50%,70%,90%{transform:translateX(-50%) translateY(-30%) translateX(-5px)}20%,40%,60%,80%{transform:translateX(-50%) translateY(-30%) translateX(5px)}}@keyframes characterShakeCenter{0%,100%{transform:translateX(-50%) translateY(-30%)}10%,30%,50%,70%,90%{transform:translateX(-50%) translateY(-30%) translateX(-5px)}20%,40%,60%,80%{transform:translateX(-50%) translateY(-30%) translateX(5px)}}@keyframes characterShakeRight{0%,100%{transform:translateX(-50%) translateY(-30%)}10%,30%,50%,70%,90%{transform:translateX(-50%) translateY(-30%) translateX(-5px)}20%,40%,60%,80%{transform:translateX(-50%) translateY(-30%) translateX(5px)}}@keyframes characterShakeThreeLeft{0%,100%{transform:translateX(-50%) translateY(-30%)}10%,30%,50%,70%,90%{transform:translateX(-50%) translateY(-30%) translateX(-5px)}20%,40%,60%,80%{transform:translateX(-50%) translateY(-30%) translateX(5px)}}@keyframes characterShakeThreeCenter{0%,100%{transform:translateX(-50%) translateY(-30%)}10%,30%,50%,70%,90%{transform:translateX(-50%) translateY(-30%) translateX(-5px)}20%,40%,60%,80%{transform:translateX(-50%) translateY(-30%) translateX(5px)}}@keyframes characterShakeThreeRight{0%,100%{transform:translateX(-50%) translateY(-30%)}10%,30%,50%,70%,90%{transform:translateX(-50%) translateY(-30%) translateX(-5px)}20%,40%,60%,80%{transform:translateX(-50%) translateY(-30%) translateX(5px)}}.character-sprite.dynamic.character-jump-up.pos-left,.character-sprite.dynamic.character-jump-up.pos-center,.character-sprite.dynamic.character-jump-up.pos-right,.character-sprite.dynamic.character-jump-up.pos-three-left,.character-sprite.dynamic.character-jump-up.pos-three-center,.character-sprite.dynamic.character-jump-up.pos-three-right{animation:characterJumpUp .4s ease-out}@keyframes characterJumpUp{0%{transform:translateX(-50%) translateY(-30%)}50%{transform:translateX(-50%) translateY(-30%) translateY(-25px)}100%{transform:translateX(-50%) translateY(-30%)}}.character-sprite.dynamic.character-jump-down.pos-left,.character-sprite.dynamic.character-jump-down.pos-center,.character-sprite.dynamic.character-jump-down.pos-right,.character-sprite.dynamic.character-jump-down.pos-three-left,.character-sprite.dynamic.character-jump-down.pos-three-center,.character-sprite.dynamic.character-jump-down.pos-three-right{animation:characterJumpDown .4s ease-out}@keyframes characterJumpDown{0%{transform:translateX(-50%) translateY(-30%)}50%{transform:translateX(-50%) translateY(-30%) translateY(15px)}100%{transform:translateX(-50%) translateY(-30%)}}.character-sprite.dynamic.character-tilt.pos-left,.character-sprite.dynamic.character-tilt.pos-center,.character-sprite.dynamic.character-tilt.pos-right,.character-sprite.dynamic.character-tilt.pos-three-left,.character-sprite.dynamic.character-tilt.pos-three-center,.character-sprite.dynamic.character-tilt.pos-three-right{animation:characterTilt .8s ease-in-out}@keyframes characterTilt{0%{transform:translateX(-50%) translateY(-30%) rotate(0deg)}25%{transform:translateX(-50%) translateY(-30%) rotate(-4deg)}75%{transform:translateX(-50%) translateY(-30%) rotate(4deg)}100%{transform:translateX(-50%) translateY(-30%) rotate(0deg)}}.character-sprite.dynamic.character-shake,.character-sprite.dynamic.character-jump-up,.character-sprite.dynamic.character-jump-down,.character-sprite.dynamic.character-tilt{pointer-events:none;z-index:inherit}.character-sprite.dynamic.breathing-natural.pos-left,.character-sprite.dynamic.breathing-natural.pos-center,.character-sprite.dynamic.breathing-natural.pos-right,.character-sprite.dynamic.breathing-natural.pos-three-left,.character-sprite.dynamic.breathing-natural.pos-three-center,.character-sprite.dynamic.breathing-natural.pos-three-right{animation:naturalBreathing 4.2s cubic-bezier(0.4,0,0.6,1) infinite}.character-sprite.dynamic.breathing-sway.pos-left,.character-sprite.dynamic.breathing-sway.pos-center,.character-sprite.dynamic.breathing-sway.pos-right,.character-sprite.dynamic.breathing-sway.pos-three-left,.character-sprite.dynamic.breathing-sway.pos-three-center,.character-sprite.dynamic.breathing-sway.pos-three-right{animation:gentleSway 6.8s cubic-bezier(0.25,0.46,0.45,0.94) infinite}.character-sprite.dynamic.breathing-pulse.pos-left,.character-sprite.dynamic.breathing-pulse.pos-center,.character-sprite.dynamic.breathing-pulse.pos-right,.character-sprite.dynamic.breathing-pulse.pos-three-left,.character-sprite.dynamic.breathing-pulse.pos-three-center,.character-sprite.dynamic.breathing-pulse.pos-three-right{animation:vitalPulse 3.8s ease-in-out infinite}.character-sprite.dynamic.breathing-natural.pos-left,.character-sprite.dynamic.breathing-natural.pos-center,.character-sprite.dynamic.breathing-natural.pos-right,.character-sprite.dynamic.breathing-natural.pos-three-left,.character-sprite.dynamic.breathing-natural.pos-three-center,.character-sprite.dynamic.breathing-natural.pos-three-right{animation:naturalBreathingRealistic 4s ease-out infinite}.character-sprite.dynamic.breathing-rhythmic.pos-left,.character-sprite.dynamic.breathing-rhythmic.pos-center,.character-sprite.dynamic.breathing-rhythmic.pos-right,.character-sprite.dynamic.breathing-rhythmic.pos-three-left,.character-sprite.dynamic.breathing-rhythmic.pos-three-center,.character-sprite.dynamic.breathing-rhythmic.pos-three-right{animation:rhythmicBreathing 2.4s linear infinite}@keyframes naturalBreathing{0%{transform:translateX(-50%) translateY(-30%) scale(1)}25%{transform:translateX(-50%) translateY(calc(-30% - 1px)) scale(1.002)}35%{transform:translateX(-50%) translateY(calc(-30% - 1.2px)) scale(1.003)}75%{transform:translateX(-50%) translateY(calc(-30% + 0.8px)) scale(0.999)}100%{transform:translateX(-50%) translateY(-30%) scale(1)}}@keyframes gentleSway{0%{transform:translateX(-50%) translateY(-30%)}25%{transform:translateX(calc(-50% + 0.8px)) translateY(calc(-30% - 0.3px))}50%{transform:translateX(calc(-50% + 0.2px)) translateY(calc(-30% + 0.5px))}75%{transform:translateX(calc(-50% - 0.6px)) translateY(calc(-30% - 0.2px))}100%{transform:translateX(-50%) translateY(-30%)}}@keyframes vitalPulse{0%,100%{transform:translateX(-50%) translateY(-30%) scale(1)}20%{transform:translateX(-50%) translateY(-30%) scale(1.001)}50%{transform:translateX(-50%) translateY(-30%) scale(1.004)}80%{transform:translateX(-50%) translateY(-30%) scale(1.001)}}@keyframes naturalBreathingRealistic{0%{transform:translateX(-50%) translateY(-30%) scale(1)}15%{transform:translateX(-50%) translateY(calc(-30% - 0.3px)) scale(1.0008)}33%{transform:translateX(-50%) translateY(calc(-30% - 0.6px)) scale(1.0015)}40%{transform:translateX(-50%) translateY(calc(-30% - 0.6px)) scale(1.0015)}70%{transform:translateX(-50%) translateY(calc(-30% - 0.2px)) scale(1.0005)}100%{transform:translateX(-50%) translateY(-30%) scale(1)}}@keyframes rhythmicBreathing{0%,100%{transform:translateX(-50%) translateY(-30%) scale(1)}50%{transform:translateX(-50%) translateY(calc(-30% + 1px)) scale(1.002)}}.character-sprite.dynamic[class*=breathing-]{pointer-events:auto;z-index:inherit;will-change:transform;backface-visibility:hidden;transform-style:preserve-3d}@media (prefers-reduced-motion:reduce){.character-sprite.dynamic[class*=breathing-]{animation-duration:8s !important;animation-timing-function:linear !important}@keyframes naturalBreathingRealistic{0%,100%{transform:translateX(-50%) translateY(-30%) scale(1)}33%{transform:translateX(-50%) translateY(calc(-30% - 0.15px)) scale(1.0003)}40%{transform:translateX(-50%) translateY(calc(-30% - 0.15px)) scale(1.0003)}}}.modern-select{width:100%;padding:8px 12px;border:2px solid var(--border-color,#333);border-radius:8px;background:var(--input-bg,#2a2a2a);color:var(--text-color,#f5f5f7);font-size:14px;font-family:inherit;cursor:pointer;transition:all .3s ease;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f7' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 8px center;background-size:16px;padding-right:36px}.modern-select:hover{border-color:var(--accent-color,#007aff);background-color:var(--input-hover-bg,#333)}.modern-select:focus{outline:none;border-color:var(--accent-color,#007aff);box-shadow:0 0 0 2px rgba(0,122,255,.2)}.modern-select option{background:var(--input-bg,#2a2a2a);color:var(--text-color,#f5f5f7);padding:8px}.slider-container{width:100%}.slider-container .modern-slider{width:100%;height:6px;border-radius:3px;background:var(--slider-track-bg,#333);outline:none;-webkit-appearance:none;appearance:none;cursor:pointer;transition:all .3s ease}.slider-container .modern-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent-color,#007aff);cursor:pointer;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.2);-webkit-transition:all .3s ease;transition:all .3s ease}.slider-container .modern-slider::-webkit-slider-thumb:hover{transform:scale(1.1);box-shadow:0 4px 12px rgba(0,122,255,.3)}.slider-container .modern-slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent-color,#007aff);cursor:pointer;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.2);-moz-transition:all .3s ease;transition:all .3s ease}.slider-container .modern-slider::-moz-range-thumb:hover{transform:scale(1.1);box-shadow:0 4px 12px rgba(0,122,255,.3)}.slider-container .modern-slider::-webkit-slider-track{height:6px;border-radius:3px;background:var(--slider-track-bg,#333)}.slider-container .modern-slider::-moz-range-track{height:6px;border-radius:3px;background:var(--slider-track-bg,#333);border:none}.slider-container .slider-labels{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:12px;color:var(--text-secondary,#888)}.slider-container .slider-labels span:nth-child(2){font-weight:600;color:var(--accent-color,#007aff);background:var(--accent-bg,rgba(0,122,255,0.1));padding:2px 8px;border-radius:4px;font-size:11px}[data-theme=light] .modern-select{--input-bg:#f8f9fa;--input-hover-bg:#e9ecef;--border-color:#dee2e6;--text-color:#212529;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23212529' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e")}[data-theme=light] .modern-select option{background:#f8f9fa;color:#212529}[data-theme=light] .modern-slider{--slider-track-bg:#dee2e6}[data-theme=glass] .modern-select{--input-bg:rgba(255,255,255,0.1);--input-hover-bg:rgba(255,255,255,0.15);--border-color:rgba(255,255,255,0.2);backdrop-filter:blur(10px)}[data-theme=glass] .modern-select option{background:rgba(0,0,0,.8);backdrop-filter:blur(10px)}[data-theme=glass] .modern-slider{--slider-track-bg:rgba(255,255,255,0.2)}.reset-setting-item{display:flex;justify-content:center;align-items:center;padding:8px 0}.reset-setting-item .setting-control{width:100%;display:flex;justify-content:center}.reset-btn{background:linear-gradient(135deg,var(--accent-color),var(--accent-color-dark));color:#fff;border:none;border-radius:8px;padding:10px 20px;font-size:14px;font-weight:500;cursor:pointer;transition:all .3s ease;box-shadow:0 2px 8px rgba(0,0,0,.1);min-width:100px}.reset-btn:hover{background:linear-gradient(135deg,var(--accent-color-dark),var(--accent-color));transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}.reset-btn:active{transform:translateY(0);box-shadow:0 2px 6px rgba(0,0,0,.1)}.reset-btn:focus{outline:none;box-shadow:0 0 0 3px rgba(var(--accent-color-rgb),0.3)}#stat-toast-container{position:fixed;top:12px;left:12px;display:flex;flex-direction:column;gap:8px;z-index:9999;pointer-events:none}.stat-toast{display:flex;align-items:center;gap:8px;background:var(--ui-bg-heavy,rgba(28,28,30,0.9));color:var(--text-color,#fff);border:1px solid var(--ui-border-color,rgba(255,255,255,0.12));border-radius:10px;padding:6px 10px;box-shadow:0 6px 20px rgba(0,0,0,.25);font-size:13px;line-height:1.2;opacity:1;transform:translateY(0);transition:opacity .35s ease,transform .35s ease}.stat-toast i{font-size:14px;opacity:.9}.stat-toast .label{opacity:.85}.stat-toast .delta{font-weight:700}.stat-toast.gain .delta{color:#34c759}.stat-toast.loss .delta{color:#ff3b30}.stat-toast.fade-out{opacity:0;transform:translateY(-6px)}
</style></head><body data-theme="dark"><div id="app-container"><main id="content-area"><div id="view-novel" class="view-container active"><div id="background-overlay" class="background-overlay"></div><div class="character-layer"><div class="character-container"><div class="character-hover-trigger"></div><img id="character-sprite" class="character-sprite old-sprite" style="display:none!important"/><div class="character-status-tooltip"><div class="status-tooltip-header"><h3 class="character-fullname" id="character-fullname"></h3><p class="character-affiliation" id="character-affiliation"></p></div><div class="status-tooltip-divider"></div><div class="status-tooltip-body" id="status-tooltip-body"></div><div class="status-tooltip-divider"></div><div class="status-tooltip-footer" id="status-tooltip-footer"></div></div></div></div><div class="cg-layer" id="cg-layer"><img id="cg-image" class="cg-image" alt="CG"/></div><div class="ui-layer"><div class="top-header-container"><div class="top-bar"><div class="game-info"><span class="game-date"><i class="fas fa-calendar-alt"></i> <span id="current-date"></span> </span><span class="game-time-period"><i class="fas fa-clock"></i> <span id="current-time-period"></span> </span><span class="game-location"><i class="fas fa-map-marker-alt"></i> <span id="current-location"></span></span></div><div class="money-display"><span class="money-item" title="通用货币：里拉"><i class="fas fa-coins"></i> <span id="player-money"></span></span></div></div><nav id="main-nav"><button class="nav-btn" data-view="status"><div class="nav-icon"><i class="fas fa-user-circle"></i></div><span class="nav-text">状态</span></button> <button class="nav-btn" data-view="hummingbird"><div class="nav-icon"><i class="fas fa-comments"></i></div><span class="nav-text">蜂鸟</span></button> <button class="nav-btn" data-view="map"><div class="nav-icon"><i class="fas fa-map"></i></div><span class="nav-text">地图</span></button> <button class="nav-btn" data-view="memoir"><div class="nav-icon"><i class="fas fa-journal-whills"></i></div><span class="nav-text">回忆录</span></button> <button class="nav-btn" data-view="quests"><div class="nav-icon"><i class="fas fa-tasks"></i></div><span class="nav-text">任务</span></button> <button class="nav-btn" data-view="newspaper"><div class="nav-icon"><i class="fas fa-newspaper"></i></div><span class="nav-text">报纸</span></button> <button class="nav-btn" data-view="commands"><div class="nav-icon"><i class="fas fa-list-alt"></i></div><span class="nav-text">行动</span></button> <button class="nav-btn" id="settings-btn"><div class="nav-icon"><i class="fas fa-cog"></i></div><span class="nav-text">设置</span></button></nav></div><div class="dialogue-box"><div class="character-name" id="speaker-name"></div><p class="dialogue-text" id="dialogue-content"></p><div class="dialogue-bottom-controls"><div class="player-choice-input" id="player-choice-input" style="display:none"><div class="choice-input-controls"><i class="fas fa-comment-dots choice-input-icon"></i> <input id="choice-text-input" placeholder="输入你想要说的话或采取的行动..."/> <button id="add-choice-btn" class="choice-add-btn"><i class="fas fa-plus"></i></button></div></div><div class="dialogue-controls"><button class="control-btn" id="prev-btn"><i class="fas fa-chevron-left"></i></button> <button class="control-btn" id="next-btn"><i class="fas fa-chevron-right"></i></button></div></div></div></div></div></main><div id="modal-container" class="modal-view-container"><div class="modal-content"><button id="modal-close-btn" class="modal-close-btn"><i class="fas fa-times"></i></button><div id="view-status" class="view-container"><div class="modal-header"><div class="panel-tabs rpg-tabs"><button class="tab-btn active" data-tab="overview"><i class="fas fa-user-circle"></i> <span>概览</span></button> <button class="tab-btn" data-tab="inventory"><i class="fas fa-bag-shopping"></i> <span>背包</span></button></div></div><div class="modal-body"><div id="tab-overview" class="tab-content active"><div class="character-overview-new"><div class="top-info-row"><div class="character-card-expanded"><div class="character-avatar user-avatar" id="user-avatar"></div><div class="character-info-expanded"><h3 class="character-name" id="player-name">用户</h3><div class="character-stats-expanded"><div class="stat-compact"><span class="stat-label-compact">位阶</span> <span class="stat-value-compact" id="status-rank">--</span></div><div class="stat-compact"><span class="stat-label-compact">物品</span> <span class="stat-value-compact" id="inventory-count">--</span></div></div></div></div><div class="wealth-section-narrow"><h4>财富</h4><div class="wealth-items-narrow"><div class="wealth-item-narrow"><i class="fas fa-coins"></i><div><span class="wealth-label-narrow">里拉(R)</span> <span class="wealth-value-narrow" id="player-lira">--</span></div></div><div class="wealth-item-narrow"><i class="fas fa-gem"></i><div><span class="wealth-label-narrow">白金币</span> <span class="wealth-value-narrow" id="player-platinum">--</span></div></div></div></div></div><div class="rpg-content-grid"><div class="rpg-section abilities-section"><div class="rpg-card"><div class="card-header"><i class="fas fa-magic"></i><h4>技能</h4></div><ul class="ability-list-compact" id="status-skills"></ul></div><div class="rpg-card"><div class="card-header"><i class="fas fa-star"></i><h4>祝福</h4></div><ul class="ability-list-compact" id="status-blessings"></ul></div></div><div class="rpg-section equipment-titles-section"><div class="rpg-card"><div class="card-header"><i class="fas fa-shield-alt"></i><h4>当前装备</h4></div><div class="equipment-preview-detailed" id="equipment-preview"></div></div><div class="rpg-card"><div class="card-header"><i class="fas fa-crown"></i><h4>称号</h4></div><ul class="ability-list-compact" id="status-titles"></ul></div></div></div></div></div><div id="tab-inventory" class="tab-content"><div class="rpg-inventory-container"><div class="inventory-header"><div class="inventory-stats"><span class="inventory-count">物品数量: <span id="inventory-total">0</span></span></div><div class="inventory-sorting"><label for="inventory-sort-select">排序:</label> <select id="inventory-sort-select" class="sort-select"><option value="default">默认</option><option value="name">名称</option><option value="type">类型</option><option value="quantity">数量</option></select> <button id="inventory-sort-order" class="sort-order-btn" data-order="asc" title="排序方向"><i class="fas fa-sort-amount-down"></i></button></div></div><div class="inventory-content"><div class="inventory-grid-container"><div class="inventory-grid" id="inventory-grid"></div></div><div class="item-details-panel" id="item-details-panel"><div class="no-item-selected"><i class="fas fa-mouse-pointer"></i><p>点击物品查看详情</p></div></div></div></div></div></div></div><div id="view-hummingbird" class="view-container"><div class="modal-header"><h2>蜂鸟</h2></div><div class="modal-body"><div id="contact-list"></div><div id="chat-window"><div id="chat-messages"></div><div id="chat-input"><input id="message-input" placeholder="输入消息..."/> <button class="send-btn"><i class="fas fa-paper-plane"></i></button></div></div><div id="hummingbird-character-tooltip" class="character-status-tooltip hummingbird-tooltip"><div class="status-tooltip-header"><h3 class="character-fullname" id="hb-character-fullname"></h3><p class="character-affiliation" id="hb-character-affiliation"></p></div><div class="status-tooltip-divider"></div><div class="status-tooltip-body" id="hb-status-tooltip-body"></div><div class="status-tooltip-divider"></div><div class="status-tooltip-footer" id="hb-status-tooltip-footer"></div></div></div></div><div id="view-map" class="view-container"><div class="modal-body"><div class="map-controls"><div class="segmented-control" id="map-selector"><button class="sg-btn active" data-map="demonRealm">魔界</button> <button class="sg-btn" data-map="humanRealm">人界</button></div></div><div class="map-canvas"><img alt="世界地图" class="map-image" id="map-image"/></div><div id="map-tooltip"></div></div></div><div id="view-memoir" class="view-container"><div class="modal-header"><h2>回忆录</h2></div><div class="modal-body"><div id="event-list"></div><div id="event-details"></div></div></div><div id="view-quests" class="view-container"><div class="modal-header"><h2>任务与成就</h2><div class="quest-tabs"><button class="tab-btn active" data-tab="main">主线任务</button> <button class="tab-btn" data-tab="side">支线任务</button> <button class="tab-btn" data-tab="achievements">解锁成就</button></div></div><div class="modal-body"><div class="quest-content"><div id="quest-list"></div><div id="quest-details"></div></div></div></div><div id="view-newspaper" class="view-container"><div class="modal-body"><div class="newspaper-container"><div class="newspaper-background"><img alt="阴影层" class="newspaper-shadow-image" id="newspaper-shadow-image"/> <img alt="报纸背景" class="newspaper-bg-image" id="newspaper-bg-image"/><div class="newspaper-content"><div class="newspaper-header"><h2 class="newspaper-name" id="newspaper-name">三界日报</h2></div><div class="newspaper-headline"><h1 class="main-headline" id="main-headline"></h1></div><div class="newspaper-main-news"><div class="news-column left-column" id="left-column"></div><div class="news-column right-column" id="right-column"></div></div><div class="newspaper-ads" id="newspaper-ads"></div></div></div></div></div></div><div id="view-commands" class="view-container"><div class="modal-header"><h2>行动计划 (<span id="commands-count">0</span>)</h2></div><div class="modal-body"><div class="commands-content"><div class="commands-controls"><button id="send-all-commands" class="primary-btn" disabled="disabled"><i class="fas fa-play"></i> 执行所有行动</button> <button id="clear-all-commands" class="secondary-btn" disabled="disabled"><i class="fas fa-trash"></i> 清空计划</button></div><div class="commands-list-container"><div id="pending-commands-list"></div></div><div class="commands-help-icon"><i class="fas fa-question-circle" title="如何制定行动？&#10;• 在地图上点击地点&#10;• 在选择界面输入文字&#10;• 通过蜂鸟发送消息"></i></div></div></div></div></div></div><div id="settings-menu" class="settings-popover"><div class="settings-section"><label>主题切换</label><div class="theme-buttons-container"><button data-theme="light" class="theme-btn" title="浅色主题"><i class="fas fa-sun"></i></button> <button data-theme="dark" class="theme-btn active" title="深色主题"><i class="fas fa-moon"></i></button> <button data-theme="glass" class="theme-btn" title="毛玻璃"><i class="fas fa-layer-group"></i></button></div></div><div class="settings-section visual-effects-section"><div class="section-header"><i class="fas fa-magic"></i> <label class="section-title">视觉效果</label></div><div class="settings-options"><div class="setting-item"><div class="setting-info"><div class="setting-name"><i class="fas fa-lungs"></i> 角色呼吸效果</div><div class="setting-description">为角色立绘添加微妙的呼吸动画效果</div></div><div class="setting-control"><label class="modern-toggle"><input type="checkbox" id="breathing-toggle" checked="checked"><div class="toggle-track"><div class="toggle-thumb"><i class="toggle-icon fas fa-check"></i></div></div></label></div></div><div class="setting-item disabled"><div class="setting-info"><div class="setting-name"><i class="fas fa-eye"></i> 视差滚动 <span class="coming-soon">即将推出</span></div><div class="setting-description">背景图层的深度滚动效果</div></div><div class="setting-control"><label class="modern-toggle disabled"><input type="checkbox" disabled="disabled"><div class="toggle-track"><div class="toggle-thumb"><i class="toggle-icon fas fa-times"></i></div></div></label></div></div></div></div><div class="settings-section text-settings-section"><div class="section-header"><i class="fas fa-font"></i> <label class="section-title">文字设置</label></div><div class="settings-options"><div class="setting-item"><div class="setting-info"><div class="setting-name"><i class="fas fa-keyboard"></i> 文字显示效果</div><div class="setting-description">选择文字出现的动画效果</div></div><div class="setting-control"><select id="text-animation-type" class="modern-select"><option value="typewriter">打字机效果</option><option value="fade">渐显效果</option><option value="instant">即时显示</option></select></div></div><div class="setting-item"><div class="setting-info"><div class="setting-name"><i class="fas fa-tachometer-alt"></i> 文字速度</div><div class="setting-description">调整文字出现的速度</div></div><div class="setting-control"><div class="slider-container"><input type="range" id="text-speed-slider" class="modern-slider" min="10" max="200" value="180" step="10"><div class="slider-labels"><span>慢</span> <span id="text-speed-value">30ms</span> <span>快</span></div></div></div></div><div class="setting-item"><div class="setting-info"><div class="setting-name"><i class="fas fa-text-height"></i> 字体大小</div><div class="setting-description">调整对话文字的大小</div></div><div class="setting-control"><div class="slider-container"><input type="range" id="font-size-slider" class="modern-slider" min="12" max="32" value="16" step="2"><div class="slider-labels"><span>小</span> <span id="font-size-value">16px</span> <span>大</span></div></div></div></div></div></div><div class="settings-section default-settings-section"><div class="settings-options"><div class="setting-item reset-setting-item"><div class="setting-control"><button id="reset-settings-btn" class="reset-btn">恢复默认</button></div></div></div></div></div></div></body>